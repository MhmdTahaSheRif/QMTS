;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_export_to_pdf";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi_cet_model_editor":dependencies[0],"prezi_i18n":dependencies[1],"prezi_logger":dependencies[2],"prezi_plugin_api":dependencies[3],"prezi_plugin_meta":dependencies[4],"prezi_thumbnail_render":dependencies[5],"prezi_utils":dependencies[6]}};})());};})(arguments);var moduleImpl=(function(){return module(function(g){var c=g.dependencies.prezi_plugin_api,v=g.dependencies.prezi_plugin_meta,h=g.dependencies.prezi_i18n,k=g.dependencies.prezi_utils,l=g.dependencies.prezi_logger,t=g.dependencies.prezi_thumbnail_render,m={},u=this&&m.__awaiter||function(a,b,e,f){function w(a){return a instanceof e?a:new e(function(b){b(a)})}return new (e||(e=Promise))(function(e,d){function c(a){try{n(f.next(a))}catch(p){d(p)}}function g(a){try{n(f["throw"](a))}catch(p){d(p)}}function n(a){a.done?e(a.value):w(a.value).then(c,
g)}n((f=f.apply(a,b||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});m.PreziToPdf=class{constructor(){}exportToPdf(a,b,e,f){return new x(this.getThumbnailServicePromise(),this.getPdfKitPromise(),this.getBlobStreamPromise(),f,a,b,e)}getPdfKitPromise(){null==this.pdfKitPromise&&(this.pdfKitPromise=new Promise((a)=>require([g.getResourceUrl("pdfkit.standalone-0.12.1.js")],(b)=>{a(b)})));return this.pdfKitPromise}getBlobStreamPromise(){null==this.blobStreamPromise&&(this.blobStreamPromise=
new Promise((a)=>require([g.getResourceUrl("blob-stream-v0.1.3.js")],(b)=>{a(b)})));return this.blobStreamPromise}getThumbnailServicePromise(){null==this.thumbnailServicePromise&&(this.thumbnailServicePromise=t.ThumbnailRenderModule.getThumbnailService());return this.thumbnailServicePromise}};class x{constructor(a,b,e,f,d,c,g){this.path=d;this.title=c;this.aspectRatio=g;this.progressHandlers=[];this.finishHandlers=[];this.cancelled=!1;Promise.all([a,b,e,f]).then(([a,b,e])=>this.exportToPdfI(a,b,e))}onProgress(a){this.progressHandlers.push(a)}onFinish(a){this.finishHandlers.push(a)}cancel(){this.cancelled=
!0;this.progressHandlers=[];this.finishHandlers=[]}exportToPdfI(a,b,e){return u(this,void 0,void 0,function*(){const {width:f,height:d}=.001>Math.abs(this.aspectRatio.width/this.aspectRatio.height-4/3)?{width:720,height:540}:{width:960,height:540},c=new b({size:[d,f],margins:{top:0,bottom:0,left:0,right:0},layout:"landscape",info:{Title:this.title,Keywords:"pdf;prezi"}}),g=c.pipe(e());g.on("finish",()=>{const a=g.toBlob("application/pdf");this.finishHandlers.forEach((b)=>b({blob:a}))});yield this.fillCurrentPdfPage(0,
c,a,f,d);for(let b=1;b<this.path.length;++b)if(c.addPage(),yield this.fillCurrentPdfPage(b,c,a,f,d),this.cancelled)return;c.end()})}fillCurrentPdfPage(a,b,e,d,c){return u(this,void 0,void 0,function*(){const f=(yield e.renderPathElement(this.path[a],{size:t.ThumbnailSize._1920,needHighQuality:!0}).getThumbnail()).canvas.toDataURL("image/png");b.image(f,0,0,{fit:[d,c]}).save();this.progressHandlers.forEach((b)=>b({pagesProcessed:a+1,pagesTotal:this.path.length}));return new Promise((a)=>setTimeout(a,
0))})}}var q={};Object.defineProperty(q,"__esModule",{value:!0});var d;(function(a){a.notStarted="notStarted";a.inProgress="inProgress";a.finished="finished";a.failed="failed"})(d||(d={}));q.ExportToPdfPlugin=class{init(a){this.preziToPdf=new m.PreziToPdf;this.uiRoot=a.declareUI({pitchPdfExport:!1,pdfExportState:{kind:d.notStarted},preziTitle:this.session.document.preziMetaData.title,downloadingAssets:!0},(a,b)=>{this.createPdfExportDialog(b)});a.onLicenseChange((a)=>{this.uiRoot.setState({pitchPdfExport:a.featureSet.pitchPdfExport})});
a.onDocumentChange(()=>{const {pdfExportState:a,downloadingAssets:b}=this.uiRoot.getState(),c=this.session.document.assetsReady;this.setAssetReadyPromise(c);switch(a.kind){case d.inProgress:this.handleDocumentChangeInPdfExportProgress(c,b,a.job);break;case d.finished:URL.revokeObjectURL(a.downloadPdfUrl);this.uiRoot.setState({pdfExportState:{kind:d.notStarted}});break;case d.notStarted:case d.failed:break;default:k.Utils.assertNever(a)}});a.onDocumentEvent((a)=>{a.kind===c.DocumentEventKind.Metadata&&
this.uiRoot.setState({preziTitle:a.title})});let b=null;a.registerExporter({format:c.ExportFormat.pdf,start:(a)=>{b=this.startPdfExportJob();b.onProgress((b)=>a.progressCallback(b.pagesProcessed,b.pagesTotal));b.onFinish((b)=>{this.blobToBase64(b.blob).then((b)=>{a.finishedCallback({resultStatus:c.ExportResultStatus.success,data:b})})})},cancel:()=>null===b||void 0===b?void 0:b.cancel()})}processMessage(a){switch(a){case v.ExportToPdfMessage.openDialog:this.uiRoot.getState().pitchPdfExport?(l.avro.Avro.createDefaultLogger().logOpenExportPdfDialog(),
this.uiRoot.dialog.show("export-presentation-dialog")):this.uiRoot.dialog.showBuiltIn(c.BuiltinDialog.upgradeLicensePitchPdfExport);break;default:k.Utils.assertNever(a)}}setAssetReadyPromise(a){null==this.assetLoadedDeferredPromise&&(this.assetLoadedDeferredPromise=k.Utils.deferredPromise());a?this.assetLoadedDeferredPromise.resolve():this.assetLoadedDeferredPromise.isPending()||(this.assetLoadedDeferredPromise=k.Utils.deferredPromise())}handleDocumentChangeInPdfExportProgress(a,b,c){a&&(b?this.uiRoot.setState({downloadingAssets:!1}):
(null===c||void 0===c?void 0:c.cancel(),this.uiRoot.setState({pdfExportState:{kind:d.failed,errorMessage:h.I18n.ts("Export stopped because the document was edited by someone else. Click the export button again to continue.")}})))}blobToBase64(a){return new Promise((b)=>{const c=new FileReader;c.onloadend=()=>b(c.result.slice(28));c.readAsDataURL(a)})}createPdfExportDialog(a){a.dialog.medium((a)=>({id:"export-presentation-dialog",title:h.I18n.ts("Export to PDF"),content:this.createExportPdfModalContent(a),
onCloseButtonClicked:()=>{l.avro.Avro.createDefaultLogger().logCloseExportPdfDialog();this.closeExportPdfModal()}}))}createExportPdfModalContent(a){return[a.dialogItemRow((a)=>({layout:c.DialogItemRowLayout.medium_1_small_1,hasBottomBorder:!0,items:[a.illustration("",c.IllustrationLargeLightId.ExportPdfFrom),this.createProgressIndicator(a),a.illustration("",c.IllustrationLargeLightId.ExportPdfTo)]})),...this.createPdfExportButtonSection(a)]}createPdfExportButtonSection(a){const {pdfExportState:b,
downloadingAssets:e}=this.uiRoot.getState();let f;switch(b.kind){case d.notStarted:case d.failed:return[...b.kind===d.failed?[a.errorMessage(b.errorMessage)]:[],a.label(""),a.button(c.ButtonSize.Large,c.ButtonAlign.End,(a)=>[this.createPdfButtonStartExporting(a)])];case d.inProgress:return f=e?this.createPdfButtonDownloadingAsset:(a)=>this.createPdfButtonInProgress(a,b.progressPercentage),[a.label(""),a.button(c.ButtonSize.Large,c.ButtonAlign.End,(a)=>[f(a)])];case d.finished:return[a.label(""),a.button(c.ButtonSize.Large,
c.ButtonAlign.End,(a)=>[this.createPdfButtonSavePdf(a,b.downloadPdfUrl)])];default:k.Utils.assertNever(b)}}createProgressIndicator(a){const {pdfExportState:b}=this.uiRoot.getState();switch(b.kind){case d.inProgress:return a.spinner(c.SpinnerColor.blue,c.SpinnerSize.s);case d.finished:case d.notStarted:case d.failed:return a.image({id:"progress-indicator-img",src:g.getResourceUrl(`${b.kind===d.finished?"checked":"arrow"}.svg`),noMargin:!0});default:k.Utils.assertNever(b)}}createPdfButtonStartExporting(a){return a.button({color:c.ButtonColor.Blue,
content:{text:h.I18n.ts("Export")},id:"start-export-pdf",onClick:(a)=>this.startExportPDF(a)})}createPdfButtonInProgress(a,b){b=b?" "+b+"%":"";return a.button({color:c.ButtonColor.Blue,disabled:!0,content:{text:h.I18n.ts("Exporting...")+b},id:"exporting-pdf",onClick:()=>{}})}createPdfButtonDownloadingAsset(a){return a.button({color:c.ButtonColor.Blue,disabled:!0,content:{text:h.I18n.ts("Downloading assets...")},id:"downloading-assets-pdf",onClick:()=>{}})}createPdfButtonSavePdf(a,b){return a.button({color:c.ButtonColor.Blue,
content:{text:h.I18n.ts("Save PDF")},id:"save-pdf",onClick:()=>this.downloadExportedPdf(b)})}startExportPDF(){l.avro.Avro.createDefaultLogger().logExportPdf();const a=this.startPdfExportJob();this.uiRoot.setState({pdfExportState:{kind:d.inProgress,progressPercentage:0,job:a},downloadingAssets:!this.session.document.assetsReady});a.onProgress((b)=>{this.uiRoot.setState({pdfExportState:{kind:d.inProgress,progressPercentage:Math.round(b.pagesProcessed/b.pagesTotal*100),job:a}})});a.onFinish((a)=>{this.uiRoot.setState({pdfExportState:{kind:d.finished,
downloadPdfUrl:URL.createObjectURL(a.blob)}})})}startPdfExportJob(){const a=this.session.document.preziMetaData.title,{path:b,aspectRatio:c}=this.session.document.read((a)=>({path:a.structuredPath.viewPathElementsInOrder.map((a)=>a.ref),aspectRatio:a.aspectRatio}));return this.preziToPdf.exportToPdf(b,a,c,this.assetLoadedDeferredPromise.promise)}downloadExportedPdf(a){l.avro.Avro.createDefaultLogger().logOpenExportedPdf();const b=document.createElement("a");b.href=a;b.target="_blank";document.body.appendChild(b);
b.click();document.body.removeChild(b);this.closeExportPdfModal()}closeExportPdfModal(){this.uiRoot.dialog.hide("export-presentation-dialog")}};var r={};Object.defineProperty(r,"__esModule",{value:!0});r.lazyModule={createPlugin(){return new q.ExportToPdfPlugin}};return r});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_export_to_pdf",["require","prezi_cet_model_editor","prezi_i18n","prezi_logger","prezi_plugin_api","prezi_plugin_meta","prezi_thumbnail_render","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_export_to_pdf.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi_cet_model_editor"),require("prezi_i18n"),require("prezi_logger"),require("prezi_plugin_api"),require("prezi_plugin_meta"),require("prezi_thumbnail_render"),require("prezi_utils"));}else{this["prezi_export_to_pdf"]=__factory(this["prezi_cet_model_editor"],this["prezi_i18n"],this["prezi_logger"],this["prezi_plugin_api"],this["prezi_plugin_meta"],this["prezi_thumbnail_render"],this["prezi_utils"]);}}).call(this);