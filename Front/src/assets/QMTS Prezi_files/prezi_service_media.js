;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_service_media";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.geometry":dependencies[0],"prezi_bacon":dependencies[1],"prezi_editor_error":dependencies[2],"prezi_externalserviceprovider":dependencies[3],"prezi_featureswitcher":dependencies[4],"prezi_logger":dependencies[5],"prezi_nativeapitypes":dependencies[6],"prezi_pdf_render":dependencies[7],"prezi_utils":dependencies[8]}};})());};})(arguments);/*
 @preserve
Copyright (c) 2012. Telecom ParisTech/TSI/MM/GPAC Cyril Concolato
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
 Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
 Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
 Neither the name of the copyright holder nor the
      names of its contributors may be used to endorse or promote products
      derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 mp4box 06-09-2016 */
var moduleImpl=(function(){return module(function(y){function S(){var f=function(){var a=new Date,b=4;return{setLogLevel:function(a){b=a==this.debug?1:a==this.info?2:a==this.warn?3:4},debug:function(d,g){1>=b&&console.debug("["+f.getDurationString(new Date-a,1E3)+"]","["+d+"]",g)},info:function(d,g){2>=b&&console.info("["+f.getDurationString(new Date-a,1E3)+"]","["+d+"]",g)},warn:function(d,g){3>=b&&console.warn("["+f.getDurationString(new Date-a,1E3)+"]","["+d+"]",g)},error:function(d,g){4>=b&&console.error("["+f.getDurationString(new Date-
a,1E3)+"]","["+d+"]",g)}}}();f.getDurationString=function(a,b){function d(a,b){for(a=(""+a).split(".");a[0].length<b;)a[0]="0"+a[0];return a.join(".")}var g;0>a?(g=!0,a=-a):g=!1;a/=b||1;b=Math.floor(a/3600);a-=3600*b;var c=Math.floor(a/60);a-=60*c;var f=1E3*a;return a=Math.floor(a),f-=1E3*a,f=Math.floor(f),(g?"-":"")+b+":"+d(c,2)+":"+d(a,2)+"."+d(f,3)};f.printRanges=function(a){var b=a.length;if(0<b){for(var d="",g=0;g<b;g++)0<g&&(d+=","),d+="["+f.getDurationString(a.start(g))+","+f.getDurationString(a.end(g))+
"]";return d}return"(empty)"};var e=function(a,b,d){this._byteOffset=b||0;a instanceof ArrayBuffer?this.buffer=a:"object"==typeof a?(this.dataView=a,b&&(this._byteOffset+=b)):this.buffer=new ArrayBuffer(a||0);this.position=0;this.endianness=null==d?e.LITTLE_ENDIAN:d};e.prototype={};e.prototype.getPosition=function(){return this.position};e.prototype._realloc=function(a){if(this._dynamicSize){a=this._byteOffset+this.position+a;var b=this._buffer.byteLength;if(a<=b)return void(a>this._byteLength&&(this._byteLength=
a));for(1>b&&(b=1);a>b;)b*=2;b=new ArrayBuffer(b);var d=new Uint8Array(this._buffer);(new Uint8Array(b,0,d.length)).set(d);this.buffer=b;this._byteLength=a}};e.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var a=new ArrayBuffer(this._byteLength),b=new Uint8Array(a),d=new Uint8Array(this._buffer,0,b.length);b.set(d);this.buffer=a}};e.BIG_ENDIAN=!1;e.LITTLE_ENDIAN=!0;e.prototype._byteLength=0;Object.defineProperty(e.prototype,"byteLength",{get:function(){return this._byteLength-
this._byteOffset}});Object.defineProperty(e.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(a){this._buffer=a;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(a){this._byteOffset=a;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});Object.defineProperty(e.prototype,
"dataView",{get:function(){return this._dataView},set:function(a){this._byteOffset=a.byteOffset;this._buffer=a.buffer;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._byteOffset+a.byteLength}});e.prototype.seek=function(a){a=Math.max(0,Math.min(this.byteLength,a));this.position=isNaN(a)||!isFinite(a)?0:a};e.prototype.isEof=function(){return this.position>=this._byteLength};e.prototype.mapUint8Array=function(a){this._realloc(1*a);var b=new Uint8Array(this._buffer,this.byteOffset+
this.position,a);return this.position+=1*a,b};e.prototype.readInt32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var d=new Int32Array(a);return e.memcpy(d.buffer,0,this.buffer,this.byteOffset+this.position,a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readInt16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var d=new Int16Array(a);return e.memcpy(d.buffer,0,this.buffer,this.byteOffset+this.position,
a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readInt8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Int8Array(a);return e.memcpy(b.buffer,0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT),this.position+=b.byteLength,b};e.prototype.readUint32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var d=new Uint32Array(a);return e.memcpy(d.buffer,0,this.buffer,this.byteOffset+this.position,
a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readUint16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var d=new Uint16Array(a);return e.memcpy(d.buffer,0,this.buffer,this.byteOffset+this.position,a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readUint8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Uint8Array(a);return e.memcpy(b.buffer,
0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT),this.position+=b.byteLength,b};e.prototype.readFloat64Array=function(a,b){a=null==a?this.byteLength-this.position/8:a;var d=new Float64Array(a);return e.memcpy(d.buffer,0,this.buffer,this.byteOffset+this.position,a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readFloat32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var d=new Float32Array(a);return e.memcpy(d.buffer,
0,this.buffer,this.byteOffset+this.position,a*d.BYTES_PER_ELEMENT),e.arrayToNative(d,null==b?this.endianness:b),this.position+=d.byteLength,d};e.prototype.readInt32=function(a){a=this._dataView.getInt32(this.position,null==a?this.endianness:a);return this.position+=4,a};e.prototype.readInt16=function(a){a=this._dataView.getInt16(this.position,null==a?this.endianness:a);return this.position+=2,a};e.prototype.readInt8=function(){var a=this._dataView.getInt8(this.position);return this.position+=1,a};
e.prototype.readUint32=function(a){a=this._dataView.getUint32(this.position,null==a?this.endianness:a);return this.position+=4,a};e.prototype.readUint16=function(a){a=this._dataView.getUint16(this.position,null==a?this.endianness:a);return this.position+=2,a};e.prototype.readUint8=function(){var a=this._dataView.getUint8(this.position);return this.position+=1,a};e.prototype.readFloat32=function(a){a=this._dataView.getFloat32(this.position,null==a?this.endianness:a);return this.position+=4,a};e.prototype.readFloat64=
function(a){a=this._dataView.getFloat64(this.position,null==a?this.endianness:a);return this.position+=8,a};e.endianness=0<(new Int8Array((new Int16Array([1])).buffer))[0];e.memcpy=function(a,b,d,g,c){a=new Uint8Array(a,b,c);d=new Uint8Array(d,g,c);a.set(d)};e.arrayToNative=function(a,b){return b==this.endianness?a:this.flipArrayEndianness(a)};e.nativeToEndian=function(a,b){return this.endianness==b?a:this.flipArrayEndianness(a)};e.flipArrayEndianness=function(a){for(var b=new Uint8Array(a.buffer,
a.byteOffset,a.byteLength),d=0;d<a.byteLength;d+=a.BYTES_PER_ELEMENT)for(var g=d+a.BYTES_PER_ELEMENT-1,c=d;g>c;g--,c++){var f=b[c];b[c]=b[g];b[g]=f}return a};e.prototype.failurePosition=0;String.fromCharCodeUint8=function(a){for(var b=[],d=0;d<a.length;d++)b[d]=a[d];return String.fromCharCode.apply(null,b)};e.prototype.readString=function(a,b){return null==b||"ASCII"==b?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==a?this.byteLength-this.position:a)]):(new TextDecoder(b)).decode(this.mapUint8Array(a))};
e.prototype.readCString=function(a){var b=this.byteLength-this.position,d=new Uint8Array(this._buffer,this._byteOffset+this.position),g=b;null!=a&&(g=Math.min(a,b));for(var c=0;c<g&&0!==d[c];c++);d=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(c)]);return null!=a?this.position+=g-c:c!=b&&(this.position+=1),d};var k=Math.pow(2,32);e.prototype.readUint64=function(){return this.readUint32()*k+this.readUint32()};e.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<
8)+this.readUint8()};"undefined"!=typeof exports&&(exports.DataStream=e);e.prototype.save=function(a){var b=new Blob([this.buffer]),d=window.webkitURL||window.URL;if(!d||!d.createObjectURL)throw"DataStream.save: Can't create object URL.";b=d.createObjectURL(b);var g=document.createElement("a");g.setAttribute("href",b);g.setAttribute("download",a);g.click();d.revokeObjectURL(b)};e.prototype._dynamicSize=!0;Object.defineProperty(e.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(a){a||
this._trimAlloc();this._dynamicSize=a}});e.prototype.shift=function(a){var b=new ArrayBuffer(this._byteLength-a),d=new Uint8Array(b),g=new Uint8Array(this._buffer,a,d.length);d.set(g);this.buffer=b;this.position-=a};e.prototype.writeInt32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Int32Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapInt32Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeInt32(a[d],
b)};e.prototype.writeInt16Array=function(a,b){if(this._realloc(2*a.length),a instanceof Int16Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapInt16Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeInt16(a[d],b)};e.prototype.writeInt8Array=function(a){if(this._realloc(1*a.length),a instanceof Int8Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+
this.position,a.buffer,0,a.byteLength),this.mapInt8Array(a.length);else for(var b=0;b<a.length;b++)this.writeInt8(a[b])};e.prototype.writeUint32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Uint32Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint32Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeUint32(a[d],b)};e.prototype.writeUint16Array=function(a,b){if(this._realloc(2*
a.length),a instanceof Uint16Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint16Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeUint16(a[d],b)};e.prototype.writeUint8Array=function(a){if(this._realloc(1*a.length),a instanceof Uint8Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint8Array(a.length);
else for(var b=0;b<a.length;b++)this.writeUint8(a[b])};e.prototype.writeFloat64Array=function(a,b){if(this._realloc(8*a.length),a instanceof Float64Array&&0===this.byteOffset+this.position%a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapFloat64Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeFloat64(a[d],b)};e.prototype.writeFloat32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Float32Array&&0===this.byteOffset+this.position%
a.BYTES_PER_ELEMENT)e.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapFloat32Array(a.length,b);else for(var d=0;d<a.length;d++)this.writeFloat32(a[d],b)};e.prototype.writeInt32=function(a,b){this._realloc(4);this._dataView.setInt32(this.position,a,null==b?this.endianness:b);this.position+=4};e.prototype.writeInt16=function(a,b){this._realloc(2);this._dataView.setInt16(this.position,a,null==b?this.endianness:b);this.position+=2};e.prototype.writeInt8=function(a){this._realloc(1);
this._dataView.setInt8(this.position,a);this.position+=1};e.prototype.writeUint32=function(a,b){this._realloc(4);this._dataView.setUint32(this.position,a,null==b?this.endianness:b);this.position+=4};e.prototype.writeUint16=function(a,b){this._realloc(2);this._dataView.setUint16(this.position,a,null==b?this.endianness:b);this.position+=2};e.prototype.writeUint8=function(a){this._realloc(1);this._dataView.setUint8(this.position,a);this.position+=1};e.prototype.writeFloat32=function(a,b){this._realloc(4);
this._dataView.setFloat32(this.position,a,null==b?this.endianness:b);this.position+=4};e.prototype.writeFloat64=function(a,b){this._realloc(8);this._dataView.setFloat64(this.position,a,null==b?this.endianness:b);this.position+=8};e.prototype.writeUCS2String=function(a,b,d){null==d&&(d=a.length);for(var g=0;g<a.length&&g<d;g++)this.writeUint16(a.charCodeAt(g),b);for(;g<d;g++)this.writeUint16(0)};e.prototype.writeString=function(a,b,d){if(null==b||"ASCII"==b)if(null!=d){var g=Math.min(a.length,d);for(b=
0;b<g;b++)this.writeUint8(a.charCodeAt(b));for(;b<d;b++)this.writeUint8(0)}else for(b=0;b<a.length;b++)this.writeUint8(a.charCodeAt(b));else this.writeUint8Array((new TextEncoder(b)).encode(a.substring(0,d)))};e.prototype.writeCString=function(a,b){var d;if(null!=b){var g=Math.min(a.length,b);for(d=0;d<g;d++)this.writeUint8(a.charCodeAt(d));for(;d<b;d++)this.writeUint8(0)}else{for(d=0;d<a.length;d++)this.writeUint8(a.charCodeAt(d));this.writeUint8(0)}};e.prototype.writeStruct=function(a,b){for(var d=
0;d<a.length;d+=2)this.writeType(a[d+1],b[a[d]],b)};e.prototype.writeType=function(a,b,d){var g;if("function"==typeof a)return a(this,b);if("object"==typeof a&&!(a instanceof Array))return a.set(this,b,d);d=null;var c="ASCII",f=this.position;switch("string"==typeof a&&/:/.test(a)&&(g=a.split(":"),a=g[0],d=parseInt(g[1])),"string"==typeof a&&/,/.test(a)&&(g=a.split(","),a=g[0],c=parseInt(g[1])),a){case "uint8":this.writeUint8(b);break;case "int8":this.writeInt8(b);break;case "uint16":this.writeUint16(b,
this.endianness);break;case "int16":this.writeInt16(b,this.endianness);break;case "uint32":this.writeUint32(b,this.endianness);break;case "int32":this.writeInt32(b,this.endianness);break;case "float32":this.writeFloat32(b,this.endianness);break;case "float64":this.writeFloat64(b,this.endianness);break;case "uint16be":this.writeUint16(b,e.BIG_ENDIAN);break;case "int16be":this.writeInt16(b,e.BIG_ENDIAN);break;case "uint32be":this.writeUint32(b,e.BIG_ENDIAN);break;case "int32be":this.writeInt32(b,e.BIG_ENDIAN);
break;case "float32be":this.writeFloat32(b,e.BIG_ENDIAN);break;case "float64be":this.writeFloat64(b,e.BIG_ENDIAN);break;case "uint16le":this.writeUint16(b,e.LITTLE_ENDIAN);break;case "int16le":this.writeInt16(b,e.LITTLE_ENDIAN);break;case "uint32le":this.writeUint32(b,e.LITTLE_ENDIAN);break;case "int32le":this.writeInt32(b,e.LITTLE_ENDIAN);break;case "float32le":this.writeFloat32(b,e.LITTLE_ENDIAN);break;case "float64le":this.writeFloat64(b,e.LITTLE_ENDIAN);break;case "cstring":this.writeCString(b,
d);break;case "string":this.writeString(b,c,d);break;case "u16string":this.writeUCS2String(b,this.endianness,d);break;case "u16stringle":this.writeUCS2String(b,e.LITTLE_ENDIAN,d);break;case "u16stringbe":this.writeUCS2String(b,e.BIG_ENDIAN,d);break;default:if(3==a.length)for(a=a[1],g=0;g<b.length;g++)this.writeType(a,b[g]);else this.writeStruct(a,b)}null!=d&&(this.position=f,this._realloc(d),this.position=f+d)};e.prototype.writeUint64=function(a){this.writeUint32(Math.floor(a/k));this.writeUint32(4294967295&
a)};e.prototype.writeUint24=function(a){this.writeUint8((16711680&a)>>16);this.writeUint8((65280&a)>>8);this.writeUint8(255&a)};e.prototype.adjustUint32=function(a,b){var d=this.position;this.seek(a);this.writeUint32(b);this.seek(d)};e.prototype.mapInt32Array=function(a,b){this._realloc(4*a);var d=new Int32Array(this._buffer,this.byteOffset+this.position,a);return e.arrayToNative(d,null==b?this.endianness:b),this.position+=4*a,d};e.prototype.mapInt16Array=function(a,b){this._realloc(2*a);var d=new Int16Array(this._buffer,
this.byteOffset+this.position,a);return e.arrayToNative(d,null==b?this.endianness:b),this.position+=2*a,d};e.prototype.mapInt8Array=function(a){this._realloc(1*a);var b=new Int8Array(this._buffer,this.byteOffset+this.position,a);return this.position+=1*a,b};e.prototype.mapUint32Array=function(a,b){this._realloc(4*a);var d=new Uint32Array(this._buffer,this.byteOffset+this.position,a);return e.arrayToNative(d,null==b?this.endianness:b),this.position+=4*a,d};e.prototype.mapUint16Array=function(a,b){this._realloc(2*
a);var d=new Uint16Array(this._buffer,this.byteOffset+this.position,a);return e.arrayToNative(d,null==b?this.endianness:b),this.position+=2*a,d};e.prototype.mapFloat64Array=function(a,b){this._realloc(8*a);var d=new Float64Array(this._buffer,this.byteOffset+this.position,a);return e.arrayToNative(d,null==b?this.endianness:b),this.position+=8*a,d};e.prototype.mapFloat32Array=function(a,b){this._realloc(4*a);var d=new Float32Array(this._buffer,this.byteOffset+this.position,a);return e.arrayToNative(d,
null==b?this.endianness:b),this.position+=4*a,d};var l=function(a){this.buffers=[];this.bufferIndex=-1;a&&(this.insertBuffer(a),this.bufferIndex=0)};l.prototype=new e(new ArrayBuffer,0,e.BIG_ENDIAN);l.prototype.initialized=function(){var a;return-1<this.bufferIndex||(0<this.buffers.length?(a=this.buffers[0],0===a.fileStart?(this.buffer=a,this.bufferIndex=0,f.debug("MultiBufferStream","Stream ready for parsing"),!0):(f.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),
!1)):(f.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))};ArrayBuffer.concat=function(a,b){f.debug("ArrayBuffer","Trying to create a new buffer of size: "+(a.byteLength+b.byteLength));var d=new Uint8Array(a.byteLength+b.byteLength);return d.set(new Uint8Array(a),0),d.set(new Uint8Array(b),a.byteLength),d.buffer};l.prototype.reduceBuffer=function(a,b,d){var g;return g=new Uint8Array(d),g.set(new Uint8Array(a,b,d)),g.buffer.fileStart=a.fileStart+b,g.buffer.usedBytes=
0,g.buffer};l.prototype.insertBuffer=function(a){for(var b=!0,d=0;d<this.buffers.length;d++){var g=this.buffers[d];if(a.fileStart<=g.fileStart){if(a.fileStart===g.fileStart){if(a.byteLength>g.byteLength){this.buffers.splice(d,1);d--;continue}f.warn("MultiBufferStream","Buffer (fileStart: "+a.fileStart+" - Length: "+a.byteLength+") already appended, ignoring")}else a.fileStart+a.byteLength<=g.fileStart||(a=this.reduceBuffer(a,0,g.fileStart-a.fileStart)),f.debug("MultiBufferStream","Appending new buffer (fileStart: "+
a.fileStart+" - Length: "+a.byteLength+")"),this.buffers.splice(d,0,a),0===d&&(this.buffer=a);b=!1;break}if(a.fileStart<g.fileStart+g.byteLength){g=g.fileStart+g.byteLength-a.fileStart;var c=a.byteLength-g;if(!(0<c)){b=!1;break}a=this.reduceBuffer(a,g,c)}}b&&(f.debug("MultiBufferStream","Appending new buffer (fileStart: "+a.fileStart+" - Length: "+a.byteLength+")"),this.buffers.push(a),0===d&&(this.buffer=a))};l.prototype.logBufferLevel=function(a){var b,d,g,c,e=[],G="";for(b=g=d=0;b<this.buffers.length;b++){var h=
this.buffers[b];0===b?(c={},e.push(c),c.start=h.fileStart,c.end=h.fileStart+h.byteLength,G+="["+c.start+"-"):c.end===h.fileStart?c.end=h.fileStart+h.byteLength:(c={},c.start=h.fileStart,G+=e[e.length-1].end-1+"], ["+c.start+"-",c.end=h.fileStart+h.byteLength,e.push(c));d+=h.usedBytes;g+=h.byteLength}0<e.length&&(G+=c.end-1+"]");a=a?f.info:f.debug;0===this.buffers.length?a("MultiBufferStream","No more buffer in memory"):a("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+d+"/"+g+" bytes): "+
G)};l.prototype.cleanBuffers=function(){var a;for(a=0;a<this.buffers.length;a++){var b=this.buffers[a];b.usedBytes===b.byteLength&&(f.debug("MultiBufferStream","Removing buffer #"+a),this.buffers.splice(a,1),a--)}};l.prototype.mergeNextBuffer=function(){var a;if(this.bufferIndex+1<this.buffers.length&&(a=this.buffers[this.bufferIndex+1],a.fileStart===this.buffer.fileStart+this.buffer.byteLength)){var b=this.buffer.byteLength,d=this.buffer.usedBytes,c=this.buffer.fileStart;return this.buffers[this.bufferIndex]=
ArrayBuffer.concat(this.buffer,a),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=d,this.buffer.fileStart=c,f.debug("ISOFile","Concatenating buffer for box parsing (length: "+b+"->"+this.buffer.byteLength+")"),!0}return!1};l.prototype.findPosition=function(a,b,d){var c=null,p=-1;for(a=!0===a?0:this.bufferIndex;a<this.buffers.length&&(c=this.buffers[a],c.fileStart<=b);)p=a,d&&(c.fileStart+c.byteLength<=b?c.usedBytes=c.byteLength:c.usedBytes=
b-c.fileStart,this.logBufferLevel()),a++;return-1!==p?(c=this.buffers[p],c.fileStart+c.byteLength>=b?(f.debug("MultiBufferStream","Found position in existing buffer #"+p),p):-1):-1};l.prototype.findEndContiguousBuf=function(a){var b;var d=void 0!==a?a:this.bufferIndex;if(a=this.buffers[d],this.buffers.length>d+1)for(d+=1;d<this.buffers.length&&(b=this.buffers[d],b.fileStart===a.fileStart+a.byteLength);d++)a=b;return a.fileStart+a.byteLength};l.prototype.getEndFilePositionAfter=function(a){var b=this.findPosition(!0,
a,!1);return-1!==b?this.findEndContiguousBuf(b):a};l.prototype.addUsedBytes=function(a){this.buffer.usedBytes+=a;this.logBufferLevel()};l.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength;this.logBufferLevel()};l.prototype.seek=function(a,b,d){var c;return c=this.findPosition(b,a,d),-1!==c?(this.buffer=this.buffers[c],this.bufferIndex=c,this.position=a-this.buffer.fileStart,f.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(f.debug("MultiBufferStream",
"Position "+a+" not found in buffered data"),!1)};l.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position};l.prototype.getLength=function(){return this.byteLength};l.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+
this.byteLength};var m=function(){var a=[,,,"ES_Descriptor","DecoderConfigDescriptor","DecoderSpecificInfo","SLConfigDescriptor"],b=this,d={};return this.parseOneDescriptor=function(b){var c,g=0,e=0;var h=b.readUint8();g++;var k=b.readUint8();for(g++;128&k;)e=(127&k)<<7,k=b.readUint8(),g++;return e+=127&k,f.debug("MPEG4DescriptorParser","Found "+(a[h]||"Descriptor "+h)+", size "+e+" at position "+b.getPosition()),c=a[h]?new d[a[h]](e):new d.Descriptor(e),c.parse(b),c},d.Descriptor=function(a,b){this.tag=
a;this.size=b;this.descs=[]},d.Descriptor.prototype.parse=function(a){this.data=a.readUint8Array(this.size)},d.Descriptor.prototype.findDescriptor=function(a){for(var b=0;b<this.descs.length;b++)if(this.descs[b].tag==a)return this.descs[b];return null},d.Descriptor.prototype.parseRemainingDescriptors=function(a){for(var d=a.position;a.position<d+this.size;){var c=b.parseOneDescriptor(a);this.descs.push(c)}},d.ES_Descriptor=function(a){d.Descriptor.call(this,3,a)},d.ES_Descriptor.prototype=new d.Descriptor,
d.ES_Descriptor.prototype.parse=function(a){if(this.ES_ID=a.readUint16(),this.flags=a.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=a.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var b=a.readUint8();this.URL=a.readString(b);this.size-=b+1}else this.URL=null;32&this.flags?(this.OCR_ES_ID=a.readUint16(),this.size-=2):this.OCR_ES_ID=0;this.parseRemainingDescriptors(a)},d.ES_Descriptor.prototype.getOTI=function(a){return(a=this.findDescriptor(4))?a.oti:0},d.ES_Descriptor.prototype.getAudioConfig=
function(a){a=this.findDescriptor(4);return a?(a=a.findDescriptor(5))&&a.data?(248&a.data[0])>>3:null:null},d.DecoderConfigDescriptor=function(a){d.Descriptor.call(this,4,a)},d.DecoderConfigDescriptor.prototype=new d.Descriptor,d.DecoderConfigDescriptor.prototype.parse=function(a){this.oti=a.readUint8();this.streamType=a.readUint8();this.bufferSize=a.readUint24();this.maxBitrate=a.readUint32();this.avgBitrate=a.readUint32();this.size-=13;this.parseRemainingDescriptors(a)},d.DecoderSpecificInfo=function(a){d.Descriptor.call(this,
5,a)},d.DecoderSpecificInfo.prototype=new d.Descriptor,d.SLConfigDescriptor=function(a){d.Descriptor.call(this,6,a)},d.SLConfigDescriptor.prototype=new d.Descriptor,this},c={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,boxCodes:"mdat;idat;free;skip;avcC;hvcC;ftyp;styp;payl;vttC;rtp ;sdp ;btrt;frma;trpy;tpyl;totl;tpay;dmed;dimm;drep;nump;npck;maxr;tmin;tmax;dmax;pmax;payt;vmhd;smhd;hmhd;idat;meco;udta;strk;free;skip".split(";"),fullBoxCodes:"mvhd;tkhd;mdhd;hdlr;vmhd;smhd;hmhd;nmhd;url ;urn ;ctts;cslg;stco;co64;stsc;stss;stsz;stz2;stts;stsh;mehd;trex;mfhd;tfhd;trun;tfdt;esds;subs;txtC;sidx;emsg;prft;pssh;elst;dref;url ;urn ;sbgp;sgpd;cprt;iods;ssix;tfra;mfro;pdin;tsel;trep;leva;stri;stsg;schm;stvi;padb;stdp;sdtp;saio;saiz;meta;xml ;bxml;iloc;pitm;ipro;iinf;infe;iref;mere;kind;elng".split(";"),
containerBoxCodes:[["moov",["trak","sidx"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["udta"],["mfra"],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp"]],sampleEntryCodes:[{prefix:"Visual",types:"mp4v avc1 avc2 avc3 avc4 avcp drac encv mjp2 mvc1 mvc2 resv s263 svc1 vc-1 hvc1 hev1".split(" ")},{prefix:"Audio",types:["mp4a",
"ac-3","alac","dra1","dtsc","dtse",,"dtsh","dtsl","ec-3","enca","g719","g726","m4ae","mlpa","raw ","samr","sawb","sawp","sevc","sqcp","ssmv","twos",".mp3"]},{prefix:"Hint",types:"fdp ;m2ts;pm2t;prtp;rm2t;rrtp;rsrp;rtp ;sm2t;srtp".split(";")},{prefix:"Metadata",types:["metx","mett","urim"]},{prefix:"Subtitle",types:["stpp","wvtt","sbtt","tx3g","stxt"]},{prefix:"System",types:["mp4s"]}],sampleGroupEntryCodes:"roll;prol;alst;rap ;tele;avss;avll;sync;tscl;tsas;stsa;scif;mvif;scnm;dtrt;vipr;tele;rash".split(";"),
trackGroupTypes:["msrc"],initialize:function(){var a,b;c.FullBox.prototype=new c.Box;c.ContainerBox.prototype=new c.Box;c.SampleEntry.prototype=new c.FullBox;c.TrackGroupTypeBox.prototype=new c.FullBox;var d=c.boxCodes.length;for(a=0;a<d;a++)c[c.boxCodes[a]+"Box"]=function(a){return function(b){c.Box.call(this,c.boxCodes[a],b)}}(a),c[c.boxCodes[a]+"Box"].prototype=new c.Box;d=c.fullBoxCodes.length;for(a=0;a<d;a++)c[c.fullBoxCodes[a]+"Box"]=function(a){return function(b){c.FullBox.call(this,c.fullBoxCodes[a],
b)}}(a),c[c.fullBoxCodes[a]+"Box"].prototype=new c.FullBox;d=c.containerBoxCodes.length;for(a=0;a<d;a++)c[c.containerBoxCodes[a][0]+"Box"]=function(a,b){return function(d){if(c.ContainerBox.call(this,c.containerBoxCodes[a][0],d),b){this.subBoxNames=b;d=b.length;for(var g=0;g<d;g++)this[b[g]+"s"]=[]}}}(a,c.containerBoxCodes[a][1]),c[c.containerBoxCodes[a][0]+"Box"].prototype=new c.ContainerBox;d=c.sampleEntryCodes.length;for(b=0;b<d;b++){var g=c.sampleEntryCodes[b].prefix,f=c.sampleEntryCodes[b].types,
e=f.length;c[g+"SampleEntry"]=function(a,b){c.SampleEntry.call(this,a,b)};c[g+"SampleEntry"].prototype=new c.SampleEntry;for(a=0;a<e;a++)c[f[a]+"SampleEntry"]=function(a,b){return function(d){c[c.sampleEntryCodes[a].prefix+"SampleEntry"].call(this,c.sampleEntryCodes[a].types[b],d)}}(b,a),c[f[a]+"SampleEntry"].prototype=new c[g+"SampleEntry"]}d=c.sampleGroupEntryCodes.length;for(a=0;a<d;a++)c[c.sampleGroupEntryCodes[a]+"SampleGroupEntry"]=function(a){return function(b){c.SampleGroupEntry.call(this,
c.sampleGroupEntryCodes[a],b)}}(a),c[c.sampleGroupEntryCodes[a]+"SampleGroupEntry"].prototype=new c.SampleGroupEntry;d=c.trackGroupTypes.length;for(a=0;a<d;a++)c[c.trackGroupTypes[a]+"Box"]=function(a){return function(b){c.TrackGroupTypeBox.call(this,c.trackGroupTypes[a],b)}}(a),c[c.trackGroupTypes[a]+"Box"].prototype=new c.TrackGroupTypeBox},Box:function(a,b){this.type=a;this.size=b},FullBox:function(a,b){c.Box.call(this,a,b);this.version=this.flags=0},ContainerBox:function(a,b){c.Box.call(this,
a,b);this.boxes=[]},SampleEntry:function(a,b,d,g){c.Box.call(this,a,b);this.hdr_size=d;this.start=g;this.boxes=[]},SampleGroupEntry:function(a){this.grouping_type=a},TrackGroupTypeBox:function(a,b){c.FullBox.call(this,a,b)}};c.initialize();c.TKHD_FLAG_ENABLED=1;c.TKHD_FLAG_IN_MOVIE=2;c.TKHD_FLAG_IN_PREVIEW=4;c.TFHD_FLAG_BASE_DATA_OFFSET=1;c.TFHD_FLAG_SAMPLE_DESC=2;c.TFHD_FLAG_SAMPLE_DUR=8;c.TFHD_FLAG_SAMPLE_SIZE=16;c.TFHD_FLAG_SAMPLE_FLAGS=32;c.TFHD_FLAG_DUR_EMPTY=65536;c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=
131072;c.TRUN_FLAGS_DATA_OFFSET=1;c.TRUN_FLAGS_FIRST_FLAG=4;c.TRUN_FLAGS_DURATION=256;c.TRUN_FLAGS_SIZE=512;c.TRUN_FLAGS_FLAGS=1024;c.TRUN_FLAGS_CTS_OFFSET=2048;c.Box.prototype.add=function(a){var b=new c[a+"Box"];return this.boxes.push(b),this[a+"s"]?this[a+"s"].push(b):this[a]=b,b};c.Box.prototype.set=function(a,b){return this[a]=b,this};c.Box.prototype.addEntry=function(a,b){b=b||"entries";return this[b]||(this[b]=[]),this[b].push(a),this};"undefined"!=typeof exports&&(exports.BoxParser=c);c.SampleEntry.prototype.isVideo=
function(){return!1};c.SampleEntry.prototype.isAudio=function(){return!1};c.SampleEntry.prototype.isSubtitle=function(){return!1};c.SampleEntry.prototype.isMetadata=function(){return!1};c.SampleEntry.prototype.isHint=function(){return!1};c.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")};c.SampleEntry.prototype.getWidth=function(){return""};c.SampleEntry.prototype.getHeight=function(){return""};c.SampleEntry.prototype.getChannelCount=function(){return""};c.SampleEntry.prototype.getSampleRate=
function(){return""};c.SampleEntry.prototype.getSampleSize=function(){return""};c.VisualSampleEntry.prototype.isVideo=function(){return!0};c.VisualSampleEntry.prototype.getWidth=function(){return this.width};c.VisualSampleEntry.prototype.getHeight=function(){return this.height};c.AudioSampleEntry.prototype.isAudio=function(){return!0};c.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count};c.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate};c.AudioSampleEntry.prototype.getSampleSize=
function(){return this.samplesize};c.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0};c.MetadataSampleEntry.prototype.isMetadata=function(){return!0};c.decimalToHex=function(a,b){a=Number(a).toString(16);for(b="undefined"==typeof b||null===b?b=2:b;a.length<b;)a="0"+a;return a};c.avc1SampleEntry.prototype.getCodec=function(){var a=c.SampleEntry.prototype.getCodec.call(this);return this.avcC?a+"."+c.decimalToHex(this.avcC.AVCProfileIndication)+c.decimalToHex(this.avcC.profile_compatibility)+
c.decimalToHex(this.avcC.AVCLevelIndication):a};c.hvc1SampleEntry.prototype.getCodec=function(){var a,b=c.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(b+=".",this.hvcC.general_profile_space){case 0:b+="";break;case 1:b+="A";break;case 2:b+="B";break;case 3:b+="C"}b+=this.hvcC.general_profile_idc;var d=this.hvcC.general_profile_compatibility,g=0;for(a=0;32>a&&(g|=1&d,31!=a);a++)g<<=1,d>>=1;b=b+"."+c.decimalToHex(g,0);b=b+"."+(0===this.hvcC.general_tier_flag?"L":"H");b+=this.hvcC.general_level_idc;
d=!1;g="";for(a=5;0<=a;a--)(this.hvcC.general_constraint_indicator[a]||d)&&(g="."+c.decimalToHex(this.hvcC.general_constraint_indicator[a],0)+g,d=!0);b+=g}return b};c.mp4aSampleEntry.prototype.getCodec=function(){var a=c.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var b=this.esds.esd.getOTI(),d=this.esds.esd.getAudioConfig();return a+"."+c.decimalToHex(b)+(d?"."+d:"")}return a};c.stxtSampleEntry.prototype.getCodec=function(){var a=c.SampleEntry.prototype.getCodec.call(this);
return this.mime_format?a+"."+this.mime_format:a};c.parseOneBox=function(a,b,d){var g,p,e,h=a.getPosition(),k=0;if(8>a.getEndPosition()-h)return f.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:c.ERR_NOT_ENOUGH_DATA};var l=a.readUint32(),m=a.readString(4);if(f.debug("BoxParser","Found box of type "+m+" and size "+l+" at position "+h),k=8,"uuid"==m&&(e=a.readUint8Array(16),k+=16),1==l){if(8>a.getEndPosition()-a.getPosition())return a.seek(h),f.warn("BoxParser",
'Not enough data in stream to parse the extended size of the "'+m+'" box'),{code:c.ERR_NOT_ENOUGH_DATA};l=a.readUint64();k+=8}else if(0===l&&"mdat"!==m)throw"Unlimited box size not supported";return d&&l>d?(f.error("BoxParser","Box of type "+m+" has a size "+l+" greater than its container size "+d),{code:c.ERR_NOT_ENOUGH_DATA,type:m,size:l,hdr_size:k,start:h}):h+l>a.getEndPosition()?(a.seek(h),f.warn("BoxParser",'Not enough data in stream to parse the entire "'+m+'" box'),{code:c.ERR_NOT_ENOUGH_DATA,
type:m,size:l,hdr_size:k,start:h}):b?{code:c.OK,type:m,size:l,hdr_size:k,start:h}:(c[m+"Box"]?g=new c[m+"Box"](l):("uuid"!==m&&f.warn("BoxParser","Unknown box type: "+m),g=new c.Box(m,l),e&&(g.uuid=e)),g.hdr_size=k,g.start=h,g.write===c.Box.prototype.write&&"mdat"!==g.type&&(f.warn("BoxParser",g.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),g.parseDataAndRewind(a)),g.parse(a),p=a.getPosition()-(g.start+g.size),0>p?(f.warn("BoxParser","Parsing of box "+g.type+
" did not read the entire indicated box data size (missing "+-p+" bytes), seeking forward"),a.seek(g.start+g.size)):0<p&&(f.error("BoxParser","Parsing of box "+g.type+" read "+p+" more bytes than the indicated box data size, seeking backwards"),a.seek(g.start+g.size)),{code:c.OK,box:g,size:g.size})};c.Box.prototype.parse=function(a){"mdat"!=this.type?this.data=a.readUint8Array(this.size-this.hdr_size):0===this.size?a.seek(a.getEndPosition()):a.seek(this.start+this.size)};c.Box.prototype.parseDataAndRewind=
function(a){this.data=a.readUint8Array(this.size-this.hdr_size);a.position-=this.size-this.hdr_size};c.FullBox.prototype.parseDataAndRewind=function(a){this.parseFullHeader(a);this.data=a.readUint8Array(this.size-this.hdr_size);this.hdr_size-=4;a.position-=this.size-this.hdr_size};c.FullBox.prototype.parseFullHeader=function(a){this.version=a.readUint8();this.flags=a.readUint24();this.hdr_size+=4};c.FullBox.prototype.parse=function(a){this.parseFullHeader(a);this.data=a.readUint8Array(this.size-this.hdr_size)};
c.ContainerBox.prototype.parse=function(a){for(var b,d;a.getPosition()<this.start+this.size&&(b=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code===c.OK);)d=b.box,this.boxes.push(d),this.subBoxNames&&-1!=this.subBoxNames.indexOf(d.type)?this[this.subBoxNames[this.subBoxNames.indexOf(d.type)]+"s"].push(d):this[d.type]=d};c.Box.prototype.parseLanguage=function(a){this.language=a.readUint16();a=[];a[0]=this.language>>10&31;a[1]=this.language>>5&31;a[2]=31&this.language;this.languageString=
String.fromCharCode(a[0]+96,a[1]+96,a[2]+96)};c.TrackGroupTypeBox.prototype.parse=function(a){this.parseFullHeader(a);this.track_group_id=a.readUint32()};c.TrackReferenceTypeBox=function(a,b,d,g){c.Box.call(this,a,b);this.hdr_size=d;this.start=g};c.TrackReferenceTypeBox.prototype=new c.Box;c.TrackReferenceTypeBox.prototype.parse=function(a){this.track_ids=a.readUint32Array((this.size-this.hdr_size)/4)};c.avcCBox.prototype.parse=function(a){var b;this.configurationVersion=a.readUint8();this.AVCProfileIndication=
a.readUint8();this.profile_compatibility=a.readUint8();this.AVCLevelIndication=a.readUint8();this.lengthSizeMinusOne=3&a.readUint8();var d=31&a.readUint8();var c=this.size-this.hdr_size-6;this.SPS=Array(d);for(b=0;b<d;b++){var f=a.readUint16();this.SPS[b]=a.readUint8Array(f);c-=2+f}d=a.readUint8();c--;this.PPS=Array(d);for(b=0;b<d;b++)f=a.readUint16(),this.PPS[b]=a.readUint8Array(f),c-=2+f;0<c&&(this.ext=a.readUint8Array(c))};c.btrtBox.prototype.parse=function(a){this.bufferSizeDB=a.readUint32();
this.maxBitrate=a.readUint32();this.avgBitrate=a.readUint32()};c.co64Box.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),b=a.readUint32(),this.chunk_offsets=[],0===this.version)for(d=0;d<b;d++)this.chunk_offsets.push(a.readUint64())};c.cprtBox.prototype.parse=function(a){this.parseFullHeader(a);this.parseLanguage(a);this.notice=a.readCString()};c.cslgBox.prototype.parse=function(a){this.parseFullHeader(a);0===this.version&&(this.compositionToDTSShift=a.readInt32(),this.leastDecodeToDisplayDelta=
a.readInt32(),this.greatestDecodeToDisplayDelta=a.readInt32(),this.compositionStartTime=a.readInt32(),this.compositionEndTime=a.readInt32())};c.cttsBox.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),b=a.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(d=0;d<b;d++)this.sample_counts.push(a.readUint32()),this.sample_offsets.push(a.readInt32());else if(1==this.version)for(d=0;d<b;d++)this.sample_counts.push(a.readUint32()),this.sample_offsets.push(a.readInt32())};
c.dimmBox.prototype.parse=function(a){this.bytessent=a.readUint64()};c.dmaxBox.prototype.parse=function(a){this.time=a.readUint32()};c.dmedBox.prototype.parse=function(a){this.bytessent=a.readUint64()};c.drefBox.prototype.parse=function(a){var b;this.parseFullHeader(a);this.entries=[];for(var d=a.readUint32(),g=0;g<d&&(b=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code===c.OK);g++){var f=b.box;this.entries.push(f)}};c.drepBox.prototype.parse=function(a){this.bytessent=a.readUint64()};
c.elngBox.prototype.parse=function(a){this.parseFullHeader(a);this.extended_language=a.readString(this.size-this.hdr_size)};c.elstBox.prototype.parse=function(a){this.parseFullHeader(a);this.entries=[];for(var b=a.readUint32(),d=0;d<b;d++){var c={};this.entries.push(c);1===this.version?(c.segment_duration=a.readUint64(),c.media_time=a.readInt64()):(c.segment_duration=a.readUint32(),c.media_time=a.readInt32());c.media_rate_integer=a.readInt16();c.media_rate_fraction=a.readInt16()}};c.emsgBox.prototype.parse=
function(a){this.parseFullHeader(a);this.scheme_id_uri=a.readCString();this.value=a.readCString();this.timescale=a.readUint32();this.presentation_time_delta=a.readUint32();this.event_duration=a.readUint32();this.id=a.readUint32();this.message_data=a.readUint8Array(this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1)))};c.esdsBox.prototype.parse=function(a){this.parseFullHeader(a);a=a.readUint8Array(this.size-this.hdr_size);"undefined"!=typeof m&&(this.esd=(new m).parseOneDescriptor(new e(a.buffer,
0,e.BIG_ENDIAN)))};c.frmaBox.prototype.parse=function(a){this.data_format=a.readString(4)};c.ftypBox.prototype.parse=function(a){var b=this.size-this.hdr_size;this.major_brand=a.readString(4);this.minor_version=a.readUint32();b-=8;this.compatible_brands=[];for(var d=0;4<=b;)this.compatible_brands[d]=a.readString(4),b-=4,d++};c.hdlrBox.prototype.parse=function(a){this.parseFullHeader(a);0===this.version&&(a.readUint32(),this.handler=a.readString(4),a.readUint32Array(3),this.name=a.readString(this.size-
this.hdr_size-20),"\x00"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))};c.hvcCBox.prototype.parse=function(a){var b;this.configurationVersion=a.readUint8();var d=a.readUint8();this.general_profile_space=d>>6;this.general_tier_flag=(32&d)>>5;this.general_profile_idc=31&d;this.general_profile_compatibility=a.readUint32();this.general_constraint_indicator=a.readUint8Array(6);this.general_level_idc=a.readUint8();this.min_spatial_segmentation_idc=4095&a.readUint16();this.parallelismType=
3&a.readUint8();this.chromaFormat=3&a.readUint8();this.bitDepthLumaMinus8=7&a.readUint8();this.bitDepthChromaMinus8=7&a.readUint8();this.avgFrameRate=a.readUint16();d=a.readUint8();this.constantFrameRate=d>>6;this.numTemporalLayers=(13&d)>>3;this.temporalIdNested=(4&d)>>2;this.lengthSizeMinusOne=3&d;this.nalu_arrays=[];var c=a.readUint8();for(b=0;b<c;b++){var f=[];this.nalu_arrays.push(f);d=a.readUint8();f.completeness=(128&d)>>7;f.nalu_type=63&d;var e=a.readUint16();for(d=0;d<e;d++){var h={};f.push(h);
var k=a.readUint16();h.data=a.readUint8Array(k)}}};c.iinfBox.prototype.parse=function(a){var b;this.parseFullHeader(a);0===this.version?this.entry_count=a.readUint16():this.entry_count=a.readUint32();this.item_infos=[];for(var d=0;d<this.entry_count&&(b=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code===c.OK);d++)"infe"!==b.box.type&&f.error("BoxParser","Expected 'infe' box, got "+b.box.type),this.item_infos[d]=b.box};c.ilocBox.prototype.parse=function(a){this.parseFullHeader(a);
var b=a.readUint8();this.offset_size=b>>4&15;this.length_size=15&b;b=a.readUint8();this.base_offset_size=b>>4&15;1===this.version||2===this.version?this.index_size=15&b:this.index_size=0;this.items=[];if(2>this.version)b=a.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";b=a.readUint32()}for(var d=0;d<b;d++){var c={};if(!(this.items.push(c),2>this.version)&&2!==this.version)throw"version of iloc box not supported";c.item_ID=a.readUint16();switch(1!==this.version&&2!==
this.version||(c.construction_method=15&a.readUint16()),c.data_reference_index=a.readUint16(),this.base_offset_size){case 0:c.base_offset=0;break;case 4:c.base_offset=a.readUint32();break;case 8:c.base_offset=a.readUint64();break;default:throw"Error reading base offset size";}var f=a.readUint16();c.extents=[];for(var e=0;e<f;e++){var h={};if(c.extents.push(h),1===this.version||2===this.version)switch(this.index_size){case 0:h.extent_index=0;break;case 4:h.extent_index=a.readUint32();break;case 8:h.extent_index=
a.readUint64();break;default:throw"Error reading extent index";}switch(this.offset_size){case 0:h.extent_offset=0;break;case 4:h.extent_offset=a.readUint32();break;case 8:h.extent_offset=a.readUint64();break;default:throw"Error reading extent index";}switch(this.length_size){case 0:h.extent_length=0;break;case 4:h.extent_length=a.readUint32();break;case 8:h.extent_length=a.readUint64();break;default:throw"Error reading extent index";}}}};c.infeBox.prototype.parse=function(a){return this.parseFullHeader(a),
0!==this.version&&1!==this.version||(this.item_ID=a.readUint16(),this.item_protection_index=a.readUint16(),this.item_name=a.readCString(),this.content_type=a.readCString(),this.content_encoding=a.readCString()),1===this.version?(this.extension_type=a.readString(4),f.warn("BoxParser","Cannot parse extension type"),void a.seek(this.start+this.size)):void(2<=this.version&&(2===this.version?this.item_ID=a.readUint16():3===this.version&&(this.item_ID=a.readUint32()),this.item_protection_index=a.readUint16(),
this.item_type=a.readString(4),this.name=a.readCString(),"mime"===this.item_type?(this.content_type=a.readCString(),this.content_encoding=a.readCString()):"uri "===this.item_type&&(this.item_uri_type=a.readCString())))};c.irefBox=function(a){c.FullBox.call(this,"iref",a);this.references=[]};c.irefBox.prototype=new c.FullBox;c.irefBox.prototype.parse=function(a){var b;for(this.parseFullHeader(a);a.getPosition()<this.start+this.size&&(b=c.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),b.code===
c.OK);){var d=0===this.version?new c.SingleItemTypeReferenceBox(b.type,b.size,b.hdr_size,b.start):new c.SingleItemTypeReferenceBoxLarge(b.type,b.size,b.hdr_size,b.start);d.write===c.Box.prototype.write&&"mdat"!==d.type&&(f.warn("BoxParser",d.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(a));d.parse(a);this.references.push(d)}};c.kindBox=function(a){c.FullBox.call(this,"kind",a);this.value=this.schemeURI=""};c.kindBox.prototype=new c.FullBox;
c.kindBox.prototype.parse=function(a){this.parseFullHeader(a);this.schemeURI=a.readCString();this.value=a.readCString()};c.levaBox.prototype.parse=function(a){this.parseFullHeader(a);var b=a.readUint8();this.levels=[];for(var d=0;d<b;d++){var c={};this.levels[d]=c;c.track_ID=a.readUint32();var e=a.readUint8();switch(c.padding_flag=e>>7,c.assignment_type=127&e,c.assignment_type){case 0:c.grouping_type=a.readUint32();break;case 1:c.grouping_type=a.readUint32();c.grouping_type_parameter=a.readUint32();
break;case 2:break;case 3:break;case 4:c.sub_track_id=a.readUint32();break;default:f.warn("BoxParser","Unknown leva assignement type")}}};c.maxrBox.prototype.parse=function(a){this.period=a.readUint32();this.bytes=a.readUint32()};c.mdhdBox.prototype.parse=function(a){this.parseFullHeader(a);1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),
this.timescale=a.readUint32(),this.duration=a.readUint32());this.parseLanguage(a);a.readUint16()};c.mehdBox.prototype.parse=function(a){this.parseFullHeader(a);1|this.flags&&(f.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1);1==this.version?this.fragment_duration=a.readUint64():this.fragment_duration=a.readUint32()};c.metaBox.prototype.parse=function(a){this.parseFullHeader(a);this.boxes=[];c.ContainerBox.prototype.parse.call(this,a)};c.mfhdBox.prototype.parse=
function(a){this.parseFullHeader(a);this.sequence_number=a.readUint32()};c.mfroBox.prototype.parse=function(a){this.parseFullHeader(a);this._size=a.readUint32()};c.mvhdBox.prototype.parse=function(a){this.flags=0;this.parseFullHeader(a);1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.timescale=a.readUint32(),this.duration=
a.readUint32());this.rate=a.readUint32();this.volume=a.readUint16()>>8;a.readUint16();a.readUint32Array(2);this.matrix=a.readUint32Array(9);a.readUint32Array(6);this.next_track_id=a.readUint32()};c.npckBox.prototype.parse=function(a){this.packetssent=a.readUint32()};c.numpBox.prototype.parse=function(a){this.packetssent=a.readUint64()};c.padbBox.prototype.parse=function(a){this.parseFullHeader(a);var b=a.readUint32();this.padbits=[];for(var d=0;d<Math.floor((b+1)/2);d++)this.padbits=a.readUint8()};
c.paylBox.prototype.parse=function(a){this.text=a.readString(this.size-this.hdr_size)};c.paytBox.prototype.parse=function(a){this.payloadID=a.readUint32();var b=a.readUint8();this.rtpmap_string=a.readString(b)};c.pdinBox.prototype.parse=function(a){this.parseFullHeader(a);var b=(this.size-this.hdr_size)/8;this.rate=[];this.initial_delay=[];for(var d=0;d<b;d++)this.rate[d]=a.readUint32(),this.initial_delay[d]=a.readUint32()};c.pitmBox.prototype.parse=function(a){this.parseFullHeader(a);0===this.version?
this.item_id=a.readUint16():this.item_id=a.readUint32()};c.pmaxBox.prototype.parse=function(a){this.bytes=a.readUint32()};c.prftBox.prototype.parse=function(a){this.parseFullHeader(a);this.ref_track_id=a.readUint32();this.ntp_timestamp=a.readUint64();0===this.version?this.media_time=a.readUint32():this.media_time=a.readUint64()};c.psshBox.prototype.parse=function(a){if(this.parseFullHeader(a),this.system_id=a.readUint8Array(16),0<this.version){var b=a.readUint32();this.kid=[];for(var d=0;d<b;d++)this.kid[d]=
a.readUint8Array(16)}b=a.readUint32();0<b&&(this.data=a.readUint8Array(b))};c["rtp Box"].prototype.parse=function(a){this.descriptionformat=a.readString(4);this.sdptext=a.readString(this.size-this.hdr_size-4)};c.saioBox.prototype.parse=function(a){this.parseFullHeader(a);1&this.flags&&(this.aux_info_type=a.readUint32(),this.aux_info_type_parameter=a.readUint32());var b=a.readUint32();this.offset=[];for(var d=0;d<b;d++)0===this.version?this.offset[d]=a.readUint32():this.offset[d]=a.readUint64()};c.saizBox.prototype.parse=
function(a){this.parseFullHeader(a);1&this.flags&&(this.aux_info_type=a.readUint32(),this.aux_info_type_parameter=a.readUint32());this.default_sample_info_size=a.readUint8();var b=a.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var d=0;d<b;d++)this.sample_info_size[d]=a.readUint8()};c.mettSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.content_encoding=a.readCString();this.mime_format=a.readCString();this.parseFooter(a)};c.metxSampleEntry.prototype.parse=
function(a){this.parseHeader(a);this.content_encoding=a.readCString();this.namespace=a.readCString();this.schema_location=a.readCString();this.parseFooter(a)};c.SampleEntry.prototype.parseHeader=function(a){a.readUint8Array(6);this.data_reference_index=a.readUint16();this.hdr_size+=8};c.SampleEntry.prototype.parse=function(a){this.parseHeader(a);this.data=a.readUint8Array(this.size-this.hdr_size)};c.SampleEntry.prototype.parseDataAndRewind=function(a){this.parseHeader(a);this.data=a.readUint8Array(this.size-
this.hdr_size);this.hdr_size-=8;a.position-=this.size-this.hdr_size};c.SampleEntry.prototype.parseFooter=function(a){for(var b,d;a.getPosition()<this.start+this.size&&(b=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code===c.OK);)d=b.box,this.boxes.push(d),this[d.type]=d};c.VisualSampleEntry.prototype.parse=function(a){this.parseHeader(a);a.readUint16();a.readUint16();a.readUint32Array(3);this.width=a.readUint16();this.height=a.readUint16();this.horizresolution=a.readUint32();this.vertresolution=
a.readUint32();a.readUint32();this.frame_count=a.readUint16();this.compressorname=a.readString(32);this.depth=a.readUint16();a.readUint16();this.parseFooter(a)};c.AudioSampleEntry.prototype.parse=function(a){this.parseHeader(a);a.readUint32Array(2);this.channel_count=a.readUint16();this.samplesize=a.readUint16();a.readUint16();a.readUint16();this.samplerate=a.readUint32()/65536;this.parseFooter(a)};c.sbttSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.content_encoding=a.readCString();
this.mime_format=a.readCString();this.parseFooter(a)};c.stppSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.namespace=a.readCString();this.schema_location=a.readCString();this.auxiliary_mime_types=a.readCString();this.parseFooter(a)};c.stxtSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.content_encoding=a.readCString();this.mime_format=a.readCString();this.parseFooter(a)};c.tx3gSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.displayFlags=a.readUint32();
this.horizontal_justification=a.readInt8();this.vertical_justification=a.readInt8();this.bg_color_rgba=a.readUint8Array(4);this.box_record=a.readInt16Array(4);this.style_record=a.readUint8Array(12);this.parseFooter(a)};c.wvttSampleEntry.prototype.parse=function(a){this.parseHeader(a);this.parseFooter(a)};c.alstSampleGroupEntry.prototype.parse=function(a){var b,d=a.readUint16();this.first_output_sample=a.readUint16();this.sample_offset=[];for(b=0;b<d;b++)this.sample_offset[b]=a.readUint32();d=this.description_length-
4-4*d;this.num_output_samples=[];this.num_total_samples=[];for(b=0;b<d/4;b++)this.num_output_samples[b]=a.readUint16(),this.num_total_samples[b]=a.readUint16()};c.avllSampleGroupEntry.prototype.parse=function(a){this.layerNumber=a.readUint8();this.accurateStatisticsFlag=a.readUint8();this.avgBitRate=a.readUint16();this.avgFrameRate=a.readUint16()};c.avssSampleGroupEntry.prototype.parse=function(a){this.subSequenceIdentifier=a.readUint16();this.layerNumber=a.readUint8();var b=a.readUint8();this.durationFlag=
b>>7;this.avgRateFlag=b>>6&1;this.durationFlag&&(this.duration=a.readUint32());this.avgRateFlag&&(this.accurateStatisticsFlag=a.readUint8(),this.avgBitRate=a.readUint16(),this.avgFrameRate=a.readUint16());this.dependency=[];b=a.readUint8();for(var d=0;d<b;d++){var c={};this.dependency.push(c);c.subSeqDirectionFlag=a.readUint8();c.layerNumber=a.readUint8();c.subSequenceIdentifier=a.readUint16()}};c.dtrtSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+
" not fully parsed")};c.mvifSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};c.prolSampleGroupEntry.prototype.parse=function(a){this.roll_distance=a.readInt16()};c["rap SampleGroupEntry"].prototype.parse=function(a){a=a.readUint8();this.num_leading_samples_known=a>>7;this.num_leading_samples=127&a};c.rashSampleGroupEntry.prototype.parse=function(a){if(this.operation_point_count=a.readUint16(),this.description_length!==(1===
this.operation_point_count?2:6*this.operation_point_count)+11)f.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=a.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=a.readUint16();else{this.target_rate_share=[];this.available_bitrate=[];for(var b=0;b<this.operation_point_count;b++)this.available_bitrate[b]=a.readUint32(),this.target_rate_share[b]=a.readUint16()}this.maximum_bitrate=a.readUint32();this.minimum_bitrate=
a.readUint32();this.discard_priority=a.readUint8()}};c.rollSampleGroupEntry.prototype.parse=function(a){this.roll_distance=a.readInt16()};c.SampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type);this.data=a.readUint8Array(this.description_length)};c.scifSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};c.scnmSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser",
"Sample Group type: "+this.grouping_type+" not fully parsed")};c.stsaSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};c.syncSampleGroupEntry.prototype.parse=function(a){this.NAL_unit_type=63&a.readUint8()};c.teleSampleGroupEntry.prototype.parse=function(a){this.level_independently_decodable=a.readUint8()>>7};c.tsasSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};
c.tsclSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};c.viprSampleGroupEntry.prototype.parse=function(a){f.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")};c.sbgpBox.prototype.parse=function(a){this.parseFullHeader(a);this.grouping_type=a.readString(4);1===this.version?this.grouping_type_parameter=a.readUint32():this.grouping_type_parameter=0;this.entries=[];for(var b=a.readUint32(),d=0;d<
b;d++){var c={};this.entries.push(c);c.sample_count=a.readInt32();c.group_description_index=a.readInt32()}};c.schmBox.prototype.parse=function(a){this.parseFullHeader(a);this.scheme_type=a.readString(4);this.scheme_version=a.readUint32();1&this.flags&&(this.scheme_uri=a.readString(this.size-this.hdr_size-8))};c["sdp Box"].prototype.parse=function(a){this.sdptext=a.readString(this.size-this.hdr_size)};c.sdtpBox.prototype.parse=function(a){this.parseFullHeader(a);var b=this.size-this.hdr_size;this.is_leading=
[];this.sample_depends_on=[];this.sample_is_depended_on=[];this.sample_has_redundancy=[];for(var d=0;d<b;d++){var c=a.readUint8();this.is_leading[d]=c>>6;this.sample_depends_on[d]=c>>4&3;this.sample_is_depended_on[d]=c>>2&3;this.sample_has_redundancy[d]=3&c}};c.sgpdBox.prototype.parse=function(a){this.parseFullHeader(a);this.grouping_type=a.readString(4);f.debug("BoxParser","Found Sample Groups of type "+this.grouping_type);1===this.version?this.default_length=a.readUint32():this.default_length=0;
2<=this.version&&(this.default_group_description_index=a.readUint32());this.entries=[];for(var b=a.readUint32(),d=0;d<b;d++){var g=c[this.grouping_type+"SampleGroupEntry"]?new c[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new c.SampleGroupEntry(this.grouping_type);this.entries.push(g);1===this.version&&0===this.default_length?g.description_length=a.readUint32():g.description_length=this.default_length;g.write===c.SampleGroupEntry.prototype.write&&(f.warn("BoxParser"," SampleEntry for type "+
this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),g.data=a.readUint8Array(g.description_length),a.position-=g.description_length);g.parse(a)}};c.sidxBox.prototype.parse=function(a){this.parseFullHeader(a);this.reference_ID=a.readUint32();this.timescale=a.readUint32();0===this.version?(this.earliest_presentation_time=a.readUint32(),this.first_offset=a.readUint32()):(this.earliest_presentation_time=a.readUint64(),this.first_offset=a.readUint64());a.readUint16();
this.references=[];for(var b=a.readUint16(),d=0;d<b;d++){var c={};this.references.push(c);var f=a.readUint32();c.reference_type=f>>31&1;c.referenced_size=2147483647&f;c.subsegment_duration=a.readUint32();f=a.readUint32();c.starts_with_SAP=f>>31&1;c.SAP_type=f>>28&7;c.SAP_delta_time=268435455&f}};c.SingleItemTypeReferenceBox=function(a,b,d,g){c.Box.call(this,a,b);this.hdr_size=d;this.start=g};c.SingleItemTypeReferenceBox.prototype=new c.Box;c.SingleItemTypeReferenceBox.prototype.parse=function(a){this.from_item_ID=
a.readUint16();var b=a.readUint16();this.references=[];for(var d=0;d<b;d++)this.references[d]=a.readUint16()};c.SingleItemTypeReferenceBoxLarge=function(a,b,d,g){c.Box.call(this,a,b);this.hdr_size=d;this.start=g};c.SingleItemTypeReferenceBoxLarge.prototype=new c.Box;c.SingleItemTypeReferenceBoxLarge.prototype.parse=function(a){this.from_item_ID=a.readUint32();var b=a.readUint16();this.references=[];for(var d=0;d<b;d++)this.references[d]=a.readUint32()};c.ssixBox.prototype.parse=function(a){this.parseFullHeader(a);
this.subsegments=[];for(var b=a.readUint32(),d=0;d<b;d++){var c={};this.subsegments.push(c);c.ranges=[];for(var f=a.readUint32(),e=0;e<f;e++){var h={};c.ranges.push(h);h.level=a.readUint8();h.range_size=a.readUint24()}}};c.stcoBox.prototype.parse=function(a){this.parseFullHeader(a);var b=a.readUint32();0===this.version&&(this.chunk_offsets=a.readUint32Array(b))};c.stdpBox.prototype.parse=function(a){this.parseFullHeader(a);var b=(this.size-this.hdr_size)/2;this.priority=[];for(var d=0;d<b;d++)this.priority[d]=
a.readUint16()};c.striBox.prototype.parse=function(a){this.parseFullHeader(a);this.switch_group=a.readUint16();this.alternate_group=a.readUint16();this.sub_track_id=a.readUint32();var b=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var d=0;d<b;d++)this.attribute_list[d]=a.readUint32()};c.stscBox.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),b=a.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(d=0;d<b;d++)this.first_chunk.push(a.readUint32()),
this.samples_per_chunk.push(a.readUint32()),this.sample_description_index.push(a.readUint32())};c.stsdBox=function(a){c.FullBox.call(this,"stsd",a);this.entries=[]};c.stsdBox.prototype=new c.FullBox;c.stsdBox.prototype.parse=function(a){var b,d,g;this.parseFullHeader(a);var e=a.readUint32();for(b=1;b<=e&&(d=c.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),d.code===c.OK);b++)c[d.type+"SampleEntry"]?(g=new c[d.type+"SampleEntry"](d.size),g.hdr_size=d.hdr_size,g.start=d.start):(f.warn("BoxParser",
"Unknown sample entry type: "+d.type),g=new c.SampleEntry(d.type,d.size,d.hdr_size,d.start)),g.write===c.SampleEntry.prototype.write&&(f.warn("BoxParser",g.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),g.parseDataAndRewind(a)),g.parse(a),this.entries.push(g)};c.stsgBox.prototype.parse=function(a){this.parseFullHeader(a);this.grouping_type=a.readUint32();var b=a.readUint16();this.group_description_index=[];for(var d=0;d<b;d++)this.group_description_index[d]=
a.readUint32()};c.stshBox.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),b=a.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(d=0;d<b;d++)this.shadowed_sample_numbers.push(a.readUint32()),this.sync_sample_numbers.push(a.readUint32())};c.stssBox.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),d=a.readUint32(),0===this.version)for(this.sample_numbers=[],b=0;b<d;b++)this.sample_numbers.push(a.readUint32())};c.stszBox.prototype.parse=
function(a){if(this.parseFullHeader(a),this.sample_sizes=[],0===this.version)if(this.sample_size=a.readUint32(),this.sample_count=a.readUint32(),0===this.sample_size)this.sample_sizes=a.readUint32Array(this.sample_count);else for(a=0;a<this.sample_count;a++)this.sample_sizes[a]=this.sample_size};c.sttsBox.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),b=a.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(d=0;d<b;d++){this.sample_counts.push(a.readUint32());
var c=a.readInt32();0>c&&(f.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),c=1);this.sample_deltas.push(c)}};c.stviBox.prototype.parse=function(a){this.parseFullHeader(a);this.single_view_allowed=3&a.readUint32();this.stereo_scheme=a.readUint32();var b=a.readUint32();this.stereo_indication_type=a.readString(b);var d;for(this.boxes=[];a.getPosition()<this.start+this.size&&(d=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),d.code===c.OK);)b=
d.box,this.boxes.push(b),this[b.type]=b};c.stypBox.prototype.parse=function(a){c.ftypBox.prototype.parse.call(this,a)};c.stz2Box.prototype.parse=function(a){var b,d;if(this.parseFullHeader(a),this.sample_sizes=[],0===this.version)if(this.reserved=a.readUint24(),this.field_size=a.readUint8(),d=a.readUint32(),4===this.field_size)for(b=0;b<d;b+=2){var c=a.readUint8();this.sample_sizes[b]=c>>4&15;this.sample_sizes[b+1]=15&c}else if(8===this.field_size)for(b=0;b<d;b++)this.sample_sizes[b]=a.readUint8();
else if(16===this.field_size)for(b=0;b<d;b++)this.sample_sizes[b]=a.readUint16();else f.error("BoxParser","Error in length field in stz2 box")};c.subsBox.prototype.parse=function(a){var b,d,c;this.parseFullHeader(a);var f=a.readUint32();this.entries=[];for(b=0;b<f;b++){var e={};if(this.entries[b]=e,e.sample_delta=a.readUint32(),e.subsamples=[],c=a.readUint16(),0<c)for(d=0;d<c;d++){var h={};e.subsamples.push(h);1==this.version?h.size=a.readUint32():h.size=a.readUint16();h.priority=a.readUint8();h.discardable=
a.readUint8();h.codec_specific_parameters=a.readUint32()}}};c.tfdtBox.prototype.parse=function(a){this.parseFullHeader(a);1==this.version?this.baseMediaDecodeTime=a.readUint64():this.baseMediaDecodeTime=a.readUint32()};c.tfhdBox.prototype.parse=function(a){var b=0;this.parseFullHeader(a);this.track_id=a.readUint32();this.size-this.hdr_size>b&&this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=a.readUint64(),b+=8):this.base_data_offset=0;this.size-this.hdr_size>b&&this.flags&c.TFHD_FLAG_SAMPLE_DESC?
(this.default_sample_description_index=a.readUint32(),b+=4):this.default_sample_description_index=0;this.size-this.hdr_size>b&&this.flags&c.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=a.readUint32(),b+=4):this.default_sample_duration=0;this.size-this.hdr_size>b&&this.flags&c.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=a.readUint32(),b+=4):this.default_sample_size=0;this.size-this.hdr_size>b&&this.flags&c.TFHD_FLAG_SAMPLE_FLAGS?this.default_sample_flags=a.readUint32():this.default_sample_flags=
0};c.tfraBox.prototype.parse=function(a){this.parseFullHeader(a);this.track_ID=a.readUint32();a.readUint24();var b=a.readUint8();this.length_size_of_traf_num=b>>4&3;this.length_size_of_trun_num=b>>2&3;this.length_size_of_sample_num=3&b;this.entries=[];b=a.readUint32();for(var d=0;d<b;d++)1===this.version?(this.time=a.readUint64(),this.moof_offset=a.readUint64()):(this.time=a.readUint32(),this.moof_offset=a.readUint32()),this.traf_number=a["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=
a["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=a["readUint"+8*(this.length_size_of_sample_num+1)]()};c.tkhdBox.prototype.parse=function(a){this.parseFullHeader(a);1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint32());a.readUint32Array(2);
this.layer=a.readInt16();this.alternate_group=a.readInt16();this.volume=a.readInt16()>>8;a.readUint16();this.matrix=a.readInt32Array(9);this.width=a.readUint32();this.height=a.readUint32()};c.tmaxBox.prototype.parse=function(a){this.time=a.readUint32()};c.tminBox.prototype.parse=function(a){this.time=a.readUint32()};c.totlBox.prototype.parse=function(a){this.bytessent=a.readUint32()};c.tpayBox.prototype.parse=function(a){this.bytessent=a.readUint32()};c.tpylBox.prototype.parse=function(a){this.bytessent=
a.readUint64()};c.trefBox.prototype.parse=function(a){for(var b,d;a.getPosition()<this.start+this.size&&(b=c.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),b.code===c.OK);)d=new c.TrackReferenceTypeBox(b.type,b.size,b.hdr_size,b.start),d.write===c.Box.prototype.write&&"mdat"!==d.type&&(f.warn("BoxParser",d.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(a)),d.parse(a),this.boxes.push(d)};c.trepBox.prototype.parse=function(a){this.parseFullHeader(a);
this.track_ID=a.readUint32();for(this.boxes=[];a.getPosition()<this.start+this.size&&(ret=c.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),ret.code===c.OK);)box=ret.box,this.boxes.push(box)};c.trexBox.prototype.parse=function(a){this.parseFullHeader(a);this.track_id=a.readUint32();this.default_sample_description_index=a.readUint32();this.default_sample_duration=a.readUint32();this.default_sample_size=a.readUint32();this.default_sample_flags=a.readUint32()};c.trpyBox.prototype.parse=function(a){this.bytessent=
a.readUint64()};c.trunBox.prototype.parse=function(a){var b=0;if(this.parseFullHeader(a),this.sample_count=a.readUint32(),b+=4,this.size-this.hdr_size>b&&this.flags&c.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=a.readInt32(),b+=4):this.data_offset=0,this.size-this.hdr_size>b&&this.flags&c.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=a.readUint32(),b+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>
b)for(b=0;b<this.sample_count;b++)this.flags&c.TRUN_FLAGS_DURATION&&(this.sample_duration[b]=a.readUint32()),this.flags&c.TRUN_FLAGS_SIZE&&(this.sample_size[b]=a.readUint32()),this.flags&c.TRUN_FLAGS_FLAGS&&(this.sample_flags[b]=a.readUint32()),this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[b]=a.readUint32():this.sample_composition_time_offset[b]=a.readInt32())};c.tselBox.prototype.parse=function(a){this.parseFullHeader(a);this.switch_group=a.readUint32();
var b=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var d=0;d<b;d++)this.attribute_list[d]=a.readUint32()};c.txtCBox.prototype.parse=function(a){this.parseFullHeader(a);this.config=a.readCString()};c["url Box"].prototype.parse=function(a){this.parseFullHeader(a);1!==this.flags&&(this.location=a.readCString())};c["urn Box"].prototype.parse=function(a){this.parseFullHeader(a);this.name=a.readCString();0<this.size-this.hdr_size-this.name.length-1&&(this.location=a.readCString())};c.vmhdBox.prototype.parse=
function(a){this.parseFullHeader(a);this.graphicsmode=a.readUint16();this.opcolor=a.readUint16Array(3)};c.vttCBox.prototype.parse=function(a){this.text=a.readString(this.size-this.hdr_size)};c.Box.prototype.writeHeader=function(a,b){this.size+=8;this.size>k&&(this.size+=8);"uuid"===this.type&&(this.size+=16);f.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+a.getPosition()+(b||""));this.size>k?a.writeUint32(1):(this.sizePosition=a.getPosition(),a.writeUint32(this.size));
a.writeString(this.type,null,4);"uuid"===this.type&&a.writeUint8Array(this.uuid);this.size>k&&a.writeUint64(this.size)};c.FullBox.prototype.writeHeader=function(a){this.size+=4;c.Box.prototype.writeHeader.call(this,a," v="+this.version+" f="+this.flags);a.writeUint8(this.version);a.writeUint24(this.flags)};c.Box.prototype.write=function(a){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(a),a.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(a),
this.data&&a.writeUint8Array(this.data))};c.ContainerBox.prototype.write=function(a){this.size=0;this.writeHeader(a);for(var b=0;b<this.boxes.length;b++)this.boxes[b]&&(this.boxes[b].write(a),this.size+=this.boxes[b].size);f.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size);a.adjustUint32(this.sizePosition,this.size)};c.TrackReferenceTypeBox.prototype.write=function(a){this.size=4*this.track_ids.length;this.writeHeader(a);a.writeUint32Array(this.track_ids)};c.avcCBox.prototype.write=
function(a){var b;this.size=7;for(b=0;b<this.SPS.length;b++)this.size+=2+this.SPS[b].length;for(b=0;b<this.PPS.length;b++)this.size+=2+this.PPS[b].length;this.ext&&(this.size+=this.ext.length);this.writeHeader(a);a.writeUint8(this.configurationVersion);a.writeUint8(this.AVCProfileIndication);a.writeUint8(this.profile_compatibility);a.writeUint8(this.AVCLevelIndication);a.writeUint8(this.lengthSizeMinusOne+252);a.writeUint8(this.SPS.length+224);for(b=0;b<this.SPS.length;b++)a.writeUint16(this.SPS[b].length),
a.writeUint8Array(this.SPS[b]);a.writeUint8(this.PPS.length);for(b=0;b<this.PPS.length;b++)a.writeUint16(this.PPS[b].length),a.writeUint8Array(this.PPS[b]);this.ext&&a.writeUint8Array(this.ext)};c.co64Box.prototype.write=function(a){var b;this.flags=this.version=0;this.size=4+8*this.chunk_offsets.length;this.writeHeader(a);a.writeUint32(this.chunk_offsets.length);for(b=0;b<this.chunk_offsets.length;b++)a.writeUint64(this.chunk_offsets[b])};c.cslgBox.prototype.write=function(a){this.flags=this.version=
0;this.size=20;this.writeHeader(a);a.writeInt32(this.compositionToDTSShift);a.writeInt32(this.leastDecodeToDisplayDelta);a.writeInt32(this.greatestDecodeToDisplayDelta);a.writeInt32(this.compositionStartTime);a.writeInt32(this.compositionEndTime)};c.cttsBox.prototype.write=function(a){var b;this.flags=this.version=0;this.size=4+8*this.sample_counts.length;this.writeHeader(a);a.writeUint32(this.sample_counts.length);for(b=0;b<this.sample_counts.length;b++)a.writeUint32(this.sample_counts[b]),1===this.version?
a.writeInt32(this.sample_offsets[b]):a.writeUint32(this.sample_offsets[b])};c.drefBox.prototype.write=function(a){this.flags=this.version=0;this.size=4;this.writeHeader(a);a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++)this.entries[b].write(a),this.size+=this.entries[b].size;f.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size);a.adjustUint32(this.sizePosition,this.size)};c.elngBox.prototype.write=function(a){this.flags=this.version=0;this.size=this.extended_language.length;
this.writeHeader(a);a.writeString(this.extended_language)};c.elstBox.prototype.write=function(a){this.flags=this.version=0;this.size=4+12*this.entries.length;this.writeHeader(a);a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++){var d=this.entries[b];a.writeUint32(d.segment_duration);a.writeInt32(d.media_time);a.writeInt16(d.media_rate_integer);a.writeInt16(d.media_rate_fraction)}};c.emsgBox.prototype.write=function(a){this.flags=this.version=0;this.size=16+this.message_data.length+
(this.scheme_id_uri.length+1)+(this.value.length+1);this.writeHeader(a);a.writeCString(this.scheme_id_uri);a.writeCString(this.value);a.writeUint32(this.timescale);a.writeUint32(this.presentation_time_delta);a.writeUint32(this.event_duration);a.writeUint32(this.id);a.writeUint8Array(this.message_data)};c.ftypBox.prototype.write=function(a){this.size=8+4*this.compatible_brands.length;this.writeHeader(a);a.writeString(this.major_brand,null,4);a.writeUint32(this.minor_version);for(var b=0;b<this.compatible_brands.length;b++)a.writeString(this.compatible_brands[b],
null,4)};c.hdlrBox.prototype.write=function(a){this.size=20+this.name.length+1;this.flags=this.version=0;this.writeHeader(a);a.writeUint32(0);a.writeString(this.handler,null,4);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeCString(this.name)};c.kindBox.prototype.write=function(a){this.flags=this.version=0;this.size=this.schemeURI.length+1+(this.value.length+1);this.writeHeader(a);a.writeCString(this.schemeURI);a.writeCString(this.value)};c.mdhdBox.prototype.write=function(a){this.size=
20;this.version=this.flags=0;this.writeHeader(a);a.writeUint32(this.creation_time);a.writeUint32(this.modification_time);a.writeUint32(this.timescale);a.writeUint32(this.duration);a.writeUint16(this.language);a.writeUint16(0)};c.mehdBox.prototype.write=function(a){this.flags=this.version=0;this.size=4;this.writeHeader(a);a.writeUint32(this.fragment_duration)};c.mfhdBox.prototype.write=function(a){this.flags=this.version=0;this.size=4;this.writeHeader(a);a.writeUint32(this.sequence_number)};c.mvhdBox.prototype.write=
function(a){this.flags=this.version=0;this.size=96;this.writeHeader(a);a.writeUint32(this.creation_time);a.writeUint32(this.modification_time);a.writeUint32(this.timescale);a.writeUint32(this.duration);a.writeUint32(this.rate);a.writeUint16(this.volume<<8);a.writeUint16(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32Array(this.matrix);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32(this.next_track_id)};c.SampleEntry.prototype.writeHeader=
function(a){this.size=8;c.Box.prototype.writeHeader.call(this,a);a.writeUint8(0);a.writeUint8(0);a.writeUint8(0);a.writeUint8(0);a.writeUint8(0);a.writeUint8(0);a.writeUint16(this.data_reference_index)};c.SampleEntry.prototype.writeFooter=function(a){for(var b=0;b<this.boxes.length;b++)this.boxes[b].write(a),this.size+=this.boxes[b].size;f.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size);a.adjustUint32(this.sizePosition,this.size)};c.SampleEntry.prototype.write=function(a){this.writeHeader(a);
a.writeUint8Array(this.data);this.size+=this.data.length;f.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size);a.adjustUint32(this.sizePosition,this.size)};c.VisualSampleEntry.prototype.write=function(a){this.writeHeader(a);this.size+=70;a.writeUint16(0);a.writeUint16(0);a.writeUint32(0);a.writeUint32(0);a.writeUint32(0);a.writeUint16(this.width);a.writeUint16(this.height);a.writeUint32(this.horizresolution);a.writeUint32(this.vertresolution);a.writeUint32(0);a.writeUint16(this.frame_count);
a.writeString(this.compressorname,null,32);a.writeUint16(this.depth);a.writeInt16(-1);this.writeFooter(a)};c.AudioSampleEntry.prototype.write=function(a){this.writeHeader(a);this.size+=20;a.writeUint32(0);a.writeUint32(0);a.writeUint16(this.channel_count);a.writeUint16(this.samplesize);a.writeUint16(0);a.writeUint16(0);a.writeUint32(this.samplerate<<16);this.writeFooter(a)};c.SampleGroupEntry.prototype.write=function(a){a.writeUint8Array(this.data)};c.sbgpBox.prototype.write=function(a){this.version=
1;this.flags=0;this.size=12+8*this.entries.length;this.writeHeader(a);a.writeString(this.grouping_type,null,4);a.writeUint32(this.grouping_type_parameter);a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++){var d=this.entries[b];a.writeInt32(d.sample_count);a.writeInt32(d.group_description_index)}};c.sgpdBox.prototype.write=function(a){var b;this.flags=0;this.size=12;for(b=0;b<this.entries.length;b++){var d=this.entries[b];1===this.version&&(0===this.default_length&&(this.size+=
4),this.size+=d.data.length)}this.writeHeader(a);a.writeString(this.grouping_type,null,4);1===this.version&&a.writeUint32(this.default_length);2<=this.version&&a.writeUint32(this.default_sample_description_index);a.writeUint32(this.entries.length);for(b=0;b<this.entries.length;b++)d=this.entries[b],1===this.version&&0===this.default_length&&a.writeUint32(d.description_length),d.write(a)};c.sidxBox.prototype.write=function(a){this.flags=this.version=0;this.size=20+12*this.references.length;this.writeHeader(a);
a.writeUint32(this.reference_ID);a.writeUint32(this.timescale);a.writeUint32(this.earliest_presentation_time);a.writeUint32(this.first_offset);a.writeUint16(0);a.writeUint16(this.references.length);for(var b=0;b<this.references.length;b++){var d=this.references[b];a.writeUint32(d.reference_type<<31|d.referenced_size);a.writeUint32(d.subsegment_duration);a.writeUint32(d.starts_with_SAP<<31|d.SAP_type<<28|d.SAP_delta_time)}};c.stcoBox.prototype.write=function(a){this.flags=this.version=0;this.size=
4+4*this.chunk_offsets.length;this.writeHeader(a);a.writeUint32(this.chunk_offsets.length);a.writeUint32Array(this.chunk_offsets)};c.stscBox.prototype.write=function(a){var b;this.flags=this.version=0;this.size=4+12*this.first_chunk.length;this.writeHeader(a);a.writeUint32(this.first_chunk.length);for(b=0;b<this.first_chunk.length;b++)a.writeUint32(this.first_chunk[b]),a.writeUint32(this.samples_per_chunk[b]),a.writeUint32(this.sample_description_index[b])};c.stsdBox.prototype.write=function(a){var b;
this.size=this.flags=this.version=0;this.writeHeader(a);a.writeUint32(this.entries.length);this.size+=4;for(b=0;b<this.entries.length;b++)this.entries[b].write(a),this.size+=this.entries[b].size;f.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size);a.adjustUint32(this.sizePosition,this.size)};c.stshBox.prototype.write=function(a){var b;this.flags=this.version=0;this.size=4+8*this.shadowed_sample_numbers.length;this.writeHeader(a);a.writeUint32(this.shadowed_sample_numbers.length);
for(b=0;b<this.shadowed_sample_numbers.length;b++)a.writeUint32(this.shadowed_sample_numbers[b]),a.writeUint32(this.sync_sample_numbers[b])};c.stssBox.prototype.write=function(a){this.flags=this.version=0;this.size=4+4*this.sample_numbers.length;this.writeHeader(a);a.writeUint32(this.sample_numbers.length);a.writeUint32Array(this.sample_numbers)};c.stszBox.prototype.write=function(a){var b,d=!0;if(this.version=0,this.flags=0,0<this.sample_sizes.length)for(b=0;b+1<this.sample_sizes.length;){if(this.sample_sizes[b+
1]!==this.sample_sizes[0]){d=!1;break}b++}else d=!1;this.size=8;d||(this.size+=4*this.sample_sizes.length);this.writeHeader(a);d?a.writeUint32(this.sample_sizes[0]):a.writeUint32(0);a.writeUint32(this.sample_sizes.length);d||a.writeUint32Array(this.sample_sizes)};c.sttsBox.prototype.write=function(a){var b;this.flags=this.version=0;this.size=4+8*this.sample_counts.length;this.writeHeader(a);a.writeUint32(this.sample_counts.length);for(b=0;b<this.sample_counts.length;b++)a.writeUint32(this.sample_counts[b]),
a.writeUint32(this.sample_deltas[b])};c.tfdtBox.prototype.write=function(a){this.flags=this.version=0;this.size=4;1===this.version&&(this.size+=4);this.writeHeader(a);1===this.version?a.writeUint64(this.baseMediaDecodeTime):a.writeUint32(this.baseMediaDecodeTime)};c.tfhdBox.prototype.write=function(a){this.version=0;this.size=4;this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8);this.flags&c.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4);this.flags&c.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4);this.flags&c.TFHD_FLAG_SAMPLE_SIZE&&
(this.size+=4);this.flags&c.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4);this.writeHeader(a);a.writeUint32(this.track_id);this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET&&a.writeUint64(this.base_data_offset);this.flags&c.TFHD_FLAG_SAMPLE_DESC&&a.writeUint32(this.default_sample_description_index);this.flags&c.TFHD_FLAG_SAMPLE_DUR&&a.writeUint32(this.default_sample_duration);this.flags&c.TFHD_FLAG_SAMPLE_SIZE&&a.writeUint32(this.default_sample_size);this.flags&c.TFHD_FLAG_SAMPLE_FLAGS&&a.writeUint32(this.default_sample_flags)};
c.tkhdBox.prototype.write=function(a){this.version=0;this.size=80;this.writeHeader(a);a.writeUint32(this.creation_time);a.writeUint32(this.modification_time);a.writeUint32(this.track_id);a.writeUint32(0);a.writeUint32(this.duration);a.writeUint32(0);a.writeUint32(0);a.writeInt16(this.layer);a.writeInt16(this.alternate_group);a.writeInt16(this.volume<<8);a.writeUint16(0);a.writeInt32Array(this.matrix);a.writeUint32(this.width);a.writeUint32(this.height)};c.trexBox.prototype.write=function(a){this.flags=
this.version=0;this.size=20;this.writeHeader(a);a.writeUint32(this.track_id);a.writeUint32(this.default_sample_description_index);a.writeUint32(this.default_sample_duration);a.writeUint32(this.default_sample_size);a.writeUint32(this.default_sample_flags)};c.trunBox.prototype.write=function(a){this.version=0;this.size=4;this.flags&c.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4);this.flags&c.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4);this.flags&c.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length);
this.flags&c.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length);this.flags&c.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length);this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length);this.writeHeader(a);a.writeUint32(this.sample_count);this.flags&c.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=a.getPosition(),a.writeInt32(this.data_offset));this.flags&c.TRUN_FLAGS_FIRST_FLAG&&a.writeUint32(this.first_sample_flags);for(var b=0;b<this.sample_count;b++)this.flags&
c.TRUN_FLAGS_DURATION&&a.writeUint32(this.sample_duration[b]),this.flags&c.TRUN_FLAGS_SIZE&&a.writeUint32(this.sample_size[b]),this.flags&c.TRUN_FLAGS_FLAGS&&a.writeUint32(this.sample_flags[b]),this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?a.writeUint32(this.sample_composition_time_offset[b]):a.writeInt32(this.sample_composition_time_offset[b]))};c["url Box"].prototype.write=function(a){this.version=0;this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0);
this.writeHeader(a);this.location&&a.writeCString(this.location)};c["urn Box"].prototype.write=function(a){this.flags=this.version=0;this.size=this.name.length+1+(this.location?this.location.length+1:0);this.writeHeader(a);a.writeCString(this.name);this.location&&a.writeCString(this.location)};c.vmhdBox.prototype.write=function(a){this.version=0;this.flags=1;this.size=8;this.writeHeader(a);a.writeUint16(this.graphicsmode);a.writeUint16Array(this.opcolor)};c.cttsBox.prototype.unpack=function(a){var b,
d,c;for(b=c=0;b<this.sample_counts.length;b++)for(d=0;d<this.sample_counts[b];d++)a[c].pts=a[c].dts+this.sample_offsets[b],c++};c.sttsBox.prototype.unpack=function(a){var b,d,c;for(b=c=0;b<this.sample_counts.length;b++)for(d=0;d<this.sample_counts[b];d++)0===c?a[c].dts=0:a[c].dts=a[c-1].dts+this.sample_deltas[b],c++};c.stcoBox.prototype.unpack=function(a){var b;for(b=0;b<this.chunk_offsets.length;b++)a[b].offset=this.chunk_offsets[b]};c.stscBox.prototype.unpack=function(a){var b,d,c,f,e;for(b=e=f=
0;b<this.first_chunk.length;b++)for(d=0;d<(b+1<this.first_chunk.length?this.first_chunk[b+1]:1/0);d++)for(e++,c=0;c<this.samples_per_chunk[b];c++){if(!a[f])return;a[f].description_index=this.sample_description_index[b];a[f].chunk_index=e;f++}};c.stszBox.prototype.unpack=function(a){var b;for(b=0;b<this.sample_sizes.length;b++)a[b].size=this.sample_sizes[b]};var h=function(a){this.stream=a;this.boxes=[];this.mdats=[];this.moofs=[];this.moovStartFound=this.isProgressive=!1};h.prototype.parse=function(){var a,
b;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;break}if(this.saveParsePosition&&this.saveParsePosition(),a=c.parseOneBox(this.stream,!1),a.code===c.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox&&this.processIncompleteBox(a))continue;break}switch(b=a.box,this.boxes.push(b),b.type){case "mdat":this.mdats.push(b);break;case "moof":this.moofs.push(b);break;case "moov":this.moovStartFound=
!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[b.type]&&f.warn("ISOFile","Duplicate Box of type: "+b.type+", overriding previous occurrence"),this[b.type]=b}this.updateUsedBytes&&this.updateUsedBytes(b,a)}};h.prototype.getBox=function(a){a=this.getBoxes(a,!0);return a.length?a[0]:null};h.prototype.getBoxes=function(a,b){var d=[];return h._sweep.call(this,a,d,b),d};h._sweep=function(a,b,d){this.type&&this.type==a&&b.push(this);for(var c in this.boxes){if(b.length&&d)break;
h._sweep.call(this.boxes[c],a,b,d)}};"undefined"!=typeof exports&&(exports.ISOFile=h);h.prototype.lastBoxStartPosition=0;h.prototype.parsingMdat=null;h.prototype.nextParsePosition=0;h.prototype.discardMdatData=!1;h.prototype.processIncompleteBox=function(a){var b,d,g;return"mdat"===a.type?(b=new c[a.type+"Box"](a.size),this.parsingMdat=b,this.boxes.push(b),this.mdats.push(b),b.start=a.start,b.hdr_size=a.hdr_size,this.stream.addUsedBytes(b.hdr_size),this.lastBoxStartPosition=b.start+b.size,g=this.stream.seek(b.start+
b.size,!1,this.discardMdatData),g?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=b.start+b.size,!1)):("moov"===a.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),d=!!this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer(),d?(this.nextParsePosition=this.stream.getEndPosition(),!0):(a.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+
a.size:this.nextParsePosition=this.stream.getEndPosition(),!1))};h.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat};h.prototype.processIncompleteMdat=function(){var a,b;return a=this.parsingMdat,b=this.stream.seek(a.start+a.size,!1,this.discardMdatData),b?(f.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)};h.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,
!0,this.discardMdatData)};h.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()};h.prototype.updateUsedBytes=function(a,b){this.stream.addUsedBytes&&("mdat"===a.type?(this.stream.addUsedBytes(a.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(a.size-a.hdr_size)):this.stream.addUsedBytes(a.size))};h.prototype.add=c.Box.prototype.add;h.prototype.init=function(){var a=this.add("moov");return a.add("mvhd").set("timescale",600).set("rate",1).set("creation_time",
0).set("modification_time",0).set("duration",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("next_track_id",1),a.add("mvex"),this};h.prototype.addTrack=function(a){this.moov||this.init();a=a||{};a.width=a.width||320;a.height=a.height||320;a.id=a.id||this.moov.mvhd.next_track_id;a.type=a.type||"avc1";var b=this.moov.add("trak");this.moov.mvhd.next_track_id=a.id+1;b.add("tkhd").set("creation_time",0).set("modification_time",0).set("track_id",a.id).set("duration",0).set("layer",0).set("alternate_group",
0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",a.width).set("height",a.height);var d=b.add("mdia");d.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",a.timescale||1).set("duration",0).set("language",a.language||0);d.add("hdlr").set("handler",a.hdlr||"vide").set("name",a.name||"Track created with MP4Box.js");d.add("elng").set("extended_language",a.language||"fr-FR");for(var g=d.add("minf"),f=new c[a.type+"SampleEntry"],e="",h=0;h<c.sampleEntryCodes.length;h++){var k=
c.sampleEntryCodes[h];if(-1<k.types.indexOf(a.type)){e=k.prefix;break}}switch(e){case "Visual":g.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]);f.set("width",a.width).set("height",a.height).set("horizresolution",4718592).set("vertresolution",4718592).set("frame_count",1).set("compressorname",a.type+" Compressor").set("depth",24);f.add("avcC").set("SPS",[]).set("PPS",[]).set("configurationVersion",0).set("AVCProfileIndication",0).set("profile_compatibility",0).set("AVCLevelIndication",0).set("lengthSizeMinusOne",
0);break;case "Audio":g.add("smhd");break;case "Hint":g.add("hmhd");break;case "Subtitle":g.add("sthd");break;case "Metadata":g.add("nmhd");break;case "System":g.add("nmhd");break;default:g.add("nmhd")}g.add("dinf").add("dref").addEntry((new c["url Box"]).set("flags",1));d=d.add("stbl");return d.add("stsd").addEntry(f),d.add("stts").set("sample_counts",[]).set("sample_deltas",[]),d.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),this.moov.mvex.add("trex").set("track_id",
a.id).set("default_sample_description_index",a.default_sample_description_index||0).set("default_sample_duration",a.default_sample_duration||0).set("default_sample_size",a.default_sample_size||0).set("default_sample_flags",a.default_sample_flags||0),b};h.prototype.getBuffer=function(){var a=new e;return a.endianness=e.BIG_ENDIAN,this.write(a),a.buffer};h.prototype.addSample=function(a,b,d){};h.prototype.lastMoofIndex=0;h.prototype.samplesDataSize=0;h.prototype.resetTables=function(){var a;this.initial_duration=
this.moov.mvhd.duration;for(a=this.moov.mvhd.duration=0;a<this.moov.traks.length;a++){var b=this.moov.traks[a];b.tkhd.duration=0;b.mdia.mdhd.duration=0;var d=b.mdia.minf.stbl.stco||b.mdia.minf.stbl.co64;d.chunk_offsets=[];d=b.mdia.minf.stbl.stsc;d.first_chunk=[];d.samples_per_chunk=[];d.sample_description_index=[];d=b.mdia.minf.stbl.stsz||b.mdia.minf.stbl.stz2;d.sample_sizes=[];d=b.mdia.minf.stbl.stts;d.sample_counts=[];d.sample_deltas=[];(d=b.mdia.minf.stbl.ctts)&&(d.sample_counts=[],d.sample_offsets=
[]);d=b.mdia.minf.stbl.stss;d=b.mdia.minf.stbl.boxes.indexOf(d);-1!=d&&(b.mdia.minf.stbl.boxes[d]=null)}};h.initSampleGroups=function(a,b,d,c,f){function g(a,b,d){this.grouping_type=a;this.grouping_type_parameter=b;this.sbgp=d;this.entry_index=this.last_sample_in_run=-1}var e,p;b&&(b.sample_groups_info=[]);a.sample_groups_info||(a.sample_groups_info=[]);for(p=0;p<d.length;p++){var h=d[p].grouping_type+"/"+d[p].grouping_type_parameter;var k=new g(d[p].grouping_type,d[p].grouping_type_parameter,d[p]);
b&&(b.sample_groups_info[h]=k);a.sample_groups_info[h]||(a.sample_groups_info[h]=k);for(e=0;e<c.length;e++)c[e].grouping_type===d[p].grouping_type&&(k.description=c[e],k.description.used=!0);if(f)for(e=0;e<f.length;e++)f[e].grouping_type===d[p].grouping_type&&(k.fragment_description=f[e],k.fragment_description.used=!0,k.is_fragment=!0)}if(b){if(f)for(p=0;p<f.length;p++)!f[p].used&&2<=f[p].version&&(h=f[p].grouping_type+"/0",k=new g(f[p].grouping_type,0),k.is_fragment=!0,b.sample_groups_info[h]||(b.sample_groups_info[h]=
k))}else for(p=0;p<c.length;p++)!c[p].used&&2<=c[p].version&&(h=c[p].grouping_type+"/0",k=new g(c[p].grouping_type,0),a.sample_groups_info[h]||(a.sample_groups_info[h]=k))};h.setSampleGroupProperties=function(a,b,d,c){var g,f;b.sample_groups=[];for(g in c)if(b.sample_groups[g]={},b.sample_groups[g].grouping_type=c[g].grouping_type,b.sample_groups[g].grouping_type_parameter=c[g].grouping_type_parameter,d>=c[g].last_sample_in_run&&(0>c[g].last_sample_in_run&&(c[g].last_sample_in_run=0),c[g].entry_index++,
c[g].entry_index<=c[g].sbgp.entries.length-1&&(c[g].last_sample_in_run+=c[g].sbgp.entries[c[g].entry_index].sample_count)),c[g].entry_index<=c[g].sbgp.entries.length-1?b.sample_groups[g].group_description_index=c[g].sbgp.entries[c[g].entry_index].group_description_index:b.sample_groups[g].group_description_index=-1,0!==b.sample_groups[g].group_description_index)a=c[g].fragment_description?c[g].fragment_description:c[g].description,0<b.sample_groups[g].group_description_index?(f=65535<b.sample_groups[g].group_description_index?
(b.sample_groups[g].group_description_index>>16)-1:b.sample_groups[g].group_description_index-1,a&&0<=f&&(b.sample_groups[g].description=a.entries[f])):a&&2<=a.version&&0<a.default_group_description_index&&(b.sample_groups[g].description=a.entries[a.default_group_description_index-1])};h.process_sdtp=function(a,b,d){b&&(a?(b.is_leading=a.is_leading[d],b.depends_on=a.sample_depends_on[d],b.is_depended_on=a.sample_is_depended_on[d],b.has_redundancy=a.sample_has_redundancy[d]):(b.is_leading=0,b.depends_on=
0,b.is_depended_on=0,b.has_redundancy=0))};h.prototype.buildSampleLists=function(){var a,b,d,c,f,e,k,l,m,u,v,L,n,M,A,r,t,w,y,x,B,z,C,D,E;for(a=0;a<this.moov.traks.length;a++)if(d=this.moov.traks[a],d.samples=[],d.samples_duration=0,d.samples_size=0,c=d.mdia.minf.stbl.stco||d.mdia.minf.stbl.co64,f=d.mdia.minf.stbl.stsc,e=d.mdia.minf.stbl.stsz||d.mdia.minf.stbl.stz2,k=d.mdia.minf.stbl.stts,l=d.mdia.minf.stbl.ctts,m=d.mdia.minf.stbl.stss,u=d.mdia.minf.stbl.stsd,v=d.mdia.minf.stbl.subs,M=d.mdia.minf.stbl.stdp,
L=d.mdia.minf.stbl.sbgps,n=d.mdia.minf.stbl.sgpds,x=-1,B=-1,z=-1,C=-1,D=0,E=0,h.initSampleGroups(d,null,L,n),"undefined"!=typeof e){for(b=0;b<e.sample_sizes.length;b++){var q={};q.number=b;q.track_id=d.tkhd.track_id;q.timescale=d.mdia.mdhd.timescale;q.alreadyRead=0;d.samples[b]=q;q.size=e.sample_sizes[b];d.samples_size+=q.size;0===b?(r=1,A=0,q.chunk_index=r,q.chunk_run_index=A,y=f.samples_per_chunk[A],w=0,t=A+1<f.first_chunk.length?f.first_chunk[A+1]-1:1/0):b<y?(q.chunk_index=r,q.chunk_run_index=
A):(r++,q.chunk_index=r,w=0,r<=t||(A++,t=A+1<f.first_chunk.length?f.first_chunk[A+1]-1:1/0),q.chunk_run_index=A,y+=f.samples_per_chunk[A]);q.description_index=f.sample_description_index[q.chunk_run_index]-1;q.description=u.entries[q.description_index];q.offset=c.chunk_offsets[q.chunk_index-1]+w;w+=q.size;b>x&&(B++,0>x&&(x=0),x+=k.sample_counts[B]);0<b?(d.samples[b-1].duration=k.sample_deltas[B],d.samples_duration+=d.samples[b-1].duration,q.dts=d.samples[b-1].dts+d.samples[b-1].duration):q.dts=0;l?
(b>=z&&(C++,0>z&&(z=0),z+=l.sample_counts[C]),q.cts=d.samples[b].dts+l.sample_offsets[C]):q.cts=q.dts;m?b==m.sample_numbers[D]-1?(q.is_sync=!0,D++):q.is_sync=!1:q.is_sync=!0;h.process_sdtp(d.mdia.minf.stbl.sdtp,q,q.number);M?q.degradation_priority=M.priority[b]:q.degradation_priority=0;v&&v.entries[0].sample_delta+E==b&&(q.subsamples=v.entries[0].subsamples,E+=v.entries[0].sample_delta);(0<L.length||0<n.length)&&h.setSampleGroupProperties(d,q,b,d.sample_groups_info)}0<b&&(d.samples[b-1].duration=
Math.max(d.mdia.mdhd.duration-d.samples[b-1].dts,0),d.samples_duration+=d.samples[b-1].duration)}};h.prototype.updateSampleLists=function(){var a,b,d;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;)if(d=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==d.type){var g=d;for(a=0;a<g.trafs.length;a++){var f=g.trafs[a];var e=this.getTrackById(f.tfhd.track_id);var k=this.getTrexById(f.tfhd.track_id);var l=f.tfhd.flags&c.TFHD_FLAG_SAMPLE_DESC?f.tfhd.default_sample_description_index:
k?k.default_sample_description_index:1;var m=f.tfhd.flags&c.TFHD_FLAG_SAMPLE_DUR?f.tfhd.default_sample_duration:k?k.default_sample_duration:0;var u=f.tfhd.flags&c.TFHD_FLAG_SAMPLE_SIZE?f.tfhd.default_sample_size:k?k.default_sample_size:0;var v=f.tfhd.flags&c.TFHD_FLAG_SAMPLE_FLAGS?f.tfhd.default_sample_flags:k?k.default_sample_flags:0;f.sample_number=0;0<f.sbgps.length&&h.initSampleGroups(e,f,f.sbgps,e.mdia.minf.stbl.sgpds,f.sgpds);for(k=0;k<f.truns.length;k++){var r=f.truns[k];for(b=0;b<r.sample_count;b++){var n=
{};n.number_in_traf=f.sample_number;f.sample_number++;n.number=e.samples.length;f.first_sample_index=e.samples.length;e.samples.push(n);n.track_id=e.tkhd.track_id;n.timescale=e.mdia.mdhd.timescale;n.description_index=l-1;n.description=e.mdia.minf.stbl.stsd.entries[n.description_index];n.size=u;r.flags&c.TRUN_FLAGS_SIZE&&(n.size=r.sample_size[b]);e.samples_size+=n.size;n.duration=m;r.flags&c.TRUN_FLAGS_DURATION&&(n.duration=r.sample_duration[b]);e.samples_duration+=n.duration;e.first_traf_merged||
0<b?n.dts=e.samples[e.samples.length-2].dts+e.samples[e.samples.length-2].duration:(f.tfdt?n.dts=f.tfdt.baseMediaDecodeTime:n.dts=0,e.first_traf_merged=!0);n.cts=n.dts;r.flags&c.TRUN_FLAGS_CTS_OFFSET&&(n.cts=n.dts+r.sample_composition_time_offset[b]);var t=v;r.flags&c.TRUN_FLAGS_FLAGS?t=r.sample_flags[b]:0===b&&r.flags&c.TRUN_FLAGS_FIRST_FLAG&&(t=r.first_sample_flags);n.is_sync=!(t>>16&1);n.is_leading=t>>26&3;n.depends_on=t>>24&3;n.is_depended_on=t>>22&3;n.has_redundancy=t>>20&3;n.degradation_priority=
65535&t;h.process_sdtp(f.sdtp,n,n.number_in_traf);var w=!!(f.tfhd.flags&c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF);t=!!(r.flags&c.TRUN_FLAGS_DATA_OFFSET);w=f.tfhd.flags&c.TFHD_FLAG_BASE_DATA_OFFSET?f.tfhd.base_data_offset:w?g.start:0===k?g.start:x;0===k&&0===b?t?n.offset=w+r.data_offset:n.offset=w:n.offset=x;var x=n.offset+n.size;(0<f.sbgps.length||0<f.sgpds.length||0<e.mdia.minf.stbl.sbgps.length||0<e.mdia.minf.stbl.sgpds.length)&&h.setSampleGroupProperties(e,n,n.number_in_traf,f.sample_groups_info)}}if(f.subs)for(e.has_fragment_subsamples=
!0,l=f.first_sample_index,k=0;k<f.subs.entries.length;k++)l+=f.subs.entries[k].sample_delta,n=e.samples[l-1],n.subsamples=f.subs.entries[k].subsamples}}};h.prototype.getSample=function(a,b){var d=a.samples[b];if(!this.moov)return null;if(d.data){if(d.alreadyRead==d.size)return d}else d.data=new Uint8Array(d.size),d.alreadyRead=0,this.samplesDataSize+=d.size,f.debug("ISOFile","Allocating sample #"+b+" on track #"+a.tkhd.track_id+" of size "+d.size+" (total: "+this.samplesDataSize+")");a=this.stream.findPosition(!0,
d.offset+d.alreadyRead,!1);if(-1<a){a=this.stream.buffers[a];var c=a.byteLength-(d.offset+d.alreadyRead-a.fileStart);return d.size-d.alreadyRead<=c?(f.debug("ISOFile","Getting sample #"+b+" data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-a.fileStart)+" read size: "+(d.size-d.alreadyRead)+" full size: "+d.size+")"),e.memcpy(d.data.buffer,d.alreadyRead,a,d.offset+d.alreadyRead-a.fileStart,d.size-d.alreadyRead),a.usedBytes+=d.size-d.alreadyRead,this.stream.logBufferLevel(),d.alreadyRead=
d.size,d):(f.debug("ISOFile","Getting sample #"+b+" partial data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-a.fileStart)+" read size: "+c+" full size: "+d.size+")"),e.memcpy(d.data.buffer,d.alreadyRead,a,d.offset+d.alreadyRead-a.fileStart,c),d.alreadyRead+=c,a.usedBytes+=c,this.stream.logBufferLevel(),null)}return null};h.prototype.releaseSample=function(a,b){a=a.samples[b];return a.data?(this.samplesDataSize-=a.size,a.data=null,a.alreadyRead=0,a.size):0};h.prototype.getAllocatedSampleDataSize=
function(){return this.samplesDataSize};h.prototype.getCodecs=function(){var a,b="";for(a=0;a<this.moov.traks.length;a++){var d=this.moov.traks[a];0<a&&(b+=",");b+=d.mdia.minf.stbl.stsd.entries[0].getCodec()}return b};h.prototype.getTrexById=function(a){var b;if(!this.moov||!this.moov.mvex)return null;for(b=0;b<this.moov.mvex.trexs.length;b++){var d=this.moov.mvex.trexs[b];if(d.track_id==a)return d}return null};h.prototype.getTrackById=function(a){if(void 0===this.moov)return null;for(var b=0;b<this.moov.traks.length;b++){var d=
this.moov.traks[b];if(d.tkhd.track_id==a)return d}return null};h.prototype.items=[];h.prototype.itemsDataSize=0;h.prototype.flattenItemInfo=function(){var a,b,d=this.items,c=this.meta;if(null!==c&&void 0!==c&&void 0!==c.hdlr&&void 0!==c.iinf){for(a=0;a<c.iinf.item_infos.length;a++){var e={};e.id=c.iinf.item_infos[a].item_ID;d[e.id]=e;e.ref_to=[];e.name=c.iinf.item_infos[a].item_name;0<c.iinf.item_infos[a].protection_index&&(e.protection=c.ipro.protections[c.iinf.item_infos[a].protection_index-1]);
c.iinf.item_infos[a].item_type?e.type=c.iinf.item_infos[a].item_type:e.type="mime";e.content_type=c.iinf.item_infos[a].content_type;e.content_encoding=c.iinf.item_infos[a].content_encoding}if(c.iloc)for(a=0;a<c.iloc.items.length;a++){var h=c.iloc.items[a];if(e=d[h.item_ID],0!==h.data_reference_index&&(f.warn("Item storage with reference to other files: not supported"),e.source=c.dinf.boxes[h.data_reference_index-1]),void 0!==h.construction_method)f.warn("Item storage with construction_method : not supported");
else for(e.extents=[],b=e.size=0;b<h.extents.length;b++)e.extents[b]={},e.extents[b].offset=h.extents[b].extent_offset+h.base_offset,e.extents[b].length=h.extents[b].extent_length,e.extents[b].alreadyRead=0,e.size+=e.extents[b].length}if(c.pitm&&(d[c.pitm.item_id].primary=!0),c.iref)for(a=0;a<c.iref.references.length;a++)for(e=c.iref.references[a],b=0;b<e.references.length;b++)d[e.from_item_ID].ref_to.push({type:e.type,id:e.references[b]})}};h.prototype.getItem=function(a){var b;if(!this.meta)return null;
if(b=this.items[a],!b.data&&b.size)b.data=new Uint8Array(b.size),b.alreadyRead=0,this.itemsDataSize+=b.size,f.debug("ISOFile","Allocating item #"+a+" of size "+b.size+" (total: "+this.itemsDataSize+")");else if(b.alreadyRead===b.size)return b;for(var d=0;d<b.extents.length;d++){var c=b.extents[d];if(c.alreadyRead!==c.length){var h=this.stream.findPosition(!0,c.offset+c.alreadyRead,!1);if(!(-1<h))return null;h=this.stream.buffers[h];var k=h.byteLength-(c.offset+c.alreadyRead-h.fileStart);if(!(c.length-
c.alreadyRead<=k))return f.debug("ISOFile","Getting item #"+a+" extent #"+d+" partial data (alreadyRead: "+c.alreadyRead+" offset: "+(c.offset+c.alreadyRead-h.fileStart)+" read size: "+k+" full extent size: "+c.length+" full item size: "+b.size+")"),e.memcpy(b.data.buffer,b.alreadyRead,h,c.offset+c.alreadyRead-h.fileStart,k),c.alreadyRead+=k,b.alreadyRead+=k,h.usedBytes+=k,this.stream.logBufferLevel(),null;f.debug("ISOFile","Getting item #"+a+" extent #"+d+" data (alreadyRead: "+c.alreadyRead+" offset: "+
(c.offset+c.alreadyRead-h.fileStart)+" read size: "+(c.length-c.alreadyRead)+" full extent size: "+c.length+" full item size: "+b.size+")");e.memcpy(b.data.buffer,b.alreadyRead,h,c.offset+c.alreadyRead-h.fileStart,c.length-c.alreadyRead);h.usedBytes+=c.length-c.alreadyRead;this.stream.logBufferLevel();c.alreadyRead=c.length;b.alreadyRead+=c.length}}return b.alreadyRead===b.size?b:null};h.prototype.releaseItem=function(a){a=this.items[a];if(a.data){this.itemsDataSize-=a.size;a.data=null;for(var b=
a.alreadyRead=0;b<a.extents.length;b++)a.extents[b].alreadyRead=0;return a.size}return 0};h.prototype.processItems=function(a){for(var b in this.items){var d=this.items[b];this.getItem(d.id);a&&!d.sent&&(a(d),d.sent=!0,d.data=null)}};h.prototype.hasItem=function(a){for(var b in this.items){var d=this.items[b];if(d.name===a)return d.id}return-1};h.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null};h.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?
this.getItem(this.meta.pitm.item_id):null};h.prototype.write=function(a){for(var b=0;b<this.boxes.length;b++)this.boxes[b].write(a)};h.writeInitializationSegment=function(a,b,d,c){f.debug("ISOFile","Generating initialization segment");var g=new e;g.endianness=e.BIG_ENDIAN;a.write(g);a=b.add("mvex");d&&a.add("mehd").set("fragment_duration",d);for(d=0;d<b.traks.length;d++)a.add("trex").set("track_id",b.traks[d].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",c).set("default_sample_size",
0).set("default_sample_flags",65536);return b.write(g),g.buffer};var u=function(a){this.inputStream=new l;this.keepMdatData=void 0===a||a;this.inputIsoFile=new h(this.inputStream);this.inputIsoFile.discardMdatData=!this.keepMdatData;this.onMoovStart=null;this.moovStartSent=!1;this.onReady=null;this.readySent=!1;this.onError=this.onSamples=this.onSegment=null;this.sampleListBuilt=!1;this.fragmentedTracks=[];this.extractedTracks=[];this.sampleProcessingStarted=this.isFragmentationInitialized=!1;this.nextMoofNumber=
0;this.itemListBuilt=!1};return u.prototype.setSegmentOptions=function(a,b,d){var c=this.inputIsoFile.getTrackById(a);if(c){var f={};this.fragmentedTracks.push(f);f.id=a;f.user=b;f.trak=c;c.nextSample=0;f.segmentStream=null;f.nb_samples=1E3;f.rapAlignement=!0;d&&(d.nbSamples&&(f.nb_samples=d.nbSamples),d.rapAlignement&&(f.rapAlignement=d.rapAlignement))}},u.prototype.unsetSegmentOptions=function(a){for(var b=-1,d=0;d<this.fragmentedTracks.length;d++)this.fragmentedTracks[d].id==a&&(b=d);-1<b&&this.fragmentedTracks.splice(b,
1)},u.prototype.setExtractionOptions=function(a,b,d){var c=this.inputIsoFile.getTrackById(a);if(c){var f={};this.extractedTracks.push(f);f.id=a;f.user=b;f.trak=c;c.nextSample=0;f.nb_samples=1E3;f.samples=[];d&&d.nbSamples&&(f.nb_samples=d.nbSamples)}},u.prototype.unsetExtractionOptions=function(a){for(var b=-1,d=0;d<this.extractedTracks.length;d++)this.extractedTracks[d].id==a&&(b=d);-1<b&&this.extractedTracks.splice(b,1)},u.prototype.createSingleSampleMoof=function(a){var b=new c.moofBox;b.add("mfhd").set("sequence_number",
this.nextMoofNumber);this.nextMoofNumber++;var d=b.add("traf");return d.add("tfhd").set("track_id",a.track_id).set("flags",c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),d.add("tfdt").set("baseMediaDecodeTime",a.dts),d.add("trun").set("flags",c.TRUN_FLAGS_DATA_OFFSET|c.TRUN_FLAGS_DURATION|c.TRUN_FLAGS_SIZE|c.TRUN_FLAGS_FLAGS|c.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[a.duration]).set("sample_size",[a.size]).set("sample_flags",[0]).set("sample_composition_time_offset",
[a.cts-a.dts]),b},u.prototype.createFragment=function(a,b,d,g){b=this.inputIsoFile.getTrackById(b);a=this.inputIsoFile.getSample(b,d);if(null==a)return a=b.samples[d],this.nextSeekPosition?this.nextSeekPosition=Math.min(a.offset+a.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=b.samples[d].offset+a.alreadyRead,null;d=g||new e;d.endianness=e.BIG_ENDIAN;g=this.createSingleSampleMoof(a);g.write(d);g.trafs[0].truns[0].data_offset=g.size+8;f.debug("MP4Box","Adjusting data_offset with new value "+
g.trafs[0].truns[0].data_offset);d.adjustUint32(g.trafs[0].truns[0].data_offset_position,g.trafs[0].truns[0].data_offset);g=new c.mdatBox;return g.data=a.data,g.write(d),d},u.prototype.processSamples=function(){var a,b;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(a=0;a<this.fragmentedTracks.length;a++){var d=this.fragmentedTracks[a];for(b=d.trak;b.nextSample<b.samples.length&&this.sampleProcessingStarted;){f.debug("MP4Box","Creating media fragment on track #"+
d.id+" for sample "+b.nextSample);var c=this.createFragment(this.inputIsoFile,d.id,b.nextSample,d.segmentStream);if(!c)break;if(d.segmentStream=c,b.nextSample++,(0===b.nextSample%d.nb_samples||b.nextSample>=b.samples.length)&&(f.info("MP4Box","Sending fragmented data on track #"+d.id+" for samples ["+Math.max(0,b.nextSample-d.nb_samples)+","+(b.nextSample-1)+"]"),f.info("MP4Box","Sample data size in memory: "+this.inputIsoFile.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(d.id,d.user,
d.segmentStream.buffer,b.nextSample),d.segmentStream=null,d!==this.fragmentedTracks[a]))break}}if(null!==this.onSamples)for(a=0;a<this.extractedTracks.length;a++)for(d=this.extractedTracks[a],b=d.trak;b.nextSample<b.samples.length&&this.sampleProcessingStarted;){f.debug("MP4Box","Exporting on track #"+d.id+" sample #"+b.nextSample);c=this.inputIsoFile.getSample(b,b.nextSample);if(!c)break;if(b.nextSample++,d.samples.push(c),(0===b.nextSample%d.nb_samples||b.nextSample>=b.samples.length)&&(f.debug("MP4Box",
"Sending samples on track #"+d.id+" for sample "+b.nextSample),this.onSamples&&this.onSamples(d.id,d.user,d.samples),d.samples=[],d!==this.extractedTracks[a]))break}}},u.prototype.checkBuffer=function(a){if(null===a||void 0===a)throw"Buffer must be defined and non empty";if(void 0===a.fileStart)throw"Buffer must have a fileStart property";return 0===a.byteLength?(f.warn("MP4Box","Ignoring empty buffer (fileStart: "+a.fileStart+")"),this.inputStream.logBufferLevel(),!1):(f.info("MP4Box","Processing buffer (fileStart: "+
a.fileStart+")"),a.usedBytes=0,this.inputStream.insertBuffer(a),this.inputStream.logBufferLevel(),!!this.inputStream.initialized()||(f.warn("MP4Box","Not ready to start parsing"),!1))},u.prototype.appendBuffer=function(a){var b;if(!this.checkBuffer||this.checkBuffer(a))return this.inputIsoFile.parse(),this.inputIsoFile.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.inputIsoFile.moov?(this.processSamples&&(this.sampleListBuilt||(this.inputIsoFile.buildSampleLists(),
this.sampleListBuilt=!0),this.inputIsoFile.updateSampleLists()),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples&&this.processSamples(),this.nextSeekPosition?(b=this.nextSeekPosition,this.nextSeekPosition=void 0):b=this.inputIsoFile.nextParsePosition,this.inputStream.getEndFilePositionAfter&&(b=this.inputStream.getEndFilePositionAfter(b))):b=null!==this.inputIsoFile?this.inputIsoFile.nextParsePosition:0,this.inputIsoFile.meta&&(this.inputIsoFile.flattenItemInfo&&
!this.itemListBuilt&&(this.inputIsoFile.flattenItemInfo(),this.itemListBuilt=!0),this.inputIsoFile.processItems&&this.inputIsoFile.processItems(this.onItem)),this.inputStream.cleanBuffers&&(f.info("MP4Box","Done processing buffer (fileStart: "+a.fileStart+") - next buffer to fetch should have a fileStart position of "+b),this.inputStream.logBufferLevel(),this.inputStream.cleanBuffers(),this.inputStream.logBufferLevel(!0),f.info("MP4Box","Sample data size in memory: "+this.inputIsoFile.getAllocatedSampleDataSize())),
b},u.prototype.getInfo=function(){var a,b,d,c,f,e={},h=(new Date(4,0,1,0,0,0,0)).getTime();if(this.inputIsoFile.moov)for(e.hasMoov=!0,e.duration=this.inputIsoFile.moov.mvhd.duration,e.timescale=this.inputIsoFile.moov.mvhd.timescale,e.isFragmented=null!=this.inputIsoFile.moov.mvex,e.isFragmented&&this.inputIsoFile.moov.mvex.mehd&&(e.fragment_duration=this.inputIsoFile.moov.mvex.mehd.fragment_duration),e.isProgressive=this.inputIsoFile.isProgressive,e.hasIOD=null!=this.inputIsoFile.moov.iods,e.brands=
[],e.brands.push(this.inputIsoFile.ftyp.major_brand),e.brands=e.brands.concat(this.inputIsoFile.ftyp.compatible_brands),e.created=new Date(h+1E3*this.inputIsoFile.moov.mvhd.creation_time),e.modified=new Date(h+1E3*this.inputIsoFile.moov.mvhd.modification_time),e.tracks=[],e.audioTracks=[],e.videoTracks=[],e.subtitleTracks=[],e.metadataTracks=[],e.hintTracks=[],e.otherTracks=[],a=0;a<this.inputIsoFile.moov.traks.length;a++){if(d=this.inputIsoFile.moov.traks[a],f=d.mdia.minf.stbl.stsd.entries[0],c=
{},e.tracks.push(c),c.id=d.tkhd.track_id,c.name=d.mdia.hdlr.name,c.references=[],d.tref)for(b=0;b<d.tref.boxes.length;b++)ref={},c.references.push(ref),ref.type=d.tref.boxes[b].type,ref.track_ids=d.tref.boxes[b].track_ids;d.edts&&(c.edits=d.edts.elst.entries);c.created=new Date(h+1E3*d.tkhd.creation_time);c.modified=new Date(h+1E3*d.tkhd.modification_time);c.movie_duration=d.tkhd.duration;c.movie_timescale=e.timescale;c.layer=d.tkhd.layer;c.alternate_group=d.tkhd.alternate_group;c.volume=d.tkhd.volume;
c.matrix=d.tkhd.matrix;c.track_width=d.tkhd.width/65536;c.track_height=d.tkhd.height/65536;c.timescale=d.mdia.mdhd.timescale;c.cts_shift=d.mdia.minf.stbl.cslg;c.duration=d.mdia.mdhd.duration;c.samples_duration=d.samples_duration;c.codec=f.getCodec();c.kind=d.udta&&d.udta.kinds.length?d.udta.kinds[0]:{schemeURI:"",value:""};c.language=d.mdia.elng?d.mdia.elng.extended_language:d.mdia.mdhd.languageString;c.nb_samples=d.samples.length;c.size=d.samples_size;c.bitrate=8*c.size*c.timescale/c.samples_duration;
f.isAudio()?(c.type="audio",e.audioTracks.push(c),c.audio={},c.audio.sample_rate=f.getSampleRate(),c.audio.channel_count=f.getChannelCount(),c.audio.sample_size=f.getSampleSize()):f.isVideo()?(c.type="video",e.videoTracks.push(c),c.video={},c.video.width=f.getWidth(),c.video.height=f.getHeight()):f.isSubtitle()?(c.type="subtitles",e.subtitleTracks.push(c)):f.isHint()?(c.type="metadata",e.hintTracks.push(c)):f.isMetadata()?(c.type="metadata",e.metadataTracks.push(c)):(c.type="metadata",e.otherTracks.push(c))}else e.hasMoov=
!1;e.mime="";0<e.videoTracks.length?e.mime+='video/mp4; codecs="':0<e.audioTracks.length?e.mime+='audio/mp4; codecs="':e.mime+='application/mp4; codecs="';for(a=0;a<e.tracks.length;a++)0!==a&&(e.mime+=","),e.mime+=e.tracks[a].codec;return e.mime+='"; profiles="',e.mime+=this.inputIsoFile.ftyp.compatible_brands.join(),e.mime+='"',e},u.prototype.writeFile=function(){var a=new e;return a.endianness=e.BIG_ENDIAN,this.inputIsoFile.write(a),a.buffer},u.prototype.initializeSegmentation=function(){var a;
null===this.onSegment&&f.warn("MP4Box","No segmentation callback set!");this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.inputIsoFile.resetTables());var b=[];for(a=0;a<this.fragmentedTracks.length;a++){var d=new c.moovBox;d.mvhd=this.inputIsoFile.moov.mvhd;d.boxes.push(d.mvhd);var e=this.inputIsoFile.getTrackById(this.fragmentedTracks[a].id);d.boxes.push(e);d.traks.push(e);var k={};k.id=e.tkhd.track_id;k.user=this.fragmentedTracks[a].user;k.buffer=h.writeInitializationSegment(this.inputIsoFile.ftyp,
d,this.inputIsoFile.moov.mvex&&this.inputIsoFile.moov.mvex.mehd?this.inputIsoFile.moov.mvex.mehd.fragment_duration:void 0,0<this.inputIsoFile.moov.traks[a].samples.length?this.inputIsoFile.moov.traks[a].samples[0].duration:0);b.push(k)}return b},u.prototype.releaseUsedSamples=function(a,b){var d=0,c=this.inputIsoFile.getTrackById(a);c.lastValidSample||(c.lastValidSample=0);for(var e=c.lastValidSample;e<b;e++)d+=this.inputIsoFile.releaseSample(c,e);f.info("MP4Box","Track #"+a+" released samples up to "+
b+" (released size: "+d+", remaining: "+this.inputIsoFile.samplesDataSize+")");c.lastValidSample=b},u.prototype.flush=function(){f.info("MP4Box","Flushing remaining samples");this.inputIsoFile.updateSampleLists();this.processSamples();this.inputStream.cleanBuffers();this.inputStream.logBufferLevel(!0)},u.prototype.seekTrack=function(a,b,d){var c,e,h=1/0,k=0,l=0;if(0===d.samples.length)return f.info("MP4Box","No sample in track, cannot seek! Using time "+f.getDurationString(0,1)+" and offset: 0"),
{offset:0,time:0};for(c=0;c<d.samples.length;c++){if(e=d.samples[c],0===c){l=0;var m=e.timescale}else if(e.cts>a*e.timescale){l=c-1;break}b&&e.is_sync&&(k=c)}b&&(l=k);a=d.samples[l].cts;for(d.nextSample=l;d.samples[l].alreadyRead===d.samples[l].size;)l++;return h=d.samples[l].offset+d.samples[l].alreadyRead,f.info("MP4Box","Seeking to "+(b?"RAP":"")+" sample #"+d.nextSample+" on track "+d.tkhd.track_id+", time "+f.getDurationString(a,m)+" and offset: "+h),{offset:h,time:a/m}},u.prototype.seek=function(a,
b){var d,c=this.inputIsoFile.moov,e={offset:1/0,time:1/0};if(this.inputIsoFile.moov){for(d=0;d<c.traks.length;d++){var h=c.traks[d];h=this.seekTrack(a,b,h);h.offset<e.offset&&(e.offset=h.offset);h.time<e.time&&(e.time=h.time)}return f.info("MP4Box","Seeking at time "+f.getDurationString(e.time,1)+" needs a buffer with a fileStart position of "+e.offset),e.offset===1/0?e={offset:this.inputIsoFile.nextParsePosition,time:0}:e.offset=this.inputStream.getEndFilePositionAfter(e.offset),f.info("MP4Box",
"Adjusted seek position (after checking data already in buffer): "+e.offset),e}throw"Cannot seek: moov not received!";},u.prototype.getTrackSamplesInfo=function(a){return(a=this.inputIsoFile.getTrackById(a))?a.samples:void 0},u.prototype.getTrackSample=function(a,b){a=this.inputIsoFile.getTrackById(a);return this.inputIsoFile.getSample(a,b)},u.prototype.start=function(){this.sampleProcessingStarted=!0;this.processSamples()},u.prototype.stop=function(){this.sampleProcessingStarted=!1},"undefined"!=
typeof exports&&(exports.MP4Box=u),u}function E(f,e){return B.Utils.uint8ArrayEquals(f.slice(e.offset,e.offset+e.bytes.length),e.bytes)}var T=y.dependencies["prezi.geometry"],Q=y.dependencies.prezi_logger,r=y.dependencies.prezi_nativeapitypes,R=y.dependencies.prezi_pdf_render,N=y.dependencies.prezi_bacon,v=y.dependencies.prezi_editor_error,H=y.dependencies.prezi_featureswitcher,B=y.dependencies.prezi_utils,z={};Object.defineProperty(z,"__esModule",{value:!0});z.ImageScale=class{constructor(f,e){this.quality=
f;this.forcedTypes=e}static calculateDownSampledSize(f,e){if(H.isActive("js-allow-arbitrary-sized-image"))return f;let k=f.width,l=f.height;if(f.width>e||f.height>e)f.width>f.height?(k=e,l=f.height*e/f.width):(k=f.width*e/f.height,l=e);return{width:Math.floor(k),height:Math.floor(l)}}downSample(f,e){const k=e.file.type in this.forcedTypes?this.forcedTypes[e.file.type]:e.file.type,l=z.ImageScale.calculateDownSampledSize(f,e.maxImageSize);var m=e.file;if(f.width>e.maxImageSize||f.height>e.maxImageSize||
e.file.type in this.forcedTypes){m=document.createElement("canvas");m.width=l.width;m.height=l.height;m.getContext("2d").drawImage(f,0,0,m.width,m.height);m=m.toDataURL(k,this.quality);m=0<=m.split(",")[0].indexOf("base64")?atob(m.split(",")[1]):decodeURIComponent(m.split(",")[1]);var c=new ArrayBuffer(m.length);c=new Uint8Array(c);for(let e=0;e<m.length;e+=1)c[e]=m.charCodeAt(e);m=c;m=new Blob([m],{type:k});c=e.file.name.replace(/^.*[\\\/]/,"").replace(/(.*)\.[^.]+$/,"$1");m.name=c+"."+k.replace("image/",
"");m.lastModified=e.file.lastModified}return{metaData:l,input:{file:m,maxImageSize:e.maxImageSize},thumbnail:f}}};var C={};Object.defineProperty(C,"__esModule",{value:!0});var F;(function(f){f[f.OK=0]="OK";f[f.UNSUPPORTED_VIDEO_CODEC=1]="UNSUPPORTED_VIDEO_CODEC";f[f.UNSUPPORTED_AUDIO_CODEC=2]="UNSUPPORTED_AUDIO_CODEC";f[f.CORRUPT=3]="CORRUPT"})(F=C.VideoStatus||(C.VideoStatus={}));class D{static checkSupportedMp4(f){null==D.MP4Box&&(D.MP4Box=S());let e=null;try{const k=new D.MP4Box(!1);f.fileStart=
0;k.appendBuffer(f);e=k.getInfo()}catch(k){return F.CORRUPT}return D.hasWhitelistedCodecs(e)}static hasWhitelistedCodecs(f){return f.audioTracks.every(function(e){return"mp4a.40.2"===e.codec})?f.videoTracks.every(function(e){return 0===e.codec.toLowerCase().indexOf("avc1.")})?F.OK:F.UNSUPPORTED_VIDEO_CODEC:F.UNSUPPORTED_AUDIO_CODEC}}C.Mp4Util=D;D.MP4Box=null;var I={},U=this&&I.__awaiter||function(f,e,k,l){function m(c){return c instanceof k?c:new k(function(e){e(c)})}return new (k||(k=Promise))(function(c,
h){function k(a){try{b(l.next(a))}catch(g){h(g)}}function a(a){try{b(l["throw"](a))}catch(g){h(g)}}function b(b){b.done?c(b.value):m(b.value).then(k,a)}b((l=l.apply(f,e||[])).next())})};Object.defineProperty(I,"__esModule",{value:!0});const V={offset:0,bytes:new Uint8Array([255,216,255])},W={offset:0,bytes:new Uint8Array([71,73,70,56,55,97])},X={offset:0,bytes:new Uint8Array([71,73,70,56,57,97])},Y={offset:0,bytes:new Uint8Array([137,80,78,71,13,10,26,10])},Z={offset:4,bytes:new Uint8Array([102,116,
121,112])};I.MetadataExtractor=class{constructor(f){this.imageScale=f}getThumbnail(f){return new Promise((e,k)=>{const l=new FileReader;l.onload=(l)=>{try{const c=new Uint8Array(l.target.result);E(c,V)||E(c,W)||E(c,X)||E(c,Y)||k({errorCase:v.EditorErrorCase.INVALID_IMAGE_FILE_FORMAT,errorDetails:"Allowed formats: JPG, GIF, PNG"});if((l="undefined"!==typeof URL?URL:"undefined"!==typeof webkitURL?webkitURL:null)&&l.createObjectURL){const c=new Image,m=this.imageScale.downSample.bind(this.imageScale);
c.onload=function(){const a=m(this,f);e({unresizedThumbnail:a.thumbnail,resizedFile:a.input.file,finalImageWidth:a.metaData.width,finalImageHeight:a.metaData.height})};c.onerror=()=>{k({errorCase:v.EditorErrorCase.INVALID_IMAGE_FILE_FORMAT,errorDetails:"Invalid image format. Allowed formats: JPG, GIF, PNG."})};c.src=l.createObjectURL(f.file)}else{const c=new FileReader;c.onload=function(c){try{const a=require("image-size")(new Buffer(c.target.result));!H.isActive("js-allow-arbitrary-sized-image")&&
f.maxImageSize&&(a.width>f.maxImageSize||a.height>f.maxImageSize)?k({errorCase:v.EditorErrorCase.IMAGE_IS_TOO_BIG,errorDetails:`Image exceeds maximum size of ${f.maxImageSize}x${f.maxImageSize}.`+` Size of image: ${a.width}x${a.width}.`}):e({unresizedThumbnail:null,resizedFile:f.file,finalImageWidth:a.width,finalImageHeight:a.height})}catch(a){k(a)}};c.readAsArrayBuffer(f.file)}}catch(c){k(c)}};l.readAsArrayBuffer(f.file.slice(0,8))})}checkVideo(f){return new Promise((e,k)=>{if("video/mp4"===f.type){const l=
new FileReader;l.onload=function(){C.Mp4Util.checkSupportedMp4(l.result)===C.VideoStatus.OK?e():k({errorCase:v.EditorErrorCase.UNSUPPORTED_VIDEO_TYPE,errorDetails:"Detected mp4 with unsupported codec."})};l.readAsArrayBuffer(f)}else 0===f.type.indexOf("video/")?k({errorCase:v.EditorErrorCase.UNSUPPORTED_VIDEO_TYPE,errorDetails:"Unsupported video type."}):k({errorCase:v.EditorErrorCase.UNSUPPORTED_VIDEO_TYPE,errorDetails:"Not video type."})})}getAudioInfo(f){return U(this,void 0,void 0,function*(){const e=
yield B.AudioUtils.getAudioContext();try{const k=yield this.readFileAsArrayBuffer(f),l=this.detectAudioType(f,k),m=yield new Promise((c,f)=>{e.decodeAudioData(k,c,()=>{f({errorCase:v.EditorErrorCase.UNSUPPORTED_AUDIO,errorDetails:"Allowed formats: MP3, M4A"})})});return{lengthInMilliSecs:Math.round(1E3*m.duration),audioType:l}}catch(k){throw{errorCase:null!=k.errorCase?k.errorCase:v.EditorErrorCase.UNSUPPORTED_AUDIO,errorDetails:k.errorDetails};}})}detectAudioType(f,e){return E(new Uint8Array(e),
Z)?"m4a":f.name.endsWith(".mp3")?"mp3":f.name.endsWith(".m4a")?"m4a":null}readFileAsArrayBuffer(f){return new Promise((e,k)=>{const l=new FileReader;l.onload=()=>{e(l.result)};l.onerror=(e)=>{k(e)};l.onabort=(e)=>{k(e)};l.readAsArrayBuffer(f)})}};var O={};Object.defineProperty(O,"__esModule",{value:!0});O.UploadStateHandler=class{constructor(f=r.MediaUploadPhase.UPLOAD_DONE){this.endPhase=f;this.uploadProgressStream=N.Bacon.newBus()}handle(f,e){switch(f.phase){case r.MediaUploadPhase.PREPROCESSING:this.uploadProgressStream.push({phase:t.UploadPhase.AUTHENTICATING});
break;case r.MediaUploadPhase.UPLOADING:this.uploadProgressStream.push({phase:t.UploadPhase.UPLOADING,completed:f.uploadPercentCompleted,total:100});break;case r.MediaUploadPhase.UPLOAD_FINALIZING:this.uploadProgressStream.push({phase:t.UploadPhase.REGISTERING_SUCCESS});break;case this.endPhase:e(f.uploadResult),this.uploadProgressStream.push({phase:t.UploadPhase.DONE})}}};var x={};Object.defineProperty(x,"__esModule",{value:!0});var P;(function(f){f[f.UPLOAD=0]="UPLOAD";f[f.CONVERT=1]="CONVERT"})(P=
x.JOB_TYPE||(x.JOB_TYPE={}));class aa{static map(f,e){let k;switch(f){case r.MediaError.CONVERSION_JOB_FAILED:k=v.EditorErrorCase.CONVERSION_JOB_FAILED;break;case r.MediaError.MEDIA_UPLOAD_RESPONSE_FAILURE:k=v.EditorErrorCase.MEDIA_UPLOAD_RESPONSE_FAILURE;break;case r.MediaError.TOKEN_INVALID_JSON:k=e===P.CONVERT?v.EditorErrorCase.CONVERSION_TOKEN_INVALID_JSON:v.EditorErrorCase.MEDIA_UPLOAD_TOKEN_INVALID_JSON;break;case r.MediaError.TOKEN_INVALID_RESPONSE:k=e===P.CONVERT?v.EditorErrorCase.CONVERSION_TOKEN_INVALID_RESPONSE:
v.EditorErrorCase.MEDIA_UPLOAD_TOKEN_INVALID_RESPONSE;break;case r.MediaError.TOKEN_RESPONSE_FAILURE:k=v.EditorErrorCase.MEDIA_UPLOAD_TOKEN_RESPONSE_FAILURE}return{errorCase:k}}}x.MediaErrorMapper=aa;var w={},ba=this&&w.__awaiter||function(f,e,k,l){function m(c){return c instanceof k?c:new k(function(e){e(c)})}return new (k||(k=Promise))(function(c,h){function k(a){try{b(l.next(a))}catch(g){h(g)}}function a(a){try{b(l["throw"](a))}catch(g){h(g)}}function b(b){b.done?c(b.value):m(b.value).then(k,a)}
b((l=l.apply(f,e||[])).next())})};Object.defineProperty(w,"__esModule",{value:!0});w.MediaServiceImpl=class{constructor(f,e,k,l){this.mediaUploadProvider=f;this.assetLoader=e;this.chartServiceProvider=k;this.imageScale=l;this.metadataExtractor=new I.MetadataExtractor(this.imageScale);this.pdfThumbnailCreator=t.MediaServiceModule.createPdfThumbnailCreator(e);this.logger=Q.LoggerModule.getLoggerManager().createLogger("MediaUploadService")}checkSlow(f){return H.FeatureSwitcher.isActive("js-for-test-slow-upload")?
B.Utils.sleepAfter(1E4,f):f}checkHalfSlow(f){return H.FeatureSwitcher.isActive("js-for-test-slow-upload")?B.Utils.sleepAfter(5E3,f):f}uploadPDF(f,e,k,l){e=this.uploadFile(f,{conversionFormat:e?w.MediaServiceImpl.PDF_CONVERSION_FORMAT_TRANSPARENT:w.MediaServiceImpl.PDF_CONVERSION_FORMAT_CHART}).result;return{pdfPageInfos:this.pdfThumbnailCreator.getPdfInfo(f,k,l),result:e}}uploadAudioFile(f){const e=N.Bacon.newBus();return{uploadStatus:e,result:this.uploadAudioFileAsync(f,e)}}uploadAudioFileAsync(f,
e){return ba(this,void 0,void 0,function*(){const k=yield this.metadataExtractor.getAudioInfo(f);var l=this.uploadFile(f);e.plug(l.uploadStatus);l=yield l.result;return Object.assign(Object.assign({},l),{audioLengthMilliSecs:k.lengthInMilliSecs,audioType:k.audioType})})}uploadGenericFile(f){return this.uploadFile(f)}uploadVideo(f){const e=this.metadataExtractor.checkVideo(f).then(()=>this.uploadFile(f,{conversionFormat:""})),k=N.Bacon.newBus();return{uploadStatus:k,result:e.then((e)=>{k.plug(e.uploadStatus);
return e.result})}}uploadImage(f){f=this.metadataExtractor.getThumbnail({file:f.file,maxImageSize:f.maxImageSize||w.MediaServiceImpl.MAX_IMAGE_SIZE});const e=f.then((e)=>this.uploadFile(e.resizedFile).result);return{thumbnail:f,result:this.checkSlow(e)}}uploadImageUrl(f){const e=f.maxImageSize||w.MediaServiceImpl.MAX_IMAGE_SIZE,k=new Promise((k)=>{if(f.thumbnailUrl&&f.width&&f.height){let c=new Image;c.src=f.thumbnailUrl;let h=z.ImageScale.calculateDownSampledSize({width:f.width,height:f.height},
e);k({unresizedThumbnail:c,finalImageWidth:h.width,finalImageHeight:h.height})}else this.assetLoader.loadRemoteImage(f.url,(c)=>{const f=z.ImageScale.calculateDownSampledSize(c,e);k({unresizedThumbnail:c,finalImageWidth:f.width,finalImageHeight:f.height})},()=>{k({unresizedThumbnail:null,finalImageWidth:null,finalImageHeight:null})})});if(this.isAlreadyUploadedUrl(f.url))return{thumbnail:k,result:Promise.resolve({media_id:B.Utils.generateUUID(),media_url:f.url})};const l=this.convert(f.url).then((e)=>
null==e.mime||0!==e.mime.indexOf("image/")?Promise.reject({errorCase:v.EditorErrorCase.NO_TYPE_FROM_MEDIA_SERVICE,parameters:{url:f.url}}):Promise.resolve(e));return{thumbnail:this.checkHalfSlow(k),result:this.checkSlow(l)}}isAlreadyUploadedUrl(f){try{if(Q.LoggerModule.getLoggerManager().isLocalhostLogger()&&f.startsWith("/media/"))return!0;const e=new URL(f.startsWith("/")?"https:"+f:f);return[/.*\.static\.prezi\.com/,/.*prezi.*\.s3\.amazonaws\.com/,/media\.preziusercontent\.com/].some((f)=>e.hostname.match(f))}catch(e){return!1}}requestChartData(f){return{result:this.chartServiceProvider.createChart(f)}}uploadFile(f,
e=null){const k=Date.now(),l=new O.UploadStateHandler(null!=e?r.MediaUploadPhase.CONVERSION_DONE:r.MediaUploadPhase.UPLOAD_DONE),m=new Promise((c,h)=>{this.mediaUploadProvider.uploadMedia(f,null!=e?r.ConversionRequirement.CONVERSION_RESULT_REQUIRED:r.ConversionRequirement.NO_CONVERSION,null!=e?e.conversionFormat:null,(e)=>{l.handle(e,(a)=>{null!=a&&"string"===typeof a.media_id||this.logger.info({action:"invalidMediaResult",object:"MediaUploadService",trigger:"machine",payload:{message:null==a?"mediaResult is null":
`media_id is not a string '${a.media_id}'`}});c({media_id:String(a.media_id),media_url:a.media_url,mime:a.mime,durationMilliSecs:Date.now()-k})})},(c)=>{h(x.MediaErrorMapper.map(c,x.JOB_TYPE.UPLOAD))})});return{uploadStatus:l.uploadProgressStream,result:m}}convert(f){const e=Date.now();return new Promise((k,l)=>{this.mediaUploadProvider.uploadFromUrl(f,(f)=>{f.forEach((c)=>{null!=c&&"string"===typeof c.media_id||this.logger.info({action:"invalidMediaResult",object:"MediaConversionService",trigger:"machine",
payload:{message:null==c?"mediaResult is null":`media_id is not a string '${c.media_id}'`}});k({media_id:String(c.media_id),media_url:c.media_url,durationMilliSecs:Date.now()-e,mime:c.mime})})},(e)=>{e=x.MediaErrorMapper.map(e,x.JOB_TYPE.CONVERT);e={parameters:e.parameters||{},errorCase:e.errorCase};e.parameters.url=f;l(e)})})}uploadGif(f){return this.mediaUploadProvider.uploadGif(f.fileOrUrl,f.preziOid)}getExportedImageByMediaId(f){return this.assetLoader.getExportedImageResultByMediaId(f)}};w.MediaServiceImpl.MAX_IMAGE_SIZE=
1800;w.MediaServiceImpl.PDF_CONVERSION_FORMAT_TRANSPARENT="transparent_pdf";w.MediaServiceImpl.PDF_CONVERSION_FORMAT_CHART="pdf_chart";var J={},K=this&&J.__awaiter||function(f,e,k,l){function m(c){return c instanceof k?c:new k(function(e){e(c)})}return new (k||(k=Promise))(function(c,h){function k(a){try{b(l.next(a))}catch(g){h(g)}}function a(a){try{b(l["throw"](a))}catch(g){h(g)}}function b(b){b.done?c(b.value):m(b.value).then(k,a)}b((l=l.apply(f,e||[])).next())})};Object.defineProperty(J,"__esModule",
{value:!0});J.PdfThumbnailCreatorImpl=class{constructor(f){this.assetLoader=f;this.pdfLoader=R.createPdfLoader()}getPptPageThumbnails(f,e){return K(this,void 0,void 0,function*(){var k=yield this.loadBinaryAsset(f);k=yield this.loadPdfFromBytes(k);return this.getPages(k,e,e)})}getPdfInfo(f,e,k){return K(this,void 0,void 0,function*(){var l=yield new Promise((e)=>{const c=new FileReader;c.onload=()=>e(c.result);c.readAsArrayBuffer(f)});l=yield this.loadPdfFromBytes(l);return this.getPages(l,e,k)})}loadBinaryAsset(f){const e=
this.assetLoader.rewriteUrl(f),k=new XMLHttpRequest;f=new Promise((f)=>{k.open("GET",e,!0);k.responseType="arraybuffer";k.addEventListener("load",()=>{f(k.response)})});k.send();return f}loadPdfFromBytes(f){return K(this,void 0,void 0,function*(){return new Promise((e,k)=>{this.pdfLoader.loadFromBytes(f,(f)=>e(f),(e)=>{k("Error loading pdf document: "+e)})})})}getPages(f,e,k){return K(this,void 0,void 0,function*(){const l=[],m=f.getNumberOfPages();for(let c=1;c<=m;c++){const h=yield new Promise((a,
b)=>{f.loadPage(c,(b)=>a(b),(a)=>{b("Error loading pdf pages: "+a)})}),m={width:h.getWidth(),height:h.getHeight(),pageNumber:c,_thumbnailPromise:null};if(null!=e&&null!=k){const a=R.createPdfRender(h),b=document.createElement("canvas"),c=Math.min(k/h.getWidth(),k/h.getHeight()),f=Math.max(e/h.getWidth(),e/h.getHeight()),l=Math.min(f,c);b.width=h.getWidth()*l;b.height=h.getHeight()*l;m.thumbnail=()=>{null==m._thumbnailPromise&&(m._thumbnailPromise=(new Promise((c)=>{a.render(T.Geometry.rectangleFromData({x:0,
y:0,width:h.getWidth(),height:h.getHeight()}),0,0,l,b,()=>{c(b)})})).then((a)=>B.Utils.canvasToDataUrl(a)));return m._thumbnailPromise}}l.push(m)}return l})}};var t={};Object.defineProperty(t,"__esModule",{value:!0});(function(f){f[f.AUTHENTICATING=0]="AUTHENTICATING";f[f.UPLOADING=1]="UPLOADING";f[f.REGISTERING_SUCCESS=2]="REGISTERING_SUCCESS";f[f.DONE=3]="DONE"})(t.UploadPhase||(t.UploadPhase={}));(function(f){f[f.IMAGE=0]="IMAGE";f[f.PDF=1]="PDF";f[f.VIDEO=2]="VIDEO";f[f.EXTERNAL_VIDEO=3]="EXTERNAL_VIDEO";
f[f.PPT=4]="PPT";f[f.AUDIO=5]="AUDIO"})(t.MediaType||(t.MediaType={}));(function(f){f.createMediaService=function(e,f,l){return new w.MediaServiceImpl(e,f,l,new z.ImageScale(.8,{"image/bmp":"image/png"}))};f.createPdfThumbnailCreator=function(e){return new J.PdfThumbnailCreatorImpl(e)}})(t.MediaServiceModule||(t.MediaServiceModule={}));return t});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_service_media",["require","prezi.geometry","prezi_bacon","prezi_editor_error","prezi_externalserviceprovider","prezi_featureswitcher","prezi_logger","prezi_nativeapitypes","prezi_pdf_render","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_service_media.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi.geometry"),require("prezi_bacon"),require("prezi_editor_error"),require("prezi_externalserviceprovider"),require("prezi_featureswitcher"),require("prezi_logger"),require("prezi_nativeapitypes"),require("prezi_pdf_render"),require("prezi_utils"));}else{this["prezi_service_media"]=__factory(this["prezi.geometry"],this["prezi_bacon"],this["prezi_editor_error"],this["prezi_externalserviceprovider"],this["prezi_featureswitcher"],this["prezi_logger"],this["prezi_nativeapitypes"],this["prezi_pdf_render"],this["prezi_utils"]);}}).call(this);