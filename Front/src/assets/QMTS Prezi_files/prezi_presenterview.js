;(function(){var baseUrl;var __factory=function(){var React=arguments[0];var ReactDOM=arguments[1];var ReactTransitionGroup=arguments[2];var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_presenterview";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi_bacon":dependencies[3],"prezi_cet":dependencies[4],"prezi_cet_model":dependencies[5],"prezi_cet_model_editor":dependencies[6],"prezi_client_player":dependencies[7],"prezi_desktop_download_modal":dependencies[8],"prezi_externalserviceprovider":dependencies[9],"prezi_featureswitcher":dependencies[10],"prezi_i18n":dependencies[11],"prezi_logger":dependencies[12],"prezi_presenter_communication":dependencies[13],"prezi_presenterviewui":dependencies[14],"prezi_thumbnail_render":dependencies[15],"prezi_uaparser":dependencies[16],"prezi_utils":dependencies[17]}};})(),React,ReactDOM,ReactTransitionGroup);};})(arguments);var moduleImpl=(function(){return module(function(g,D,E,F){var x=g.dependencies.prezi_desktop_download_modal,v=g.dependencies.prezi_featureswitcher,d=g.dependencies.prezi_i18n,q=g.dependencies.prezi_logger,y=g.dependencies.prezi_presenterviewui,z=g.dependencies.prezi_thumbnail_render,k=g.dependencies.prezi_presenter_communication,w=g.dependencies.prezi_cet,m=g.dependencies.prezi_cet_model,h=g.dependencies.prezi_cet_model_editor,r=g.dependencies.prezi_utils,t={};Object.defineProperty(t,"__esModule",{value:!0});t.PathStepToPathElementIdMapImpl=
class{constructor(a){this.getIdToPathPos=a;this.pathPosToId=new Map;this.dirty=!0}getByPathPosition(a){this.dirty&&this.update();return this.pathPosToId.get(this.pathPositionDataKey(a))}getByPathElementId(a){this.dirty&&this.update();return this.idToPathPos.get(a)}hasPathPosition(a){this.dirty&&this.update();return this.pathPosToId.has(this.pathPositionDataKey(a))}hasPathElementId(a){this.dirty&&this.update();return this.idToPathPos.has(a)}makeDirty(){this.dirty=!0}pathPositionDataKey(a){return`${a.step}:${a.action}`}update(){this.pathPosToId.clear();
this.idToPathPos=this.getIdToPathPos();for(let [a,b]of this.idToPathPos.entries())this.pathPosToId.set(this.pathPositionDataKey(b),a);this.dirty=!1}};var u={};Object.defineProperty(u,"__esModule",{value:!0});var A=q.avro.Avro;u.NarrativeController=class{constructor(a,b,c){this.runner=a;this.getCurrentPosition=c;this.pathPosToId=new t.PathStepToPathElementIdMapImpl(b)}getNarrativeOfPathElementId(a){return this.runner.read((b)=>{const c=b.lookup.pathElement(a);return null==c?null:this.isFadeElement(c)?
this.getNearestNonFadeElement(b,c).narrative:c.narrative})}getNearestNonFadeElementId(a){return this.runner.read((b)=>{const c=b.lookup.pathElement(a);return this.getNearestNonFadeElement(b,c).id})}getNearestNonFadeElement(a,b){a=a.structuredPath.viewPathElementsInOrder;let c=a.findIndex((a)=>a.id===b.id);for(;0<=c&&this.isFadeElement(a[c]);)--c;if(0<=c)return a[c];throw Error(`Invalid path or path element id: ${b.id}`);}isFadeElement(a){return a.is(h.base.ObjectKind.fadeIn)||a.is(h.base.ObjectKind.fadeOut)}setNarrativeForPathPosition(a,
b){this.runner.executeApiCommand({name:"set-narrative",run:(c)=>{const e=c.lookup.pathElement(a);c=this.isFadeElement(e)?c.lookup.pathElement(this.getNearestNonFadeElement(c,e).id):e;c.narrative=b;c=this.pathPosToId.getByPathElementId(c.id);A.createDefaultLogger().logModifiedPresenterNote({step_index:null===c||void 0===c?void 0:c.step})}})}getNarrativeData(a){let b=this.pathPosToId.getByPathPosition(a);if(null==b){var c=a.step;for(a=a.action-1;0<=a&&null==(b=this.pathPosToId.getByPathPosition({step:c,
action:a}));)--a;if(null==b)for(;0<=c&&null==(b=this.pathPosToId.getByPathPosition({step:c,action:0}));)--c;null!=b&&(b=this.getNearestNonFadeElementId(b))}c=this.getNarrativeOfPathElementId(b);return{pathElementId:b,text:c}}playbackPathChangedStream(){return this.playbackPathChangedStreamInternal().map(()=>{this.pathPosToId.makeDirty();return{path:this.getPathData(),narrativeData:this.getNarrativeData(this.getCurrentPosition())}}).filter((a)=>null!=a)}playbackPathChangedStreamInternal(){return this.runner.scene.getIdleChangeStream(w.ChangeEventKind.Entity).filter((a)=>
a.some((a)=>a.kind!==w.ChangeEventKind.Entity||a.type!==m.ChangeType.AddEntity&&a.type!==m.ChangeType.RemoveEntity&&a.type!==m.ChangeType.ModifyComponent?!1:a.entity.isDef(m.CetModel.ID.PATH_ACTION)||a.entity.isDef(m.CetModel.ID.PATH_STEP))).map(()=>null)}hasAudio(a){switch(a.kind){case h.base.ObjectKind.visitStack:case h.base.ObjectKind.fadeIn:case h.base.ObjectKind.fadeOut:return!1;case h.base.ObjectKind.backToParent:case h.base.ObjectKind.zoom:case h.base.ObjectKind.visitPage:case h.base.ObjectKind.visitPlanet:case h.base.ObjectKind.visitOverview:return null!=
a.audio;default:r.Utils.assertNever(a)}}getPathData(){return this.runner.read((a)=>{a=a.structuredPath.viewPathElementsInOrder;return{path:a.map((a)=>a.id),pathElementsShownInProgressbar:a.filter((a)=>!this.isFadeElement(a)).map((a)=>a.id),pathElementsWithAudio:a.filter((a)=>this.hasAudio(a)).map((a)=>a.id)}})}};var p={debounce:function(a,b,c,e){return(...d)=>{let f=c&&!n[e];clearTimeout(n[e]);n[e]=setTimeout(()=>{delete n[e];c||a(...d)},b);f&&a(...d)}}};Object.defineProperty(p,"__esModule",{value:!0});
const n={},B=(0,p.debounce)((a,b)=>{a.setNarrativeForPathPosition(b.pathElementId,b.text)},500,!1,"PresenterViewCommunication.saveNarrative"),C=(a,b,c,e,d)=>{if(null!=d){var f=e.getPlayback();switch(d.kind){case k.NavigationTargetKind.next:e.flyToNextStep(()=>{a.logNavigatePrezi({navigation_type:"FORWARD_NAVBAR",action_index:f.getCurrentActionIndex(),step_index:f.getCurrentStepIndex(),total_step_number:f.getStepCount()})});break;case k.NavigationTargetKind.prev:e.flyToPreviousStep(()=>{a.logNavigatePrezi({navigation_type:"BACKWARD_NAVBAR",
action_index:f.getCurrentActionIndex(),step_index:f.getCurrentStepIndex(),total_step_number:f.getStepCount()})});break;case k.NavigationTargetKind.home:e.flyToHome(()=>{a.logNavigatePrezi({navigation_type:"GO_TO_START_KEYBOARD",action_index:f.getCurrentActionIndex(),step_index:f.getCurrentStepIndex(),total_step_number:f.getStepCount()})});break;case k.NavigationTargetKind.end:e.flyToEnd(()=>{a.logNavigatePrezi({navigation_type:"GO_TO_END_KEYBOARD",action_index:f.getCurrentActionIndex(),step_index:f.getCurrentStepIndex(),
total_step_number:f.getStepCount()})});break;case k.NavigationTargetKind.pathElementId:b=b.pathPosToId.getByPathElementId(d.pathElementId);e.flyToStepAction(b.step,b.action,()=>{a.logNavigatePrezi({navigation_type:"GO_TO_PATH",action_index:f.getCurrentActionIndex(),step_index:f.getCurrentStepIndex(),total_step_number:f.getStepCount()})});break;default:r.Utils.assertNever(d)}}};p.PresenterViewCommunication=class{constructor(a,b){this.needsThumbs=!1;this.logger=q.LoggerModule.getLoggerManager().createLogger("prezi_presenterview.PresenterViewCommunication");
this.avroLogger=q.avro.Avro.createDefaultLogger();this.saveInitialData=(a,b)=>{const c=a.getMetadata().title;this.channel.postMessage({kind:"presenterNotesPlaceholder",value:d.I18n.ts("Click to add presenter notes")});this.channel.postMessage({kind:"presenterNotesWarning",value:d.I18n.ts("You need editing rights to add or change presenter notes")});const e=b.getPathData();this.channel.postMessage({kind:"path",value:e});b=b.getNarrativeData(a.playerUI.getPathNavigator().getCurrentPosition());this.channel.postMessage({kind:"currentPathElementWithNarrative",
value:b});this.channel.postMessage({kind:"title",value:c});this.channel.postMessage({kind:"language",value:a.playerUI.getOptions().language});this.channel.postMessage({kind:"detachOverlayText",value:d.I18n.ts("Detach the browser tab and drag it to your primary screen.")});this.channel.postMessage({kind:"shuffleScreenAvailable",value:a.presenterViewProvider.isSwitchPresenterViewScreenAvailable()});this.channel.postMessage({kind:"shuffleScreenDescription",value:d.I18n.ts("Switch screen")});this.channel.postMessage({kind:"audioMuted",
value:a.playerUI.isMuted()});this.channel.postMessage({kind:"userCanEdit",value:a.playerUI.getOptions().userCanEdit});this.channel.postMessage({kind:"v2UIStrings",value:{nextSteps:d.I18n.ts("Next steps"),clickToAddPresenterNotes:d.I18n.ts("Click to add presenter notes"),switchScreens:d.I18n.ts("Switch screens",{context:"switching forth and back to presenter notes and the presentation browser page"}),reset:d.I18n.ts("Reset")}});this.channel.postMessage({kind:"startAtIndexZero",value:v.isActive("js-frame-only-editor")})};
this.oid=a.getMetadata().oid||a.getMetadata().desktopId;this.presenterViewProvider=a.presenterViewProvider;this.narrativeController=new u.NarrativeController(a.runner,a.idToPathPos,()=>a.playerUI.getPathNavigator().getCurrentPosition());this.channel=b;this.init(a)}init(a){this.narrativeController.playbackPathChangedStream().onValue((a)=>{this.channel.postMessage({kind:"path",value:a.path});this.channel.postMessage({kind:"currentPathElementWithNarrative",value:a.narrativeData})});a.navigationEventStream.onValue((a)=>
{this.needsThumbs&&(a=a.getToPos(),this.channel.postMessage({kind:"currentPathElementWithNarrative",value:this.narrativeController.getNarrativeData(a)}))});const b=(a,b)=>{if(this.needsThumbs&&null!=b.playbackPathPosition){var c=.01>Math.abs(b.canvas.width/b.canvas.height-4/3);this.channel.get("is4by3")!==c&&this.channel.postMessage({kind:"is4by3",value:c});var e=b.canvas.toDataURL("image/png"),d=b.pathElementRef.id;r.Utils.createIndexedStorage(y.IndexedDbId).then((a)=>a.put({key:d,value:e})).then(()=>
{this.channel.set({kind:a,index:d});this.channel.postMessage({kind:a,index:d})})}};a.audioStream.onValue((a)=>{this.channel.postMessage({kind:"audioMuted",value:a.isMuted})});const c=()=>{this.needsThumbs=!0;this.saveInitialData(a,this.narrativeController);null==this.thumbnailJob&&(this.thumbnailJob=a.thumbnailService.monitorPath({size:z.ThumbnailSize._640,includePathElement:()=>!0,needHighQuality:!0}));this.thumbnailJob.getThumbnailStream().onValue((a)=>{b("thumbnails.preview",a)})},e=()=>{this.avroLogger.logClosePresenterView();
this.needsThumbs=!1;null!=this.thumbnailJob&&(this.thumbnailJob.cancel(),this.thumbnailJob=null)},d=(a)=>{null!=a&&this.logger.info(a)},f=(a)=>{if(null!=a)switch(a.eventSchemaName){case "LoadedPresenterView":this.avroLogger.logLoadedPresenterView();break;case "StartPresenterViewTimer":this.avroLogger.logStartPresenterViewTimer();break;case "PausePresenterViewTimer":this.avroLogger.logPausePresenterViewTimer();break;case "SwitchPresenterViewScreen":this.avroLogger.logSwitchPresenterViewScreen();break;
case "LeaveFullScreen":this.avroLogger.logLeaveFullScreen();break;case "PresentInFullScreen":this.avroLogger.logPresentInFullScreen()}},g=()=>{this.presenterViewProvider.switchPresenterViewScreen()};this.channel.onMessage((b)=>{switch(b.kind){case "desiredDirection":C(this.avroLogger,this.narrativeController,this.oid,a.playerUI,b.value);break;case "desiredNarrative":b=b.value;null!=b&&B(this.narrativeController,b);break;case "presenterViewOpened":c();break;case "presenterViewClosed":e();break;case "logEvent":d(b.value);
break;case "shuffleScreen":g();break;case "audioMuted":a.playerUI.setMuted("true"===b.value);break;case "glassboxEvent":f(b.value)}})}};var l={setLocalStorageItem:function(a,b,c,d=null){a=(0,l.generateKey)(a,b,d);localStorage.setItem(a,JSON.stringify(c))},generateKey:function(a,b,c=null){return"presenterview2."+a+"."+b+(null!=c?"."+c:"")},getLocalStorageItem:function(a,b,c=null){a=(0,l.generateKey)(a,b,c);try{return JSON.parse(localStorage.getItem(a||"null"))}catch(e){return null}}};Object.defineProperty(l,
"__esModule",{value:!0});(function(a){a.init=function(a){const b=a.getMetadata().oid;new p.PresenterViewCommunication(a,k.PresenterViewCommunicationModule.createPresenterViewCommunicationChannel(b,v.isActive("js-force-localstorage-communication")))};a.createPresenterViewDesktopDownloadModal=function(a){const b=[d.I18n.ts("Presenter View is optimized for our desktop app."),d.I18n.ts("(Pssst... it comes with your license)")],e=[d.I18n.ts("You\u2019ll get a special presenter\u2019s screen with your notes and a timer to guide you.")],
g=[d.I18n.ts("This feature is available only in our desktop app."),d.I18n.ts("Don\u2019t have the app yet?")];a=Object.assign(Object.assign({},a),{headerContent:b,featureContent:e,descriptionContent:g,width:595,height:453});return x.DesktopDownloadModal.createDesktopDownloadModal(a)}})(l.PresenterViewModule||(l.PresenterViewModule={}));return l});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_presenterview",["require","react","react-dom","react-transition-group","prezi_bacon","prezi_cet","prezi_cet_model","prezi_cet_model_editor","prezi_client_player","prezi_desktop_download_modal","prezi_externalserviceprovider","prezi_featureswitcher","prezi_i18n","prezi_logger","prezi_presenter_communication","prezi_presenterviewui","prezi_thumbnail_render","prezi_uaparser","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_presenterview.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("react"),require("react-dom"),require("react-transition-group"),require("prezi_bacon"),require("prezi_cet"),require("prezi_cet_model"),require("prezi_cet_model_editor"),require("prezi_client_player"),require("prezi_desktop_download_modal"),require("prezi_externalserviceprovider"),require("prezi_featureswitcher"),require("prezi_i18n"),require("prezi_logger"),require("prezi_presenter_communication"),require("prezi_presenterviewui"),require("prezi_thumbnail_render"),require("prezi_uaparser"),require("prezi_utils"));}else{this["prezi_presenterview"]=__factory(React,ReactDOM,ReactTransitionGroup,this["prezi_bacon"],this["prezi_cet"],this["prezi_cet_model"],this["prezi_cet_model_editor"],this["prezi_client_player"],this["prezi_desktop_download_modal"],this["prezi_externalserviceprovider"],this["prezi_featureswitcher"],this["prezi_i18n"],this["prezi_logger"],this["prezi_presenter_communication"],this["prezi_presenterviewui"],this["prezi_thumbnail_render"],this["prezi_uaparser"],this["prezi_utils"]);}}).call(this);