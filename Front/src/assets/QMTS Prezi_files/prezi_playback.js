;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_playback";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.engine.dom":dependencies[0],"prezi.geometry":dependencies[1],"prezi_app_utils":dependencies[2],"prezi_bacon":dependencies[3],"prezi_canvas_listener":dependencies[4],"prezi_cet":dependencies[5],"prezi_cet_model":dependencies[6],"prezi_cet_model_editor":dependencies[7],"prezi_cet_renderer":dependencies[8],"prezi_editor_store_mode":dependencies[9],"prezi_editor_store_object":dependencies[10],"prezi_externalserviceprovider":dependencies[11],"prezi_featureswitcher":dependencies[12],"prezi_logger":dependencies[13],"prezi_select":dependencies[14],"prezi_service_data":dependencies[15],"prezi_textmodel":dependencies[16],"prezi_uaparser":dependencies[17],"prezi_utils":dependencies[18]}};})());};})(arguments);var moduleImpl=(function(){return module(function(v){var D=v.dependencies["prezi.geometry"],B=v.dependencies.prezi_externalserviceprovider,u=v.dependencies.prezi_featureswitcher,E=v.dependencies.prezi_logger,X=v.dependencies.prezi_service_data,Z=v.dependencies.prezi_uaparser,y=v.dependencies.prezi_utils,m=v.dependencies.prezi_app_utils,l=v.dependencies.prezi_bacon,d=v.dependencies.prezi_cet,f=v.dependencies.prezi_cet_model,g=v.dependencies.prezi_cet_model_editor,r=v.dependencies.prezi_cet_renderer,aa=v.dependencies.prezi_editor_store_object,
F=v.dependencies.prezi_select,n=v.dependencies.prezi_canvas_listener,p=v.dependencies.prezi_editor_store_mode,z={};Object.defineProperty(z,"__esModule",{value:!0});z.SnapLimits=class{constructor(){this.lastScrollTime=0;this.ease=!1;this.inFlyDeltas=[];this.inFlyTimes=[];this.flyStartTime=-1;this.zoomOutLimitRatio=1.2;this.currentTopicActivationRatio=.2;this.cameraFlySpeedMultiplier=.8;this.childSnapRatio=.01}getScrollOutSnapToEntityRatio(){return z.SnapLimits.SCROLL_OUT_SNAP_TO_ENTITY_RATIO}getScrollInSnapToEntityRatio(){return z.SnapLimits.SCROLL_IN_SNAP_TO_ENTITY_RATIO}getCameraFlySpeedMultiplier(a=
!0){return a?this.cameraFlySpeedMultiplier:z.SnapLimits.SCROLL_NON_TOPIC_TARGET_FLY_SPEED_MULTIPLIER}getCenterDistanceScreenDiagonalRatio(){return z.SnapLimits.CENTER_DISTANCE_SCREEN_DIAGONAL_RATIO}getChildSnapRatio(){return this.childSnapRatio}getCurrentTopicActivationRatio(){return this.currentTopicActivationRatio}getZoomOutToCurrentBound(){return this.zoomOutLimitRatio}withinActiveTrashhold(a,b,c){a=this.fillRatio(a,c);return b<a}withinChildSnapLimit(a,b,c){a=this.fillRatio(a,c);return b<a+z.SnapLimits.EPS}fillRatio(a,
b){b=b.viewportInWorld();b=b.getWidth()*b.getHeight();a=d.Cet.world(a).getWorldBounds().getBounds();return a.getWidth()*a.getHeight()/b}fillRatioForNavigationImprovements(a,b,c){a=d.Cet.getTargetTransform(c,a.getId(),b.getMarginCorrectedViewport()).getScale();b=b.getTransform().getScale();return Math.round(b/a*100)/100}collectScrollEvent(a){0===this.inFlyDeltas.length?this.inFlyDeltas.push(0):this.inFlyDeltas.push(a-this.inFlyTimes[this.inFlyTimes.length-1]);this.inFlyTimes.push(a);return this}resetScrollMeasurements(){this.flyStartTime=
-1;this.inFlyTimes=[];this.inFlyDeltas=[];this.ease=!1;this.lastScrollTime=0;return this}addEventMeasurement(a){var b=(a)=>{a=this.inFlyDeltas[this.inFlyDeltas.length-a];return null==a?0:a};if(0<this.inFlyDeltas.length&&100>this.inFlyDeltas.length){const c=a-this.inFlyTimes[this.inFlyTimes.length-1];b=Math.max(b(1),b(2),b(3),b(4),b(5),b(6));if(c<2*b&&128>c)return this.inFlyDeltas.push(c),this.inFlyTimes.push(a),this.ease=!0,this}this.ease=!1;return this}updateScrollTime(a){this.lastScrollTime=a;return this}updateFlyStartTime(a){this.flyStartTime=
a;return this}isTouchpadEaseDetected(){return this.ease}};z.SnapLimits.EPS=1E-5;z.SnapLimits.SCROLL_OUT_SNAP_TO_ENTITY_RATIO=1.6;z.SnapLimits.SCROLL_IN_SNAP_TO_ENTITY_RATIO=.6;z.SnapLimits.SCROLL_NON_TOPIC_TARGET_FLY_SPEED_MULTIPLIER=.5;z.SnapLimits.CENTER_DISTANCE_SCREEN_DIAGONAL_RATIO=.2;var K={};Object.defineProperty(K,"__esModule",{value:!0});const ba=f.CetModel.ID.Z_VIDEO;K.InteractionQueryImpl=class{constructor(){this.snapLimits=new z.SnapLimits}shouldTriggerScrollGesture(a,b,c,e,h){if(null==
a||null==a.getData().entity)return!1;const k=c.viewportInWorld().getCenter(),t=a.getData().entity;a=()=>{if(0===h&&g.CetModelEditor.isPlanetOrStack(t.getId(),e))return!0;let a=this.snapLimits.fillRatioForNavigationImprovements(t,c,e);switch(h){case 1:return a<this.snapLimits.getScrollOutSnapToEntityRatio()&&1<a;case 0:return a>this.snapLimits.getScrollInSnapToEntityRatio()&&1>a}};const H=()=>0===h?!0:-1<b.getEntitiesByWorldPoint(k).filter((a)=>a.is(g.HitTag.CLICKED_IN_WORLD_BOUNDS)).entities().map((a)=>
a.getId()).indexOf(t.getId()),I=()=>{if(0===h&&g.CetModelEditor.isPlanetOrStack(t.getId(),e))return!0;var a=d.Cet.world(t).getWorldBounds().getCenter();a=c.worldPointToScreen(a);const b=c.worldPointToScreen(k);var f=c.getStageArea();f=Math.sqrt(Math.pow(f.getWidth(),2)+Math.pow(f.getHeight(),2));return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))<f*this.snapLimits.getCenterDistanceScreenDiagonalRatio()};return c.getFocusedEntity()!==t.getId()&&(g.CetModelEditor.createTopicQuery(e).getTopicKind(t.getId())!==
g.TopicKind.None||t.isDef(f.CetModel.ID.Z_ZOOM_AREA))&&a()&&H()&&I()}getChapterOrFirstPageIfStack(a,b){let c=g.CetModelEditor.getPagesOfChapter(b,a);return 0<c.length?a.getEntityById(c[0]):a.getEntityById(b)}getParentChapterOrOverview(a,b){b=d.Cet.createHierarchyQuery(a).getAncestorEntities(b.getId()).filter((b)=>g.CetModelEditor.isOverview(b,a)||g.CetModelEditor.isPlanet(b,a));return a.getEntityById(b[0])}getEntityForScrollOut(a,b,c,e,h,k){if(this.isInFreeZoomingCoverEditMode(k))return null;if(e.getFocusedEntity()===
h.getId())return this.getParentChapterOrOverview(a,h);c=b.getEntitiesByWorldPoint(c).apply(b.strategies().general(!0)).apply(b.strategies().replaceCoverWithTopic(a)).filter((c)=>this.shouldTriggerScrollGesture(c,b,e,a,1)).entities().map((b)=>null!=b&&g.CetModelEditor.createTopicQuery(a).getTopicKind(b.getId())===g.TopicKind.Stack?this.getParentChapterOrOverview(a,b):b)[0];if(null!=c)return c;c=this.snapLimits.fillRatioForNavigationImprovements(h,e,a);return c>this.snapLimits.getScrollOutSnapToEntityRatio()?
null:1<c?h:this.getParentChapterOrOverview(a,h)}isInFreeZoomingCoverEditMode(a){if(null==a)return!1;switch(a.kind){case p.CoverEditModeKind.advanced:case p.CoverEditModeKind.insideAdvanced:return!0;case p.CoverEditModeKind.titleEditOnly:return!1;default:return y.Utils.assertNever(a)}}getEntityForScrollIn(a,b,c,e,h){c=this.clickScrollInCommon(c,b,a).apply(b.strategies().prioritizeTopic(h.getId(),a)).filter((c)=>this.shouldTriggerScrollGesture(c,b,e,a,0)).firstEntity();return null!=c&&g.CetModelEditor.isPlanetOrStack(c.getId(),
a)?this.getChapterOrFirstPageIfStack(a,c.getId()):c}clickScrollInCommon(a,b,c){return b.getEntitiesByWorldPoint(a).apply(b.strategies().general()).filter((a)=>a.is(g.HitTag.ENABLED)).apply(b.strategies().replaceCoverWithTopic(c))}getEntityForClickInPlaybackMode(a,b,c,e){return this.clickScrollInCommon(a,b,c).apply(b.strategies().prioritizeTopic(null==e?null:e.getId(),c,(a)=>a.isDef(ba)?!0:a.isDef(f.CetModel.ID.HAS_HYPERLINK)&&""!==a.getWrapper(f.CetModel.ID.HAS_HYPERLINK.W).getHyperlink())).firstEntity()}isTopicEntity(a,
b){a=g.CetModelEditor.createTopicQuery(b).getTopicKind(a.getId());return a===g.TopicKind.Planet||a===g.TopicKind.Stack}isEntityASelectedTopic(a,b,c){return null!=a&&this.isTopicEntity(a,c)&&1===b.length&&b[0]===a.getId()}getEntityForClickInEditMode(a,b,c,e,h,k,d=null){d=this.getEntityUnderPointInEditMode(a,b,c,e,!0,d);const t=n.MouseInteractionType.Click;this.isEntityASelectedTopic(d,h,c)&&k===t&&(b=this.getEntityUnderPointInEditMode(a,b,c,e,!1,null),a.queryableInTitleEditOnlyMode(b)&&(d=b));return d}getEntityHitsUnderPointInEditMode(a,
b,c,e,h=!0,k=null){b=b.screenPointToWorld(e);b=a.getEntitiesByWorldPoint(b).apply(a.strategies().general());h&&(b=b.apply(a.strategies().replaceCoverWithTopic(c)));k&&(b=b.apply(F.SelectionModule.restrictToEntityAndCtrlPointsSQStrategy(k,c)));return b}getEntityUnderPointInEditMode(a,b,c,e,h=!0,k=null){return this.getEntityHitsUnderPointInEditMode(a,b,c,e,h,k).firstEntity()}getEntityForHoverInEditMode(a,b,c,e,h,k,d){if(!k)return null;k=this.getEntityUnderPointInEditMode(a,b,c,e,!0);if(!k)return null;
1===h.length&&(d=null!=d&&d.isEditing()?h[0]:null,h=h[0]!==k.getId(),b=this.getEntityUnderPointInEditMode(a,b,c,e,h,d),null!=b&&a.queryableInTitleEditOnlyMode(b)&&(k=b));return k}getEntityForDragStartInEditMode(a,b,c,e,h=!0,k=null){return this.getEntityHitsUnderPointInEditMode(a,b,c,e,h,k).apply(a.strategies().excludeEntitiesOnLogoLayer()).firstEntity()}};var C={};Object.defineProperty(C,"__esModule",{value:!0});C.DollyGripImpl=class{constructor(a){this.logger=E.LoggerModule.getLoggerManager().createLogger("prezi_cet.DollyGrip");
this.stage=a;this.cameraNavigationBus=l.Bacon.newBus();this.cameraCancelledNavigationBus=l.Bacon.newBus()}getDollyCameraNavigationStream(){return this.cameraNavigationBus}getDollyCancelledNavigationStream(){return this.cameraCancelledNavigationBus}executeAction(a,b,c,e,h){b=a.getEntityById(this.getPlaybackPath().getPathStepEntityId(c));var k=c.getAction()-1;b=b.getWrapper(f.CetModel.ID.PATH_STEP.W).getActions().getAt(k).getEntity();k=g.CetModelEditor.createPlaybackPathQuery(a).getTargetEntitiesForActionById(b.getId()).allIds;
if(0<k.length){if(b.isDef(f.CetModel.ID.FADE_IN_OBJECT)||b.isDef(f.CetModel.ID.FADE_IN_OBJECTS))return a=this.extendScopeOfPathAction(a,k),this.fadeIn(a,e,c);if(b.isDef(f.CetModel.ID.FADE_OUT_OBJECT)||b.isDef(f.CetModel.ID.FADE_OUT_OBJECTS))return a=this.extendScopeOfPathAction(a,k),this.fadeOut(a,e,c);if(b.isDef(f.CetModel.ID.ZOOM_TO_OBJECT)||b.isDef(f.CetModel.ID.ZOOM_TO_OVERVIEW))return this.navigateTo(k[0],e,h)}return this.navigationError(d.NavigationActionAnimationType.Fly,"unknown_pathaction_type ")}getStepIndexForPathStepId(a){const b=
this.getPlaybackPath();let c=0,e=null;for(const h of b.getSteps().items())h===a&&(e=c),c++;return e}getTargetEntityForActionById(a){a=this.stage.getModelScene().getEntityById(a);if(a.isDef(f.CetModel.ID.HAS_TARGET))return a.getWrapper(f.CetModel.ID.HAS_TARGET.W).getTarget();if(a.isDef(f.CetModel.ID.ZOOM_TO_OVERVIEW))return this.stage.getModelScene().getPreziW().getOverview().getId();this.logger.error({action:"noTargetOnAction",object:"action",trigger:"machine"});return null}findPrevFocusedEntity(a){let b=
this.getPlaybackPath().getPathStepEntityId(a);var c=this.stage.getModelScene().getEntityById(b);let e=c.isDef(f.CetModel.ID.FLY_TO_OBJECT)?c.getWrapper(f.CetModel.ID.FLY_TO_OBJECT.W).getTarget():this.stage.getModelScene().getPreziW().getOverview().getId();c=c.getWrapper(f.CetModel.ID.PATH_STEP.W);let h=this.getStepIndexForPathStepId(b),k=1;c.getActions().forEach((b)=>{let c=this.stage.getModelScene().getEntityById(b.getId()),d=this.getPlaybackPath().getPathPosition(h,k);(d.isBefore(a)||d.isSame(a))&&
(c.isDef(f.CetModel.ID.ZOOM_TO_OBJECT)||c.isDef(f.CetModel.ID.ZOOM_TO_OVERVIEW))&&(e=this.getTargetEntityForActionById(b.getId()));k++});return e}cameraEventCallback(a,b,c){c.onValue((c)=>{let e=new Y(a,b);c.phase===d.NavigationActionAnimationPhase.End?this.cameraNavigationBus.push(e):this.cameraCancelledNavigationBus.push(e)})}onPathNavigationEvent(a){if(null!=a.getNavOptions()&&a.getNavOptions().cameraNavigationType===d.CameraNavigationType.NONE)a=new Y(a,a.getNavigationMode()),this.cameraNavigationBus.push(a);
else if(null==a.getToTargetId())this.cameraEventCallback(a,d.NavigationMode.JUMP,this.stage.flyToOverview());else if(null==a.getToPos())this.cameraEventCallback(a,a.getNavigationMode(),this.stage.flyToId(a.getToTargetId(),d.CameraNavigationTrigger.path));else{let b=null!=a.getFromPos()&&a.getFromPos().getStep()===a.getToPos().getStep()&&a.getFromPos().getAction()+1===a.getToPos().getAction()&&0!==a.getToPos().getAction()?this.executeAction(this.stage.getModelScene(),a.getFromPos(),a.getToPos(),a.getNavigationMode(),
a.getNavOptions()):this.navigateTo(this.findPrevFocusedEntity(a.getToPos()),a.getNavigationMode(),a.getNavOptions());this.cameraEventCallback(a,a.getNavigationMode(),b)}}extendScopeOfPathAction(a,b){a=d.Cet.createTopicChildrenQuery(a);let c=[];for(let e of b)c.push(...a.getChildrenIdsVisibleOutside(e),e);return c}navigationError(a,b){this.logger.error({action:b,object:"dolly",trigger:"machine"});return l.Bacon.once({id:null,targetType:d.NavigationActionTargetType.ToId,animationType:a,phase:d.NavigationActionAnimationPhase.End})}navigateTo(a,
b,c){null==a&&this.navigationError(d.NavigationActionAnimationType.Fly,"no_peer_to_fly_to_with_id ");switch(b){case d.NavigationMode.NEW_TRANSITION:return null!=c?this.stage.snapToId(a,d.CameraNavigationTrigger.path,c.cameraNavigationType,c.speedMultiplyer):this.stage.flyToId(a,d.CameraNavigationTrigger.path);case d.NavigationMode.JUMP:return this.stage.focusToId(a,!1,d.CameraNavigationTrigger.path);case d.NavigationMode.INVERSE_ACCELERATE:return this.stage.inverseFlight(a,C.DollyGripImpl.SPEED_UP_FACTOR);
case d.NavigationMode.INVERSE_ACCELERATE_2:return this.stage.inverseFlight(a,C.DollyGripImpl.SPEED_UP_JUMP);case d.NavigationMode.ACCELERATE:let e=l.Bacon.newBus();this.getCamera().accelerateCurrentTransition(C.DollyGripImpl.SPEED_UP_FACTOR);this.getCamera().whenTransitionFinished((a)=>{e.push({targetType:d.NavigationActionTargetType.ToId,animationType:d.NavigationActionAnimationType.Fly,phase:a?d.NavigationActionAnimationPhase.End:d.NavigationActionAnimationPhase.Cancel});e.end()});return e;case d.NavigationMode.ACCELERATE_2:let h=
l.Bacon.newBus();this.getCamera().accelerateCurrentTransition(C.DollyGripImpl.SPEED_UP_JUMP);this.getCamera().whenTransitionFinished((a)=>{h.push({targetType:d.NavigationActionTargetType.ToId,animationType:d.NavigationActionAnimationType.Fly,phase:a?d.NavigationActionAnimationPhase.End:d.NavigationActionAnimationPhase.Cancel});h.end()});return h;default:throw Error("invalid NavigationMode");}}fireFadeForEntity(a,b){let c=null;for(let e of a)c=b?this.stage.fadeInPeerById(e):this.stage.fadeOutPeerById(e);
return c}fadeIn(a,b){0===a.length&&this.navigationError(d.NavigationActionAnimationType.FadeIn,"no_peer_to_fly_to_with_id ");switch(b){case d.NavigationMode.NEW_TRANSITION:return this.fireFadeForEntity(a,!0);default:return l.Bacon.once({id:"",targetType:d.NavigationActionTargetType.ToId,animationType:d.NavigationActionAnimationType.FadeIn,phase:d.NavigationActionAnimationPhase.End})}}fadeOut(a,b){0===a.length&&this.navigationError(d.NavigationActionAnimationType.FadeIn,"no_peer_to_fly_to_with_id ");
switch(b){case d.NavigationMode.NEW_TRANSITION:return this.fireFadeForEntity(a,!1);default:return l.Bacon.once({id:"",targetType:d.NavigationActionTargetType.ToId,animationType:d.NavigationActionAnimationType.FadeOut,phase:d.NavigationActionAnimationPhase.End})}}getCamera(){return this.stage.getCamera()}getPlaybackPath(){return this.stage.getPathNavigator().getPath()}};C.DollyGripImpl.SPEED_UP_FACTOR=2;C.DollyGripImpl.SPEED_UP_JUMP=1E4;class Y{constructor(a,b){this.pathNavigationEvent=a;this.navigationMode=
b}getPathNavigationEvent(){return this.pathNavigationEvent}toString(){return"CameraNavigationEvent: ["+(null==this.pathNavigationEvent?"":this.pathNavigationEvent.toString())+" ] ; mode: "+(null==this.navigationMode?"":d.NavigationMode[this.navigationMode])}}var N={};Object.defineProperty(N,"__esModule",{value:!0});var G;(function(a){a.move="move";a.end="end"})(G||(G={}));N.CanvasInteraction=class{constructor(a,b,c,e,h,d,t,f,g,m,n,r,q){this.playback=a;this.hitTest=b;this.scene=c;this.mouseInteractionStream=
e;this.keyboardEventStream=h;this.currentTopicStream=d;this.interactionHandler=t;this.zoomEventStream=f;this.isFollowerStream=g;this.modeStream=n;this.interactionModeStream=q;this.modeStream.onValue(()=>this.mode);this.urlUtils=y.Utils.createUrlUtils();this.coverEditMode=null;this.logger=E.LoggerModule.getLoggerManager().createLogger("prezi_playback.CanvasInteraction");this.initMouseStream();this.handleVideoInteractions();this.mouseCursorStateActionBus=l.Bacon.newBus();this.recalculateEntityUnderMouseActionStreamOnPanning=
l.Bacon.newBus();this.recalculateEntityUnderMouseActionStream=this.createRecalculateEntityUnderMouseActionStream(a.getStage().getCamera().getZoomingStream(),this.recalculateEntityUnderMouseActionStreamOnPanning);this.mouseCursorStateStream=this.createMouseCursorStateStream(a.getStage().getCamera().getZoomingStream(),this.mouseCursorStateActionBus,this.mouseInteractionStream,this.modeStream,this.currentTopicStream,this.recalculateEntityUnderMouseActionStream);m.onValue((a)=>this.coverEditMode=a);r.onValue((a)=>
this.selection=a);this.urlClickedStream=l.Bacon.newBus();this.interactionQuery=new K.InteractionQueryImpl}handleZoomEvent(a){this.playback.getStage().getCamera().cancelPanning();let b;switch(a.zoomEvent){case q.ZoomEvent.ZOOM_IN:b=2;break;case q.ZoomEvent.ZOOM_OUT:b=3;break;case q.ZoomEvent.HOME:b=4;break;default:y.Utils.assertNever(a.zoomEvent)}this.interactionHandler.handleUserNavigation(this.scene,this.getStageQuery(),{x:0,y:0},0,b,a.currentTopicId,!0,this.coverEditMode,this.selection)}getCurrentTopicActionStream(){return this.interactionHandler.getCurrentTopicActionStream()}getHoverStream(){return this.hoverStream}createMouseCursorStateStream(a,
b,c,e,h,k){c=c.filterWithStream(e.map((a)=>a.kind!==m.EditorMode.edit)).filter((a)=>a.type===n.MouseInteractionType.HoverMove);e=c.map(()=>null).merge(k);h=l.Bacon.combineWith3((a,b)=>{let c="default";var e=this.getWorldPoint(a);b=this.scene.getEntityById(this.getEntityIdUnderPos(e,b));null!=b&&(e=g.CetModelEditor.createTopicQuery(this.scene).getTopicKind(b.getId()),e===g.TopicKind.Page||e===g.TopicKind.Stack||e===g.TopicKind.Planet||b.isDef(f.CetModel.ID.Z_ZOOM_AREA)||b.isDef(f.CetModel.ID.Z_VIDEO)||
g.CetModelEditor.isClickableNextLogo(b.getId(),this.scene)||""!==this.getUrl(b,a.event.stagePos))&&(c="pointer");return{cursor:c}},c,h,k).sampledBy(e);a=a.filterWithStream(l.Bacon.once(!u.isActive("js-unique-differentiation")).toProperty()).map((a)=>{switch(a){case d.ZoomingEvent.ZoomIn:return{cursor:"zoom-in"};case d.ZoomingEvent.ZoomOut:return{cursor:"zoom-out"};case d.ZoomingEvent.NoZoom:return{cursor:"default"}}}).merge(b).merge(h);return l.Bacon.combineWith((a,b)=>a?{cursor:"default"}:b,this.isFollowerStream,
a).changes()}createRecalculateEntityUnderMouseActionStream(a,b){return a.map((a)=>a===d.ZoomingEvent.NoZoom).filter((a)=>a).merge(b)}getMouseCursorStateStream(){return this.mouseCursorStateStream}getRecalculateEntityUnderMouseActionStream(){return this.recalculateEntityUnderMouseActionStream}mouseInteractionFilter(a){return(b)=>b.interaction.type===a}mouseInteractionsFilter(a){return(b)=>-1<a.indexOf(b.interaction.type)}isObjectEvent(a){return null!=a.entityId}getEntityIdUnderPos(a,b){const c=this.getStageQuery();
a=this.interactionQuery.getEntityForClickInPlaybackMode(a,c,this.scene,this.scene.getEntityById(b));return null==a?null:a.getId()}getWorldPoint(a){return this.playback.getStage().getCamera().screenPointToWorld(a.event.stagePos)}handleVideoInteractions(){const a=new Set;let b=null;l.Bacon.combineWith((a,b)=>({cmi:a,mode:b}),this.complexMouseStream,this.modeStream).onValue(({cmi:c,mode:e})=>{if(e.kind===m.EditorMode.edit){for(const b of a)d.Cet.sendEvent(this.scene,b,{kind:r.DrawComponentFocusEventKind.Lost}),
d.Cet.sendEvent(this.scene,b,{kind:r.DrawComponentMouseEventWithoutPositionKind.Deactivate});a.clear();b=null}else e=c.videoEntityId,e!==b&&(d.Cet.sendEvent(this.scene,b,{kind:r.DrawComponentMouseEventWithoutPositionKind.Leave}),d.Cet.sendEvent(this.scene,e,{kind:r.DrawComponentMouseEventWithoutPositionKind.Activate})),null!=e&&(a.add(e),d.Cet.sendEvent(this.scene,e,{kind:r.DrawComponentMouseEventKindWithPosition.Move,isEntering:e!==b,isClick:c.interaction.type===n.MouseInteractionType.Click,worldX:c.worldPoint.x,
worldY:c.worldPoint.y}),c.interaction.type===n.MouseInteractionType.DoubleClick&&(c=this.scene.getEntityById(e),null!=c&&this.interactionHandler.flyTo(c))),b=e})}initMouseStream(){this.complexMouseStream=this.createComplexMouseStream().filterWithStream(this.isFollowerStream.map((a)=>!a));this.hoverStream=this.complexMouseStream.filterWithStream(this.modeStream.map((a)=>a.kind!==m.EditorMode.edit)).filter((a)=>a.interaction.type===n.MouseInteractionType.HoverMove).map((a)=>a.entityId).skipDuplicates();
var a=this.complexMouseStream.filter(this.mouseInteractionsFilter([n.MouseInteractionType.DragMove,n.MouseInteractionType.DragEnd])),b=this.complexMouseStream.filterWithStream(this.modeStream.map((a)=>a.kind===m.EditorMode.edit)).filter(this.mouseInteractionsFilter([n.MouseInteractionType.DragMoveRight,n.MouseInteractionType.DragEndRight]));a=l.Bacon.mergeAll([a,b]).filterWithStream(this.playback.getStage().getCamera().getTransitionStream().map((a)=>a===d.TransitionEvent.TransitionFinished).toProperty(!0)).map((a)=>
({type:a.interaction.type===n.MouseInteractionType.DragMove||a.interaction.type===n.MouseInteractionType.DragMoveRight?G.move:G.end,baseStagePos:a.interaction.baseEvent.stagePos,stagePos:a.interaction.event.stagePos}));this.isPanningStream=a.map((a)=>a.type===G.move).skipDuplicates();b=this.complexMouseStream.filter(this.mouseInteractionFilter(n.MouseInteractionType.Click));const c=this.complexMouseStream.map((a)=>a.interaction).filter((a)=>a.type===n.MouseInteractionType.Scroll);l.Bacon.combineWith((a,
b)=>({click:a,mode:b}),b,this.modeStream).sampledBy(b).filter((a)=>this.isObjectEvent(a.click)).onValue((a)=>this.handleClickOnObject(a.click,a.mode.kind));b.filter((a)=>!this.isObjectEvent(a)).onValue((a)=>this.handleClickOnBg(a));const e=Z.PreziUAParser.isMac();u.isActive("js-unique-differentiation")&&this.initInteractionsWithTouchpad(c,a,e);this.initInteractionsWithMouse(c,a,e);this.currentTopicStream.combineAndSample((a,b)=>({zoomEvent:b,currentTopicId:a}),this.zoomEventStream).onValue((a)=>this.handleZoomEvent(a));
a=this.currentTopicStream.combineAndSample((a,b)=>({zoomEvent:b,currentTopicId:a}),this.keyboardEventStream.filter((a)=>e?a.metaKey:a.altKey).filter((a)=>a.keyCode===n.Key.UP_ARROW||a.keyCode===n.Key.DOWN_ARROW).map((a)=>a.keyCode===n.Key.UP_ARROW?q.ZoomEvent.ZOOM_IN:q.ZoomEvent.ZOOM_OUT));a.onValue((a)=>this.handleKeyboardZoom(a));a.debounce(1E3).onValue(this.logKeyboardZoom)}initInteractionsWithTouchpad(a,b,c){const e=l.Bacon.combineWith((a,b)=>a.kind===X.InteractionKind.touchpad&&b.kind===m.EditorMode.edit,
this.interactionModeStream,this.modeStream),h=a.filter((a)=>!a.event.ctrlKey);a=a.filter((a)=>a.event.ctrlKey);l.Bacon.combineWith((a,b)=>({interaction:a,currentTopicId:b}),h,this.currentTopicStream).sampledBy(h).filterWithStream(e).onValue(({interaction:a,currentTopicId:b})=>this.handlePanTouchpad(a,b));l.Bacon.combineWith3((a,b,c)=>({panData:b,currentTopicId:a,editorMode:c}),this.currentTopicStream,b,this.modeStream).sampledBy(b).filterWithStream(e).onValue(({panData:a,currentTopicId:b,editorMode:c})=>
this.handlePan(a,b,c.kind===m.EditorMode.edit));b=this.keyboardEventStream.map((a)=>a.altKey).toProperty(!1).skipDuplicates();l.Bacon.combineWith4((a,b,e,h)=>({currentTopicId:a,smartZooming:u.isActive("js-disable-auto-zoom-inside")&&e.kind===m.EditorMode.edit?h||b.event.altKey:c?!b.event.metaKey:!b.event.altKey,interaction:b}),this.currentTopicStream,a,this.modeStream,b).sampledBy(a).filterWithStream(e).filter(({interaction:a})=>0!==a.event.wheelDeltaY).onValue(({interaction:a,currentTopicId:b,smartZooming:c})=>
this.handleMouseScroll(a,b,c,!0))}initInteractionsWithMouse(a,b,c){const e=l.Bacon.combineWith((a,b)=>a.kind===X.InteractionKind.mouse||b.kind!==m.EditorMode.edit,this.interactionModeStream,this.modeStream);l.Bacon.combineWith3((a,b,c)=>({panData:b,currentTopicId:a,editorMode:c}),this.currentTopicStream,b,this.modeStream).sampledBy(b).filterWithStream(e).onValue(({panData:a,currentTopicId:b,editorMode:c})=>this.handlePan(a,b,c.kind===m.EditorMode.edit));l.Bacon.combineWith3((a,b,e)=>({currentTopicId:a,
smartZooming:u.isActive("js-disable-auto-zoom-inside")&&e.kind===m.EditorMode.edit?b.event.altKey:c?!b.event.metaKey:!b.event.altKey,interaction:b}),this.currentTopicStream,a,this.modeStream).sampledBy(a).filterWithStream(e).filter(({interaction:a})=>0!==a.event.wheelDeltaY).onValue(({interaction:a,currentTopicId:b,smartZooming:c})=>this.handleMouseScroll(a,b,c,!1))}createComplexMouseStream(){return this.currentTopicStream.combineAndSample((a,b)=>{const c=this.getWorldPoint(b),e=this.getEntityIdUnderPos(c,
a);var h=null==e?null:this.scene.getEntityById(e);h=null!=h&&h.isDef(f.CetModel.ID.Z_VIDEO)?h.getWrapper(f.CetModel.ID.Z_VIDEO.W):null;h=null==h||"video"!==h.getVideoType()?null:e;var d=g.CetModelEditor.createTopicQuery(this.scene).getTopicKind(a);d=d===g.TopicKind.Stack||d===g.TopicKind.Planet||d===g.TopicKind.Page;return{interaction:b,currentTopicId:a,entityId:e,worldPoint:c,videoEntityId:h,isLockedView:d}},this.mouseInteractionStream)}canZoomInOnEntity(a){return a.getDef()===f.CetModel.ID.Z_IMAGE||
a.getDef()===f.CetModel.ID.Z_ANIMATED_IMAGE||a.getDef()===f.CetModel.ID.Z_SHAPE||a.getDef()===f.CetModel.ID.Z_VIDEO||a.getDef()===f.CetModel.ID.Z_PDF||a.getDef()===f.CetModel.ID.Z_SWF_GRAPHICS||f.CetModel.textKludge.isEntityText(a)||a.getDef()===f.CetModel.ID.Z_CHART_PDF||a.getDef()===f.CetModel.ID.Z_ZOOM_AREA}handleClickOnBg(a){this.playback.flyToObject(a.currentTopicId)}handlePanTouchpad(a,b){var c=(new URLSearchParams(window.location.search)).get("panMultiplier");c=null!=c?Number.parseFloat(c):
1;const e=a.event.stagePos;null==this.panner&&(this.playback.getStage().getCamera().cancelZooming(),this.panner=q.createPanner(e,b,this.playback.getStage().getCamera(),this.scene,u.isActive("js-unique-differentiation")));this.panner.panMove({x:e.x+.05*a.event.wheelDeltaX*c,y:e.y+.05*a.event.wheelDeltaY*c});m.AppUtilsModule.getLogHelperUtils().canvasPan(this.logger,{actionIndex:this.playback.getCurrentActionIndex(),stepIndex:this.playback.getCurrentStepIndex(),totalStepNumber:this.playback.getStepCount()});
this.panner.panEnd();this.panner=null;this.recalculateEntityUnderMouseActionStreamOnPanning.push(!0)}handlePan(a,b,c){switch(a.type){case G.move:null==this.panner&&(this.playback.getStage().getCamera().cancelZooming(),this.panner=q.createPanner(a.baseStagePos,b,this.playback.getStage().getCamera(),this.scene,u.isActive("js-unique-differentiation")&&c),u.isActive("js-unique-differentiation")||this.mouseCursorStateActionBus.push({cursor:"-webkit-grabbing"}));this.panner.panMove(a.stagePos);break;case G.end:null!=
this.panner&&(m.AppUtilsModule.getLogHelperUtils().canvasPan(this.logger,{actionIndex:this.playback.getCurrentActionIndex(),stepIndex:this.playback.getCurrentStepIndex(),totalStepNumber:this.playback.getStepCount()}),this.panner.panEnd());u.isActive("js-unique-differentiation")||this.mouseCursorStateActionBus.push({cursor:"default"});this.panner=null;this.recalculateEntityUnderMouseActionStreamOnPanning.push(!0);break;default:throw y.Utils.assertNever(a.type);}}getIsPanningStream(){return this.isPanningStream}handleMouseScroll(a,
b,c,e){this.playback.getStage().getCamera().cancelPanning();let h=0<a.event.wheelDeltaY;e=(e||a.event.ctrlKey&&u.isActive("js-unique-differentiation")?5E-4:.05/1590)*Math.abs(a.event.wheelDeltaY)+1;this.interactionHandler.handleUserNavigation(this.scene,this.getStageQuery(),a.event.stagePos,e,h?0:1,b,c,this.coverEditMode,this.selection)}handleKeyboardZoom({currentTopicId:a,zoomEvent:b}){this.playback.getStage().getCamera().cancelPanning();b=b===q.ZoomEvent.ZOOM_IN?0:1;this.interactionHandler.handleUserNavigation(this.scene,
this.getStageQuery(),{x:0,y:0},3E3,b,a,!1,this.coverEditMode,this.selection)}logKeyboardZoom(){E.avro.Avro.createDefaultLogger().logUseKeyboardShortcut({shortcut_type:"ZOOM_IN_OUT_OF_THE_CANVAS"})}getUrl(a,b){b=this.playback.getStage().getCamera().screenPointToWorld(b);return this.hitTest.urlTest(a,b)}getUrlFromLogo(a){var b;return a.isDef(f.CetModel.ID.NEXT_LOGO_V1)?null===(b=a.getWrapper(f.CetModel.ID.NEXT_LOGO_V1.W))||void 0===b?void 0:b.getLinkUrl():null}openUrl(a){this.urlClickedStream.push(a);
window.open(this.urlUtils.getRedirectLink(a),"_blank")}handleClickOnObject(a,b){if(null==a.videoEntityId){var c=this.scene.getEntityById(a.entityId);c.isDef(f.CetModel.ID.LOGO)||c.isDef(f.CetModel.ID.NEXT_LOGO_V1)?(a=this.getUrlFromLogo(c),y.Utils.isEmptyString(a)||b===m.EditorMode.edit&&u.isActive("js-gm-watermark-paywall-on-click-and-present")||(E.avro.Avro.createDefaultLogger().logOpenWatermark(),this.openUrl(a))):(b=this.getUrl(c,a.interaction.event.stagePos),y.Utils.isEmptyString(b)?(!a.isLockedView||
this.canZoomInOnEntity(c)||g.CetModelEditor.isPlanetOrStack(c.getId(),this.scene))&&this.interactionHandler.flyTo(c):(E.avro.Avro.createDefaultLogger().logOpenHyperlink({hyperlink_url:b,object_id:c.getId(),object_type:c}),this.openUrl(b)));c.isDef(f.CetModel.ID.Z_VIDEO)&&this.mouseCursorStateActionBus.push({cursor:"auto"})}}setSceneStream(a){a.onValue((a)=>{this.scene=a})}getStageQuery(){return this.scene.getPrezi().get(x.PlaybackModuleImpl.getStageQueryKey())}getUrlClickedStream(){return this.urlClickedStream}};
N.CanvasInteraction.MOUSE_DIST_CLICK_THRESHOLD=2;var Q={};Object.defineProperty(Q,"__esModule",{value:!0});Q.InteractionHandler=class{constructor(a,b,c){this.stage=a;this.pathNavigator=c;this.logger=E.LoggerModule.getLoggerManager().createLogger("prezi_playback.InteractionHandler");this.snapLimits=new z.SnapLimits;this.camera=a.getCamera();this.currentTopicActionBus=l.Bacon.newBus();this.scene=b;this.interactionQuery=new K.InteractionQueryImpl}setEditModeStream(a){a.onValue((a)=>this.editorModeData=
a)}getCurrentTopicActionStream(){return this.currentTopicActionBus}getCurrentTopic(a,b){if(null==b)return a.getPreziW().getOverview().getEntity();if(a=a.getEntityById(b))return a;throw"Invalid current topic: "+a;}handleSceneChange(a,b,c){const e=g.CetModelEditor.createTopicQuery(c);if(a.kind===d.ChangeEventKind.Entity&&a.type===f.ChangeType.RemoveEntity&&a.entity.getId()===b.currentTopicId){a=null;for(let h of b.parentChapterIds)if(null!=c.getEntityById(h)&&(b=e.getTopicKind(h),b!==g.TopicKind.None)){b===
g.TopicKind.Stack?(c=g.CetModelEditor.getPagesOfChapter(h,c),0<c.length&&(a=c[0])):a=h;break}null!=a&&this.stage.snapToId(a,d.CameraNavigationTrigger.free,d.CameraNavigationType.SNAP_OUT,this.snapLimits.getCameraFlySpeedMultiplier())}}handleCameraNavigation(a,b){if(a.phase===d.NavigationActionAnimationPhase.Start&&a.animationType!==d.NavigationActionAnimationType.FadeIn&&a.animationType!==d.NavigationActionAnimationType.FadeOut&&!a.withoutCurrentTopicUpdate)if(null!=a.id&&null!=b.getEntityById(a.id)){var c=
b.getEntityById(a.id);const e=g.CetModelEditor.createTopicQuery(b);e.getTopicKind(c.getId())!==g.TopicKind.None?this.setCurrentTopic(c,a.animationType):d.Cet.visibility(c).isVisible()||(c=e.getTopicsWhereReachable(c,d.VisualBackgroundReachLevel.NONE),null!=c&&0<c.length&&(b=b.getEntityById(c[0]),this.setCurrentTopic(b,a.animationType)))}else this.setCurrentTopic(b.getPreziW().getOverview().getEntity(),a.animationType)}handleUserNavigation(a,b,c,e,h,d,f,g,I){d=this.getCurrentTopic(a,d);this.stage.getCamera().setCameraOnPath(!1);
switch(h){case 0:case 2:this.scrollIn(a,b,c,e,d,h,f,g);break;case 1:this.scrollOut(a,b,c,e,d,f,g,I);break;case 3:this.zoomOut(a,b,d);break;case 4:this.zoomHome(a,d);break;default:y.Utils.assertNever(h)}}isOverviewOrTopicId(a,b){return g.CetModelEditor.isPlanetOrStack(a,b)||g.CetModelEditor.isPage(a,b)||a===b.getPreziW().getOverview().getId()}flyTo(a){let b=a.getId();if(g.CetModelEditor.isPlanetOrStack(b,this.stage.getModelScene())){let a=g.CetModelEditor.getPagesOfChapter(b,this.stage.getModelScene());
0<a.length&&(b=a[0])}m.AppUtilsModule.getLogHelperUtils().zoomToObject(g.CetModelEditor.createLogHelper(this.stage.getModelScene()),this.logger,m.ZoomToObjectLogTrigger.CLICK,a,this.stage.getModelScene(),{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()});a=this.snapLimits.getCameraFlySpeedMultiplier(!0);this.flyToObject(b,d.CameraNavigationType.SNAP_IN,a,!1)}scrollIn(a,b,c,e,h,k,f,l){let t=(new Date).getTime();
if(this.stage.getCurrentCameraNavigation()===d.CameraNavigationType.SNAP_IN&&this.camera.isInTransition())this.snapLimits.collectScrollEvent(t);else if(this.snapLimits.addEventMeasurement(t),!this.snapLimits.isTouchpadEaseDetected()){this.snapLimits.resetScrollMeasurements();b=this.interactionQuery.getEntityForScrollIn(a,b,this.camera.screenPointToWorld(c),this.camera,h);k=0===k?m.ZoomToObjectLogTrigger.SCROLL_IN:m.ZoomToObjectLogTrigger.ZOOM_IN;var H=null;if(null!=l)switch(l.kind){case p.CoverEditModeKind.advanced:case p.CoverEditModeKind.titleEditOnly:H=
l.topicId;break;case p.CoverEditModeKind.insideAdvanced:g.CetModelEditor.isOverview(l.topicOrOverviewId,a)||(H=l.topicOrOverviewId);break;default:y.Utils.assertNever(l)}f&&null!=b&&b.getId()!==H&&!this.isEntityPageOfChapter(a,H,b)&&b.getId()!==h.getId()?(m.AppUtilsModule.getLogHelperUtils().zoomToObject(g.CetModelEditor.createLogHelper(a),this.logger,k,b,this.stage.getModelScene(),{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),
c=b.getId(),h=this.snapLimits.getCameraFlySpeedMultiplier(c!==h.getId()&&this.isOverviewOrTopicId(c,a)),this.flyToObject(c,d.CameraNavigationType.SNAP_IN,h,!1)):(m.AppUtilsModule.getLogHelperUtils().canvasZoom(this.logger,k,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),a=d.Cet.createScreenBoundsCalculator(a,this.camera),this.camera.startBoundedZoom(this.scene,{direction:d.ZoomingDirection.ZOOM_IN,zoomingCenter:c,
wheelDelta:e,boundsWithin:a.getMarginCorrectedViewportForEntity(h),isInstant:this.editorModeData.kind===m.EditorMode.edit&&u.isActive("js-unique-differentiation")}));this.snapLimits.updateScrollTime(t)}}isEntityPageOfChapter(a,b,c){a=this.parent(a,c);return!!a&&a.getId()===b}cameraCloseToOverview(a,b){return this.camera.getTransform().getScale()<1.02*d.Cet.getTargetTransform(a,b,this.camera.getViewport()).getScale()}scrollOut(a,b,c,e,h,k,f){var t=(new Date).getTime();const l=a.getPreziW().getOverview().getId();
this.stage.getCurrentCameraNavigation()===d.CameraNavigationType.SNAP_OUT&&this.camera.isInTransition()?this.snapLimits.collectScrollEvent(t):h.getId()===l&&this.cameraCloseToOverview(a,l)?(t=(null===f||void 0===f?void 0:f.kind)===p.CoverEditModeKind.insideAdvanced?{direction:d.ZoomingDirection.ZOOM_OUT,unlimitedZoomOut:!0,zoomingCenter:c,wheelDelta:e,isInstant:this.editorModeData.kind===m.EditorMode.edit&&u.isActive("js-unique-differentiation")}:{direction:d.ZoomingDirection.ZOOM_OUT,unlimitedZoomOut:!1,
zoomingCenter:c,wheelDelta:e,currentTopicId:h.getId(),isInstant:this.editorModeData.kind===m.EditorMode.edit&&u.isActive("js-unique-differentiation")},this.camera.startBoundedZoom(this.scene,t)):(this.snapLimits.updateScrollTime(t),this.snapLimits.addEventMeasurement(t),this.snapLimits.isTouchpadEaseDetected()||(this.snapLimits.resetScrollMeasurements(),b=this.interactionQuery.getEntityForScrollOut(a,b,this.camera.screenPointToWorld(c),this.camera,h,f),k&&null!=b?(m.AppUtilsModule.getLogHelperUtils().zoomToObject(g.CetModelEditor.createLogHelper(a),
this.logger,m.ZoomToObjectLogTrigger.SCROLL_OUT,b,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),c=b.getId(),a=this.snapLimits.getCameraFlySpeedMultiplier(c!==h.getId()&&this.isOverviewOrTopicId(c,a)),this.flyToObject(c,d.CameraNavigationType.SNAP_OUT,a)):(m.AppUtilsModule.getLogHelperUtils().canvasZoom(this.logger,m.ZoomToObjectLogTrigger.SCROLL_OUT,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),
totalStepNumber:this.pathNavigator.getPath().getStepCount()}),a=(null===f||void 0===f?void 0:f.kind)===p.CoverEditModeKind.insideAdvanced?{direction:d.ZoomingDirection.ZOOM_OUT,unlimitedZoomOut:!0,zoomingCenter:c,wheelDelta:e,isInstant:this.editorModeData.kind===m.EditorMode.edit&&u.isActive("js-unique-differentiation")}:{direction:d.ZoomingDirection.ZOOM_OUT,unlimitedZoomOut:!1,zoomingCenter:c,wheelDelta:e,currentTopicId:h.getId(),isInstant:this.editorModeData.kind===m.EditorMode.edit&&u.isActive("js-unique-differentiation")},
this.camera.startBoundedZoom(this.scene,a)),this.snapLimits.updateScrollTime(t)))}flyToObject(a,b=d.CameraNavigationType.FLY,c=1,e=!0){var h;g.CetModelEditor.setCameraAndPathFor({navigationControl:this.stage,speedMultiplyer:c,pathPosition:g.CetModelEditor.getPathPositionForTarget({allowForwardActions:(null===(h=this.editorModeData)||void 0===h?void 0:h.kind)===m.EditorMode.edit,findClosestPathPositionWithTarget:e,navigationControl:this.stage,targetId:a})});switch(b){case d.CameraNavigationType.FOCUS:return this.stage.focusToId(a,
!1,d.CameraNavigationTrigger.free);case d.CameraNavigationType.FLY:case d.CameraNavigationType.NONE:return this.stage.flyToId(a,d.CameraNavigationTrigger.free,c);case d.CameraNavigationType.SNAP_IN:case d.CameraNavigationType.SNAP_OUT:return this.stage.snapToId(a,d.CameraNavigationTrigger.free,b,c)}}zoomOut(a,b,c){if(this.currentZoomOutTargetId){b=this.parent(a,a.getEntityById(this.currentZoomOutTargetId));if(null==b)return;g.CetModelEditor.isPage(c.getId(),a)&&(b=this.parent(a,b))}else if(this.shouldSnapToCurrentTopic(c,
this.snapLimits.getZoomOutToCurrentBound())&&!this.currentZoomOutTargetId)b=c;else{b=this.parent(a,c);if(null==b)return;g.CetModelEditor.isPage(c.getId(),a)&&(b=this.parent(a,b))}null!=b&&(c=b.getId(),m.AppUtilsModule.getLogHelperUtils().zoomToObject(g.CetModelEditor.createLogHelper(a),this.logger,m.ZoomToObjectLogTrigger.ZOOM_OUT,b,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),this.flyToObject(c,d.CameraNavigationType.SNAP_OUT,
this.snapLimits.getCameraFlySpeedMultiplier()).onValue(()=>{this.currentZoomOutTargetId=null}))}zoomHome(a,b){const c=a.getPreziW().getOverview().getEntity();m.AppUtilsModule.getLogHelperUtils().zoomToObject(g.CetModelEditor.createLogHelper(a),this.logger,m.ZoomToObjectLogTrigger.HOME,c,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()});b.getId()===c.getId()&&this.cameraCloseToOverview(a,c.getId())?(a=d.Cet.world(c).getWorldAxisAlignedBounds(),
b=D.Geometry.transform2dIdentity(),this.stage.flyToRectangle(b.scaleAroundPoint(a.getCenter(),1.1).transformRectangle(a),D.Geometry.transform2dIdentity(),.3,c.getId(),this.camera.getMarginCorrectedViewport()),setTimeout(()=>{this.stage.flyToOverview()},300)):this.stage.flyToOverview();this.pathNavigator.go(g.CetModelEditor.getPathPositionForTarget({navigationControl:this.stage,targetId:c.getId()}),{cameraNavigationType:d.CameraNavigationType.NONE,speedMultiplyer:1})}setCurrentTopic(a,b){this.currentTopicActionBus.push({newCurrentTopic:a.getId(),
navigationType:b})}shouldSnapToCurrentTopic(a,b){if(null==a)return!1;a=this.snapLimits.fillRatio(a,this.camera);return b<a}getCurrentActionIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getAction()}getCurrentStepIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getStep()}parent(a,b){if(b.isDef(f.CetModel.ID.OVERVIEW))return null;b=a.getEntityById(d.Cet.createHierarchyQuery(a).getParentId(b));
return null==b?a.getPreziW().getOverview().getEntity():b}};var R={};Object.defineProperty(R,"__esModule",{value:!0});R.NavigationAndSceneEventHandler=class{constructor(a){this.interactionHandler=a;this.sceneChangeBus=l.Bacon.newBus();this.currentTopicAndParents={currentTopicId:null,parentChapterIds:null}}_collectParents(a,b){a=d.Cet.createHierarchyQuery(this.scene).getAncestorEntities(a).filter((a)=>g.CetModelEditor.isPlanetOrStack(a,this.scene));a=0<a.length?a[0]:null;return null==a?b.concat([this.scene.getPreziW().getOverview().getId()]):
this._collectParents(a,b.concat([a]))}collectParents(a){return null==a?null==this.scene.getPreziW().getOverview()?[]:[this.scene.getPreziW().getOverview().getId()]:this._collectParents(a,[])}setupSceneChangeHandler(a){a.onValue((a)=>{null!=this.scene&&(this.currentTopicAndParents={currentTopicId:a,parentChapterIds:this.collectParents(a)})});this.sceneChangeBus.onValue((a)=>{if(null!=this.scene)for(let b of a)this.interactionHandler.handleSceneChange(b,this.currentTopicAndParents,this.scene,this.getStageQuery());
else throw"CameraNavigationHandler:Scene is not initialized";})}setCameraNavigationStream(a){a.onValue((a)=>{if(null!=this.scene)this.interactionHandler.handleCameraNavigation(a,this.scene,this.getStageQuery());else throw"CameraNavigationHandler:Scene is not initialized";})}setSceneStream(a){a.onValue((a)=>{this.scene=a})}setEntityChangeStream(a){this.sceneChangeBus.plug(a)}getStageQuery(){return this.scene.getPrezi().get(x.PlaybackModuleImpl.getStageQueryKey())}};var J={};Object.defineProperty(J,
"__esModule",{value:!0});J.PlaybackVisibilityQuery=class{setupVisibilityOfPathActionTarget(a,b,c,e,d,k,g){if(a.isBefore(b)||a.isSame(b)){if(c.isDef(f.CetModel.ID.FADE_OUT_OBJECT)||c.isDef(f.CetModel.ID.FADE_OUT_OBJECTS))g(e,!1),this.setTarget(d,e,k);if(c.isDef(f.CetModel.ID.FADE_IN_OBJECT)||c.isDef(f.CetModel.ID.FADE_IN_OBJECTS))g(e,!0),this.setTarget(d,e,k)}if(a.isAfter(b)&&(a=d[e],null==a||k<a)){if(c.isDef(f.CetModel.ID.FADE_OUT_OBJECT)||c.isDef(f.CetModel.ID.FADE_OUT_OBJECTS))g(e,!0),this.setTarget(d,
e,k);if(c.isDef(f.CetModel.ID.FADE_IN_OBJECT)||c.isDef(f.CetModel.ID.FADE_IN_OBJECTS))g(e,!1),this.setTarget(d,e,k)}}setTarget(a,b,c){let e=a[b];if(null==e||c<e)a[b]=c}collectVisibilitiesOnPathPosition(a,b,c){const e=g.CetModelEditor.createPlaybackPathQuery(a),h=d.Cet.createHierarchyQuery(a);let f={},t=0;a.getPreziW().getPath().forEach((a)=>{let k=0;a.getActions().forEach((a)=>{const g=d.Cet.pathPositionFromStepIndex_killMe(t,k+1);a=a.getEntity();var l=e.getTargetEntitiesForActionById(a.getId()).allIds;
for(let e of l){this.setupVisibilityOfPathActionTarget(g,b,a,e,f,0,c);l=h.getDescendantEntities([e]);for(let d of l)l=h.getChildParentDistance(d,e),this.setupVisibilityOfPathActionTarget(g,b,a,d,f,l,c)}k++});t++});a.getPreziW().getBackground().getLayers().forEach((a)=>{a=a.getEntity();c(a.getId(),!0)})}createGeneralVisibilityFilter(a){return(b)=>{b=a.getEntityById(b);return!(b.get(f.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER)&&!b.get(f.CetModel.ID.POSSIBLY_PLACEHOLDER.SHOW_PLACEHOLDER_IN_PRESENT_MODE))}}createPathVisibilityFilter(a,
b){const c={};this.collectVisibilitiesOnPathPosition(b,a,(a,b)=>c[a]=b);return(a)=>{a=c[a];return null==a||a}}};var L={};Object.defineProperty(L,"__esModule",{value:!0});(function(a){a[a.Next=0]="Next";a[a.Previous=1]="Previous";a[a.Jump=2]="Jump";a[a.Resume=3]="Resume"})(L.PathNavigationAction||(L.PathNavigationAction={}));class ca{constructor(a,b,c,e,d,f,g,m){this.onEndHandlers=[];this.pathNavigationEndBus=l.Bacon.newBus();this.hoverStream=l.Bacon.newBus();this.logger=E.LoggerModule.getLoggerManager().createLogger("prezi_playback.PlaybackImpl");
this.stage=a;this.mainHitTest=c;this.sceneBuilder=e;this.baseScene=d;this.playbackScene=f;this.pathNavigator=g;this.dollyGrip=q.PlaybackModule.createDollyGrip(a);this.speedMeter=m;this.interactionHandler=new Q.InteractionHandler(a,d,g);this.navigationAndSceneEventHandler=new R.NavigationAndSceneEventHandler(this.interactionHandler);this.pathNavigator.getPathNavigationStream().onValue((a)=>{this.stage.getCamera().setCameraOnPath(!0);this.dollyGrip.onPathNavigationEvent(a)});a=this.dollyGrip.getDollyCameraNavigationStream().map((a)=>
({cancelled:!1,cameraNavigationEvent:a}));b=this.dollyGrip.getDollyCancelledNavigationStream().map((a)=>({cancelled:!0,cameraNavigationEvent:a}));a=a.merge(b);this.pathNavigationEndBus.plug(a.map((a)=>a.cancelled));this.pathNavigator.setAsyncCallback(a.map((a)=>a.cameraNavigationEvent.getPathNavigationEvent()));this.dollyGrip.getDollyCameraNavigationStream().merge(this.dollyGrip.getDollyCancelledNavigationStream()).onValue((a)=>{a=a.getPathNavigationEvent();let b=[];for(;0<this.onEndHandlers.length;){let c=
this.onEndHandlers.pop();c(a.getToPos())||b.push(c)}this.onEndHandlers=b});this.pathNavigator.getPathNavigationStream().onValue((a)=>{var b,c;null!=this.speedMeter&&this.speedMeter.setCurrentPathStepIndex(null!==(c=null===(b=a.getToPos())||void 0===b?void 0:b.getStep())&&void 0!==c?c:-1);if(null!=this.onStepHandler)this.onStepHandler({currentPathPosition:a.getToPos(),focusedObjectId:a.getToTargetId(),stepCount:a.getPath().getStepCount(),actionCount:null==a.getToPos()?0:a.getPath().getActionCount(a.getToPos().getStep())})})}seekTo(a){this.getPathNavigator().seekTo(a);
if(this.onStepHandler)this.onStepHandler({currentPathPosition:a,focusedObjectId:this.getPathNavigator().getCurrentTargetId(),stepCount:this.getPathNavigator().getPath().getStepCount(),actionCount:this.getPathNavigator().getPath().getActionCount(a.getStep())})}getPathNavigationEndStream(){return this.pathNavigationEndBus}getCurrentTopicActionStream(){return this.canvasInteraction.getCurrentTopicActionStream()}reset(a=!0){a&&this.playbackScene.reset(!0);this.pathNavigator.setScene(this.stage.getModelScene());
this.initPosition(!1)}initPosition(a){if(0===this.pathNavigator.getPath().getStepCount())this.stage.focusToOverview(!1),this.pathNavigationEndBus.push(!1);else if(a){a=g.CetModelEditor.createPlaybackPathQuery(this.stage.getModelScene());const b=this.stage.getModelScene().getPreziW().getOverview().getId();a=a.getClosestSuitablePathPosition(this.pathNavigator.getPath().getPathPosition(0,0),b);this.pathNavigator.initWithPosition(null!=a?a:this.pathNavigator.getPath().getPathPosition(0,0))}else this.pathNavigator.initWithPosition(this.pathNavigator.getPath().getStartPoint())}resume(){let a=
this.stage.getPathNavigator().getPath(),b=null;this.stage.getCamera().isCameraOnPath()&&(b=this.pathNavigator.getCurrentPosition());null!=b?(this.pathNavigator.go(b),this.stage.getCamera().setCameraOnPath(!0)):u.isActive("js-unique-differentiation")&&0!==a.getStepCount()&&(this.stage.focusToOverview(!1),this.stage.getCamera().setCameraOnPath(!0));0===a.getStepCount()&&(this.stage.focusToOverview(!1),this.stage.getCamera().setCameraOnPath(!0))}resumeFromInfo(){if(0===this.stage.getPathNavigator().getPath().getStepCount())this.stage.focusToOverview(!1);
else{let a=this.pathNavigator.getCurrentPosition().getStep();this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,0))}this.stage.getCamera().setCameraOnPath(!0)}initInteractionStreams(a,b,c,e,d,f,g,r,q,u){this.interactionHandler.setEditModeStream(f);this.canvasInteraction=new N.CanvasInteraction(this,this.mainHitTest,this.playbackScene,b,c,e,this.interactionHandler,d,g,r,f,q,u);this.hoverStream.plug(this.canvasInteraction.getHoverStream());this.stage.getCamera().setCameraOnPath(!0);
a=a.getShortcutStream(n.ShortcutAction.GO_TO_EDIT_MODE).map(()=>({newMode:m.EditorMode.edit,trigger:"esc"}));b=f.sampledBy(this.canvasInteraction.getUrlClickedStream()).map((a)=>a.kind===m.EditorMode.playback?{newMode:m.EditorMode.playback,linkClickedFlow:!0,presenterNotesFlow:a.presenterNotesFlow,showTopmenu:a.showTopmenu,shouldGoFullscreen:!1,shouldSeekPathToStart:!1,trigger:"link clicked"}:null).filter((a)=>null!=a);this.changeModeActionStream=l.Bacon.mergeAll([a,b]);this.handleKeyboardNavigationInEditMode(f,
q,c)}getHoverStream(){return this.hoverStream}handleKeyboardNavigationInEditMode(a,b,c){c=c.filter((a)=>a.type===n.KeyboardEventType.KEYDOWN&&!a.shiftKey&&!a.altKey&&!a.ctrlKey&&!a.metaKey&&-1<[n.Key.LEFT_ARROW,n.Key.RIGHT_ARROW,n.Key.UP_ARROW,n.Key.DOWN_ARROW,n.Key.PAGE_UP,n.Key.PAGE_DOWN].indexOf(a.keyCode));l.Bacon.combineWith3((a,b,c)=>({mode:a,selection:b.allEntityIds,keyCode:c.keyCode}),a,b,c).sampledBy(c).filter(({selection:a,mode:b})=>0===a.length&&b.kind===m.EditorMode.edit).onValue(({keyCode:a})=>
{-1<[n.Key.LEFT_ARROW,n.Key.UP_ARROW,n.Key.PAGE_UP].indexOf(a)?this.navigateBackward(()=>{},void 0,!0):-1<[n.Key.RIGHT_ARROW,n.Key.DOWN_ARROW,n.Key.PAGE_DOWN].indexOf(a)&&this.navigateForward(()=>{},void 0,!0)})}getChangeModeActionStream(){return this.changeModeActionStream}getCameraNavigationStream(){return this.dollyGrip.getDollyCameraNavigationStream()}getMouseCursorStateStream(){return this.canvasInteraction.getMouseCursorStateStream()}getRecalculateEntityUnderMouseActionStream(){return this.canvasInteraction.getRecalculateEntityUnderMouseActionStream()}navigateForward(a,
b,c){m.AppUtilsModule.getLogHelperUtils().flyToNextStep(this.logger);b=this.stage.getCamera().isCameraOnPath()?this.pathNavigator.next(c):this.pathNavigator.resume();this.waitForPathPosition_KILLME(a,b)}navigateBackward(a,b,c){m.AppUtilsModule.getLogHelperUtils().flyToPreviousStep(this.logger);b=this.stage.getCamera().isCameraOnPath()?this.pathNavigator.prev(c):this.pathNavigator.resume();this.waitForPathPosition_KILLME(a,b)}flyToStep(a,b){m.AppUtilsModule.getLogHelperUtils().flyToStep(this.logger,
a);this.waitForPathPosition_KILLME(b,this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,0)))}isEntityVisibleAtPathPosition(a,b){let c=!0;(new J.PlaybackVisibilityQuery).collectVisibilitiesOnPathPosition(this.playbackScene,b,(b,d)=>{a===b&&(c=d)});return c}isEntityVisibleAtCurrentPathPosition(a){return this.isEntityVisibleAtPathPosition(a,this.pathNavigator.getCurrentPosition())}getClosestPathPositionWhereVisible(a){var b=this.pathNavigator.getCurrentPosition();const c=this.pathNavigator.getPath().getAllPathPositions();
let e=0;for(var d=0;d<c.length;d++)if(c[d].isSame(b)){e=d;break}for(b=0;;b++){d=e+b;if(d<c.length){var f=c[d];if(this.isEntityVisibleAtPathPosition(a,f))return f}f=e-b;if(0<=f){const b=c[f];if(this.isEntityVisibleAtPathPosition(a,b))return b}if(d>=c.length&&0>f)return null}}flyToStepAction(a,b,c){this.waitForPathPosition_KILLME(c,this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,b)))}jumpToStepAction(a,b){this.pathNavigator.jump(this.pathNavigator.getPath().getPathPosition(a,b))}waitForPathPosition_KILLME(a,
b){if(null!=a&&null!=b){var c=(c)=>b.isSame(c)?(a(),!0):!1;!this.pathNavigator.isMoving()&&this.pathNavigator.getCurrentPosition().isSame(b)?a():this.onEndHandlers.push(c)}}addOnEndHandler(a){this.onEndHandlers.push(()=>a())}flyToOverview(){m.AppUtilsModule.getLogHelperUtils().flyToOverview(this.logger);return this.stage.flyToOverview()}flyToObject(a,b=d.CameraNavigationType.FLY,c=1){return this.interactionHandler.flyToObject(a,b,c)}flyModeToNavMode(a){switch(a){case q.FlyMode.START_NEW_FLY:return d.NavigationMode.NEW_TRANSITION;
case q.FlyMode.JUMP:return d.NavigationMode.JUMP}return null}hasNext(){return!this.pathNavigator.getPath().getPathCalculator().isLast(this.pathNavigator.getCurrentPosition())}hasPrevious(){return!this.pathNavigator.getPath().getPathCalculator().isFirst(this.pathNavigator.getCurrentPosition())}setOnStep(a){this.onStepHandler=a}getStepCount(){return this.pathNavigator.getPath().getStepCount()}getAnimationCountOnSteps(){return[]}getPathPositionsForNavigation(){return this.pathNavigator.getPath().getPathStepPositionsForNavigation()}getPathStepPositionsWithAudio(){return this.pathNavigator.getPath().getPathStepPositionsWithAudio()}getActionCount(a){return this.pathNavigator.getPath().getActionCount(a)}getCurrentStepIndex(){return null==
this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getStep()}getCurrentActionIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getAction()}getCurrentPathPosition(){var a;return null!==(a=this.pathNavigator.getCurrentPosition())&&void 0!==a?a:this.pathNavigator.getPath().getPathPosition(0,0)}getStartPosition(){return this.pathNavigator.getPath().getStartPoint()}getIsPanningStream(){return this.canvasInteraction.getIsPanningStream()}getStage(){return this.stage}createDollyGrip(a){return new C.DollyGripImpl(a)}getScene(){return this.playbackScene}getBaseScene(){return this.baseScene}getSceneBuilder(){return this.sceneBuilder}getPathNavigator(){return this.pathNavigator}peerAtScreenCoordinates_bdd(a){a=
this.playbackScene.getPrezi().get(x.PlaybackModuleImpl.getStageQueryKey()).getEntityIdUnderPoint(this.stage.getCamera().screenPointToWorld(a));return null==a?null:this.playbackScene.getEntityById(a)}setSceneStream(a){this.canvasInteraction.setSceneStream(a);this.navigationAndSceneEventHandler.setSceneStream(a)}setEntityChangeStream(a){this.navigationAndSceneEventHandler.setEntityChangeStream(a)}setCameraNavigationStream(a){this.navigationAndSceneEventHandler.setCameraNavigationStream(a)}setupSceneChangeHandler(a){this.navigationAndSceneEventHandler.setupSceneChangeHandler(a)}isVideoInFocus(){var a=
this.stage.getEntityIdInFocus();a=this.stage.getModelScene().getEntityById(a);return null!=a&&a.isDef(f.CetModel.ID.Z_VIDEO)}}L.PlaybackImpl=ca;var w={};Object.defineProperty(w,"__esModule",{value:!0});w.logoEntityId="logo-system-entity";w.LogoSystem=class{constructor(a,b,c,e,d){this.renderingAssetManager=e;this.oldLogoAlpha=.8;this.windowSizeChanged=!1;a.onValue((a)=>{null!=a&&this.logoType!==a&&(this.logoType=a,this.isDirty=!0,d.markViewChanged())});b.onValue((a)=>{this.hoveredEntityIds=a;d.markViewChanged()});
c.onValue((a)=>{this.windowSize=a;this.windowSizeChanged=!0;d.markViewChanged()})}manageLogoHoverState(a){const b=this.isLogoOrLogoDecorator(a,this.hoveredEntityIds)?1:.8;a=a.getEntityById(w.logoEntityId);const c=this.currentLinkUrl;null!=a&&b!==this.oldLogoAlpha&&c&&(this.visHelper.setVisibility(a,!0,b),this.oldLogoAlpha=b)}isLogoOrLogoDecorator(a,b){if(null==b||1!==b.length)return!1;b=b[0];a=a.getEntityById(b);if(null==a)return!1;if(b===w.logoEntityId)return!0;a=a.get(F.SelectionModule.getDecoratorKey());
return null!=a&&1===a.ownerIds.length&&a.ownerIds[0]===w.logoEntityId}changesPdomComponents(){return!1}getName(){return"LogoSystem"}init(a){this.visHelper=a.getTweener().createVisibilityAnimationHelper("logo");this.nextLogoTracker=a.getEntityList().startNewTracking("LogoSystem-logo-media-asset",[f.CetModel.ID.MEDIA_ASSET.ONLINE_ASSET_URL,f.CetModel.ID.NEXT_LOGO_V1.LINK_URL,f.CetModel.ID.NEXT_LOGO_V1.BACKGROUND_COLOR,f.CetModel.ID.NEXT_LOGO_V1.BACKGROUND_ALPHA],(a)=>a.getId()!==w.logoEntityId)}reset(){}update(a){if(this.isDirty)switch(this.logoType){case B.PreziLogoType.None:a.getEntityList().deleteEntity(w.logoEntityId);
break;case B.PreziLogoType.Watermark:this.updateWatermark(a);break;case B.PreziLogoType.DocumentBased:this.updateDocumentBasedLogo(a,!0);break;default:y.Utils.assertNever(this.logoType)}this.manageLogoHoverState(a);this.logoType===B.PreziLogoType.DocumentBased&&a.getEntityList().forChangedMutableEntities(()=>{this.updateDocumentBasedLogo(a)},this.nextLogoTracker);this.manageLogoSizeCategory(a);this.windowSizeChanged=this.isDirty=!1}updateDocumentBasedLogo(a,b=!1){if(null==this.getLogoMediaAssetUrl(a))a.getEntityList().deleteEntity(w.logoEntityId);
else{let c=a.getEntityById(w.logoEntityId);const e=a.getPreziW().getNextLogo(),d=null!=e&&e.is(f.CetModel.ID.NEXT_LOGO_V1),g=null!=c&&(d&&!c.isDef(f.CetModel.ID.NEXT_LOGO_V1)||!d&&c.isDef(f.CetModel.ID.NEXT_LOGO_V1));g&&(a.getEntityList().deleteEntity(w.logoEntityId),c=null);null==c&&(c=d?this.createNextLogoEntity(a):this.createClassicLogoEntity(a));d?this.updateNextLogoProperties(a,e,c,b||g):this.updateClassicLogoProperties(a,c)}}updateWatermark(a){const b=this.getLogoMediaAssetUrl(a);this.currentLinkUrl=
"https://www.prezi.com";this.currentBackgroundColor=D.Geometry.colorFromRGB(1,1,1);this.currentBackgroundAlpha=1;let c=a.getEntityById(w.logoEntityId);var e=a.getPreziW().getNextLogo();e=null!=e&&e.is(f.CetModel.ID.NEXT_LOGO_V1);null==c||e||(a.getEntityList().deleteEntity(w.logoEntityId),c=null);null==c&&(c=this.createNextLogoEntity(a));this.updateLogoMediaAsset(a,c,b)}createNextLogoEntity(a){a=a.getEntityList().createEntity(w.logoEntityId);a.set(d.Cet.getDefComponentKey(),f.CetModel.ID.NEXT_LOGO_V1);
a.setComponent(r.CetRendererModule.getDrawComponentKey(),r.CetRendererModule.createNextLogoDrawComponent());a.setComponent(r.CetRendererModule.getZOrderComponentKey(),r.CetRendererModule.createZOrderComponent(0,r.LayerType.LogoLayer));this.visHelper.setVisibility(a,!0,.8);return a}createClassicLogoEntity(a){a=a.getEntityList().createEntity(w.logoEntityId);a.set(d.Cet.getDefComponentKey(),f.CetModel.ID.LOGO);a.setComponent(r.CetRendererModule.getDrawComponentKey(),r.CetRendererModule.createLogoDrawComponent());
a.setComponent(r.CetRendererModule.getZOrderComponentKey(),r.CetRendererModule.createZOrderComponent(0,r.LayerType.LogoLayer));this.visHelper.setVisibility(a,!0,1);return a}updateClassicLogoProperties(a,b){const c=this.getLogoMediaAssetUrl(a);this.updateLogoMediaAsset(a,b,c)}updateNextLogoProperties(a,b,c,e=!1){var d,g;if(null===b||void 0===b?0:b.is(f.CetModel.ID.NEXT_LOGO_V1)){const h=null===c||void 0===c?void 0:c.getMutableWrapper(f.CetModel.ID.NEXT_LOGO_V1.W),k=e||b.getOnlineAssetUrl()!==this.currentOnlineAssetUrl,
l=e||b.getLinkUrl()!==this.currentLinkUrl;e=e||(null===(d=b.getBackgroundColor())||void 0===d?void 0:d.getRGBInt())!==(null===(g=this.currentBackgroundColor)||void 0===g?void 0:g.getRGBInt())||b.getBackgroundAlpha()!==this.currentBackgroundAlpha;k&&(this.currentOnlineAssetUrl=this.getLogoMediaAssetUrl(a));l&&(this.currentLinkUrl=b.getLinkUrl());e&&(this.currentBackgroundColor=b.getBackgroundColor(),this.currentBackgroundAlpha=b.getBackgroundAlpha());k?this.updateLogoMediaAsset(a,c,this.currentOnlineAssetUrl):
(l&&h.setLinkUrl(this.currentLinkUrl),e&&(h.setBackgroundColor(this.currentBackgroundColor),h.setBackgroundAlpha(this.currentBackgroundAlpha)))}}updateLogoMediaAsset(a,b,c){this.renderingAssetManager.imageAssetFromUrl(c,b.getId()).then((b)=>{a.requestNoDomBatchUpdate((a)=>{a=a.getEntityById(w.logoEntityId);if(null!=a&&!a.isDisposed()){var c=a.getMutableWrapper(f.CetModel.ID.NEXT_LOGO_V1.W);if(null===c||void 0===c?0:c.is(f.CetModel.ID.NEXT_LOGO_V1))c.setLinkUrl(this.currentLinkUrl),c.setBackgroundColor(this.currentBackgroundColor),
c.setBackgroundAlpha(this.currentBackgroundAlpha);a=d.Cet.mutableDraw(a);a.kind!==r.DrawComponentKind.logo&&a.kind!==r.DrawComponentKind.nextLogo||a.setAsset(b)}})})}getLogoMediaAssetUrl(a){switch(this.logoType){case B.PreziLogoType.DocumentBased:const b=a.getPreziW().getNextLogo();a=(null===b||void 0===b?0:b.is(f.CetModel.ID.NEXT_LOGO_V1))?b:a.getPreziW().getLogo();return null===a||void 0===a?void 0:a.getOnlineAssetUrl();case B.PreziLogoType.Watermark:return q.getWatermarkAssetUrl();case B.PreziLogoType.None:return null;
default:y.Utils.assertNever(this.logoType)}}manageLogoSizeCategory(a){if(this.windowSizeChanged||this.isDirty)if(a=a.getEntityById(w.logoEntityId),null!=a&&(a=d.Cet.mutableDraw(a),null!=a&&a.kind===r.DrawComponentKind.nextLogo)){const b=null==this.windowSize||1280>=this.windowSize.width&&720>=this.windowSize.height;switch(this.logoType){case B.PreziLogoType.DocumentBased:a.updateSizeCategory(b?r.LogoSizeCategory.documentBasedSmall:r.LogoSizeCategory.documentBasedLarge);break;case B.PreziLogoType.Watermark:a.updateSizeCategory(b?
r.LogoSizeCategory.preziLogoSmall:r.LogoSizeCategory.preziLogoLarge);break;case B.PreziLogoType.None:break;default:y.Utils.assertNever(this.logoType)}}}};var S={};Object.defineProperty(S,"__esModule",{value:!0});S.PathVisibilitySystemImpl=class{constructor(){this.prevVisibleEntities=[];this.pathVisibilityKey=d.Cet.getPathVisibilityKey()}track(a){null==this.pathVisibilityTracker&&(this.pathVisibilityTracker=a.getEntityList().startNewTracking("PathVisibilityTracker",[this.pathVisibilityKey],()=>!0));
a.getEntityList().forChangedMutableEntities((a)=>{for(let b of a)this.prevVisibleEntities.push(b.getId())},this.pathVisibilityTracker)}clearTracker(a){a.getEntityList().forChangedMutableEntities(()=>{},this.pathVisibilityTracker)}process(a,b){this.track(b);const c=[];b.getPreziW().getZObjects().forEach((a)=>c.push(a.getId()));b.getPreziW().getBackground().getLayers().forEach((a)=>c.push(a.getId()));this.prevVisibleEntities.forEach((a)=>{a=b.getEntityById(a);null!=a&&a.discardOwnComponent(this.pathVisibilityKey)});
a=new J.PlaybackVisibilityQuery;const e=b.getPrezi().get(d.Cet.getCurrentPathPositionKey()),h=a.createPathVisibilityFilter(e,b),g=c.filter((a)=>h(a));b.getEntityList().forEach((a)=>{(a.isDef(f.CetModel.ID.LOGO)||a.isDef(f.CetModel.ID.NEXT_LOGO_V1))&&g.push(a.getId())});g.push(b.getPreziW().getBackground().getId());g.forEach((a)=>b.getEntityById(a).set(this.pathVisibilityKey,{isEnabled:!0,alpha:1}));this.clearTracker(b);this.prevVisibleEntities=g}getName(){return"PathVisibilitySystem"}reset(){}select(){return!0}getTriggerKeys(){return[f.CetModel.getNewEntityCompKey(),
f.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER,d.Cet.getCurrentPathPositionKey(),f.CetModel.ID.PREZI.PATH,f.CetModel.ID.PREZI.EDITOR_PATH,...f.CetModel.ID.EDITOR_PATH.getFields(),f.CetModel.ID.PATH_STEP.ACTIONS,f.CetModel.ID.EDITOR_PATH_STEP.ACTIONS,f.CetModel.ID.HAS_TARGET.TARGET]}changesPdomComponents(){return!1}};var T={};Object.defineProperty(T,"__esModule",{value:!0});T.PlaybackVisibilitySystemImpl=class{constructor(){this.playbackVisibilityKey=x.PlaybackModuleImpl.getPlaybackVisibilityKey()}process(a,
b){b=(new J.PlaybackVisibilityQuery).createGeneralVisibilityFilter(b);for(let c of a)b(c.getId())?c.set(this.playbackVisibilityKey,{isEnabled:!0,alpha:1}):c.set(this.playbackVisibilityKey,{isEnabled:!1,alpha:0}),c.isDef(f.CetModel.ID.Z_ZOOM_AREA)&&c.set(this.playbackVisibilityKey,{isEnabled:!0,alpha:0})}getName(){return"PlaybackVisibilitySystem"}getVisibilityKey(){return this.playbackVisibilityKey}reset(){}select(a){return a.hasComponent(r.CetRendererModule.getDrawComponentKey())}getTriggerKeys(){return[f.CetModel.getNewEntityCompKey(),
f.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER]}changesPdomComponents(){return!1}};var A={};Object.defineProperty(A,"__esModule",{value:!0});A.StageQueryImpl=class{constructor(a,b,c,e,d){this.scene=a;this.stage=b;this.applicationMode=d;c.onValue((a)=>this.coverEditMode=a);e.onValue((a)=>this.currentTopicId=a)}strategies(){return g.CetModelEditor.createStageQueryStrategyFactory(this.scene,this.applicationMode)}getEntityIdUnderPoint(a,b=!0,c=null){a=this.getEntitiesByWorldPoint(a);c?a=a.apply(F.SelectionModule.restrictToEntityAndCtrlPointsSQStrategy(c,
this.scene)):(a=a.apply(this.strategies().general()),b&&(a=a.apply(this.strategies().replaceCoverWithTopic(this.scene))));a=a.apply(this.strategies().excludeEntitiesOnLogoLayer());return a.firstEntityId()}getSurroundingTopic(){var a=this.stage.getStageCamera().viewportInWorld();let b=D.Geometry.obbFromRect(a.getData());var c=this.scene.getEntityList().asArray().filter((a)=>{const c=g.CetModelEditor.createTopicQuery(this.scene).getTopicKind(a.getId());return(c===g.TopicKind.Page||c===g.TopicKind.Stack||
c===g.TopicKind.Planet)&&d.Cet.world(a).getWorldBounds().containsRect(b)});a=-1;let e=null;for(let b of c)if(c=d.Cet.world(b).getWorldBounds(),c=c.getWidth()*c.getHeight(),null==e||c<a)a=c,e=b;return null==e?this.scene.getPreziW().getOverview().getEntity():e}queryableInTitleEditOnlyMode(a){return f.CetModel.textKludge.isEntityText(a)}isChildOfCurrentTopic(a){if(!d.Cet.hasPdomComponent(a))return!1;const b=d.Cet.createHierarchyQuery(this.scene);return this.scene.getEntityById(b.getParentOrOverview(a)).getId()===
this.currentTopicId}borderAreaHit(a,b){var c=1/this.stage.getStageCamera().getTransform().getScale();c=Math.ceil(c*A.StageQueryImpl.CLICKABLE_BORDER_WIDTH);return!d.Cet.world(a).getWorldBoundingShape().inflate(-c).containsPoint(b)&&d.Cet.world(a).getWorldBoundingShape().containsPoint(b)}getEntitiesByWorldArea(a){let b=this.getViewEntitiesInRectangle(a.getBounds());return this.getStageQueryResult(b,[this.createGeneralTagger(),this.createWorldAreaTagger(a)])}filterNonEnabled(a){return a.filter((a)=>
(null==a.get(d.Cet.getEntityHittestDisabledKey())||!a.get(d.Cet.getEntityHittestDisabledKey()))&&(null==a.get(d.Cet.getTemporaryEntityHittestDisabledKey())||0>=a.get(d.Cet.getTemporaryEntityHittestDisabledKey())))}getLogoUnderPoint(a){a=this.stage.getStageCamera().getTransform().transformPoint(a);const b=this.scene.getEntityById(w.logoEntityId);if(null==b)return[];const c=d.Cet.createScreenBoundsCalculator(this.scene,this.stage.getStageCamera()).getLogoBoundsInScreen(this.scene,b.getId());return null!=
c&&c.containsPoint(a)?[b]:[]}getViewEntitiesUnderPoint(a){return[...this.getLogoUnderPoint(a),...this.filterNonEnabled(this.stage.getHitTest().getViewEntitiesUnderPoint(this.scene.getPreziW(),a))]}getViewEntitiesInRectangle(a){return this.filterNonEnabled(this.stage.getHitTest().getViewEntitiesInRectangle(this.scene.getPreziW(),a))}getEntitiesByWorldPoint(a){let b=this.getViewEntitiesUnderPoint(a);return this.getStageQueryResult(b,[this.createGeneralTagger(),this.createWorldPointTagger(a)])}tag(a){a=
a.map((a)=>this.scene.getEntityById(a));return this.getStageQueryResult(a,[this.createGeneralTagger()])}isVisibleOutsideOnASubtopic(a){const b=d.Cet.createTopicChildrenQuery(this.scene);return b.isVisibleOutside(a.getId())?(a=b.getChildReferer(a.getId()),null!=a&&this.isChildOfCurrentTopic(this.scene.getEntityById(a))):!1}isEntityLocked(a){return g.CetModelEditor.isLocked(a.getId(),this.scene)}isEntityReachable(a){if(a.isDef(f.CetModel.ID.LOGO)||a.isDef(f.CetModel.ID.NEXT_LOGO_V1))return!0;const b=
d.Cet.createTopicChildrenQuery(this.scene);var c=b.getBehavior(a.getId());if(null==this.coverEditMode){var e=d.Cet.createHierarchyQuery(this.scene),h=this.scene.getEntityById(e.getParentOrOverview(a));e=this.scene.getEntityById(e.getParentOrOverview(h)).getId()===this.currentTopicId;return this.isChildOfCurrentTopic(a)&&c===d.TopicChildBehavior.Content||e&&(c===d.TopicChildBehavior.Cover||c===d.TopicChildBehavior.Surface||c===d.TopicChildBehavior.Visual)}switch(this.coverEditMode.kind){case p.CoverEditModeKind.titleEditOnly:case p.CoverEditModeKind.advanced:return a.getId()!==
this.coverEditMode.topicId&&(this.isChildOfCurrentTopic(a)&&c===d.TopicChildBehavior.Content||this.isVisibleOutsideOnASubtopic(a));case p.CoverEditModeKind.insideAdvanced:const f=g.CetModelEditor.createTopicQuery(this.scene).getTopicKind(this.currentTopicId)===g.TopicKind.Page;c=(a)=>{const c=f?b.getChildReferer(this.currentTopicId):null;return null!=c?b.getBehaviorReferer(a.getId(),d.TopicChildBehavior.Visual)===c:!1};e=d.Cet.createHierarchyQuery(this.scene);h=this.scene.getEntityById(e.getParentOrOverview(a));
e=this.scene.getEntityById(e.getParentOrOverview(h)).getId()===this.currentTopicId;return this.isChildOfCurrentTopic(a)&&b.isVisibleInside(a.getId())||c(a)||e&&b.isVisibleOutside(a.getId());default:return y.Utils.assertNever(this.coverEditMode)}}calculateZoomAreaTag(a){var b=this.stage.getStageCamera(),c=D.Geometry.obbFromRect(b.getMarginCorrectedViewport().getData()).transform(b.getTransform().invert());b=c.getWidth();c=c.getHeight();const e=d.Cet.world(a).getWorldBounds().getWidth();a=d.Cet.world(a).getWorldBounds().getHeight();
return c-.001<a||b-.001<e?g.HitTag.ENCLOSING_ZOOM_AREA:g.HitTag.SMALLER_ZOOM_AREA}getCoverEditModeTargetId(){switch(this.coverEditMode.kind){case p.CoverEditModeKind.advanced:case p.CoverEditModeKind.titleEditOnly:return this.coverEditMode.topicId;case p.CoverEditModeKind.insideAdvanced:return this.coverEditMode.topicOrOverviewId;default:y.Utils.assertNever(this.coverEditMode)}}createGeneralTagger(){return(a)=>{let b=[];d.Cet.hasPdomComponent(a)&&b.push(g.HitTag.HAS_PDOM_COMPONENT);this.isEntityReachable(a)&&
b.push(g.HitTag.REACHABLE_IN_DOCUMENT);this.isEntityLocked(a)&&b.push(g.HitTag.LOCKED);g.CetModelEditor.isPage(a.getId(),this.scene)&&b.push(g.HitTag.PAGE);var c=a.get(F.SelectionModule.getDecoratorKey());null!=c&&c.interactionType!==F.InteractionType.none&&b.push(g.HitTag.INTERACTIVE_DECORATOR);(c=a.isDef(f.CetModel.ID.LOGO)||a.isDef(f.CetModel.ID.NEXT_LOGO_V1))&&b.push(g.HitTag.LOGO);(c||d.Cet.visibility(a).isVisible())&&b.push(g.HitTag.VISIBLE);(c||d.Cet.visibility(a).isEnabled())&&b.push(g.HitTag.ENABLED);
c=d.Cet.createTopicChildrenQuery(this.scene);const e=g.CetModelEditor.createTopicQuery(this.scene),h=d.Cet.createHierarchyQuery(this.scene),k=(a,b)=>{if(null==a)return!1;switch(a.kind){case p.CoverEditModeKind.advanced:case p.CoverEditModeKind.insideAdvanced:return!0;case p.CoverEditModeKind.titleEditOnly:return this.queryableInTitleEditOnlyMode(b);default:return y.Utils.assertNever(a)}};c.hasBehavior(a.getId(),d.TopicChildBehavior.Cover)&&(b.push(g.HitTag.COVER),!k(this.coverEditMode,a)||this.coverEditMode.kind!==
p.CoverEditModeKind.advanced&&this.coverEditMode.kind!==p.CoverEditModeKind.titleEditOnly||c.getBehaviorReferer(a.getId(),d.TopicChildBehavior.Cover)!==this.coverEditMode.topicId||b.push(g.HitTag.COVER_OF_COVER_EDITED_TOPIC));if(c.hasBehavior(a.getId(),d.TopicChildBehavior.Visual)||c.hasBehavior(a.getId(),d.TopicChildBehavior.Surface)){b.push(g.HitTag.VISUALLIKE);const d=c.getChildReferer(a.getId());k(this.coverEditMode,a)&&d===this.getCoverEditModeTargetId(this.coverEditMode)&&b.push(g.HitTag.VISUALLIKE_OF_COVER_EDITED_TOPIC);
(d===this.currentTopicId||e.getTopicKind(this.currentTopicId)===g.TopicKind.Page&&d===h.getParentId(this.scene.getEntityById(this.currentTopicId)))&&b.push(g.HitTag.VISUALLIKE_OF_CURRENT_TOPIC)}d.Cet.createHierarchyQuery(this.scene).isZTopicContainer(a.getId())&&(b.push(g.HitTag.Z_TOPIC_CONTAINER),0===c.getChildrenIdsVisibleOutside(a.getId()).length&&b.push(g.HitTag.Z_TOPIC_CONTAINER_WITHOUT_COVER_AND_VISUAL));(a.isDef(f.CetModel.ID.Z_ARROW)||a.isDef(f.CetModel.ID.Z_LINE))&&b.push(g.HitTag.LINE_ARROW);
a.isDef(f.CetModel.ID.Z_SHAPE)&&a.getWrapper(f.CetModel.ID.Z_SHAPE.W).getShapeType()===f.ShapeType.Triangle&&b.push(g.HitTag.TRIANGLE);a.isDef(f.CetModel.ID.Z_ZOOM_AREA)&&(b.push(g.HitTag.ZOOM_AREA),b.push(this.calculateZoomAreaTag(a)));this.isObjectTooLarge(a)?b.push(g.HitTag.TOO_LARGE):this.isObjectTooSmall(a)&&b.push(g.HitTag.TOO_SMALL);return b}}createWorldPointTagger(a){return(b)=>{let c=[];var e=this.stage.getHitTest();if(b.isDef(f.CetModel.ID.LOGO)||b.isDef(f.CetModel.ID.NEXT_LOGO_V1))return[g.HitTag.CLICKED_ENCLOSELY,
g.HitTag.CLICKED_IN_WORLD_BOUNDS];let h=d.Cet.transform(b).getWorldToLocal().transformPoint(a);e.enclosePoint(this.stage.getStageCamera(),b,h)&&(c.push(g.HitTag.CLICKED_ENCLOSELY),e.hitTest(this.stage.getStageCamera(),b,h)&&c.push(g.HitTag.CLICKED_PRECISELY));d.Cet.world(b).getWorldBoundingShape().containsPoint(a)&&c.push(g.HitTag.CLICKED_IN_WORLD_BOUNDS);this.borderAreaHit(b,a)&&c.push(g.HitTag.CLICKED_IN_BORDER_AREA);e=d.Cet.createTopicChildrenQuery(this.scene);null!=this.coverEditMode&&this.coverEditMode.kind!==
p.CoverEditModeKind.insideAdvanced&&d.Cet.hasPdomComponent(b)&&null!=a&&!e.isVisibleOutside(b.getId())&&e.getChildReferer(b.getId())!==this.coverEditMode.topicId&&(b=this.scene.getEntityById(this.coverEditMode.topicId),e=d.Cet.createBoundsCalculator(this.scene).getWorldBoundsForInteraction(this.coverEditMode.topicId,d.TextBoundsOptions.TextBox),null!=b&&e.containsPoint(a)&&c.push(g.HitTag.EXTERNAL_OBJECT_INTERSECTING_COVER_EDIT_BOUNDS));return c}}createWorldAreaTagger(a){return(b)=>{let c=[];b=d.Cet.world(b).getWorldBounds();
b.containsRect(a)&&c.push(g.HitTag.CONTAINS_WORLD_AREA);b.intersects(a)&&c.push(g.HitTag.INTERSECT_WORLD_AREA);return c}}getStageQueryResult(a,b){this.sortEntitiesByAncestryAndZIndex(a);a=a.map((a)=>{let c=[];for(let e=0;e<b.length;++e)c=c.concat(b[e](a));return g.CetModelEditor.createEntityHit({entity:a,hitTags:c,zIndex:d.Cet.zOrder(a).getZIndex(),layerIndex:r.CetRendererModule.calcLayerInt(d.Cet.zOrder(a).getZLayer())})});return g.CetModelEditor.createStageQueryResult(a)}sortEntitiesByAncestryAndZIndex(a){a.sort((a,
c)=>{const b=d.Cet.createHierarchyQuery(this.scene);return-1!==b.getAncestorEntities(a.getId()).indexOf(c.getId())?-1:-1!==b.getAncestorEntities(c.getId()).indexOf(a.getId())?1:r.CetRendererModule.getEntityOrder(a,c)})}isObjectTooLarge(a){if(!this.objectLockingEnabled(a,!0))return!1;var b=this.stage.getStageCamera().getViewport();const c=this.stage.getScreenBounds(a),e=Math.min(c.getWidth()/b.getWidth(),c.getHeight()/b.getHeight());b=Math.max(c.getWidth()/b.getWidth(),c.getHeight()/b.getHeight());
a=f.CetModel.textKludge.isEntityText(a)?A.StageQueryImpl.LOCK_TOO_BIG_SHORTED_TEXT_DIMENSION_RATIO:A.StageQueryImpl.LOCK_TOO_BIG_SHORTED_DIMENSION_RATIO;return e>a||b>A.StageQueryImpl.LOCK_TOO_BIG_LONGER_DIMENSION_RATIO}isObjectTooSmall(a){if(!this.objectLockingEnabled(a,!1))return!1;const b=this.stage.getStageCamera().getViewport();a=this.stage.getScreenBounds(a);return Math.max(a.getWidth()/b.getWidth(),a.getHeight()/b.getHeight())<A.StageQueryImpl.LOCK_TOO_SMALL_RATIO}objectLockingEnabled(a,b){const c=
d.Cet.hasPdomComponent(a);a=d.Cet.createHierarchyQuery(this.scene).getParentId(a);a=g.CetModelEditor.isPage(a,this.scene);return c&&(b||!a)}};A.StageQueryImpl.CLICKABLE_BORDER_WIDTH=20;A.StageQueryImpl.LOCK_TOO_SMALL_RATIO=.02;A.StageQueryImpl.LOCK_TOO_BIG_SHORTED_DIMENSION_RATIO=.6;A.StageQueryImpl.LOCK_TOO_BIG_SHORTED_TEXT_DIMENSION_RATIO=1;A.StageQueryImpl.LOCK_TOO_BIG_LONGER_DIMENSION_RATIO=1.8;var U={};Object.defineProperty(U,"__esModule",{value:!0});U.StageQuerySystem=class{constructor(a,b,
c,e,d){this.zoomingStage=a;this.coverEditModeProperty=b;this.currentTopicIdStream=c;this.applicationMode=e;this.stageQueryKey=d}process(a,b){null!=b.getPrezi()&&(a=new A.StageQueryImpl(b,this.zoomingStage,this.coverEditModeProperty,this.currentTopicIdStream,this.applicationMode),b.getPrezi().set(this.stageQueryKey,a))}select(a){return a.isDef(f.CetModel.ID.PREZI)}getTriggerKeys(){return[f.CetModel.getNewEntityCompKey()]}getName(){return"StageQuerySystem"}changesPdomComponents(){return!1}};var O={};
Object.defineProperty(O,"__esModule",{value:!0});O.TopicAnimator=class{constructor(a,b,c,e,d,f,l,m){this.makeVisible=a;this.makeInvisible=b;this.visHelper=c;this.forceInstantPaging=f;this.newEntities=l;this.scene=m;this.topicQuery=g.CetModelEditor.createTopicQuery(m);this.prevTopicKind=null!=e?this.topicQuery.getTopicKind(e):null;this.currTopicKind=this.topicQuery.getTopicKind(d);const h=new Set(b),k=new Set([]);a.forEach((a)=>{h.has(a)&&k.add(a)});this.makeVisible=a.filter((a)=>!k.has(a));this.makeInvisible=
b.filter((a)=>!k.has(a))}animate(a){this.forceImmediate=a||this.scene.getTweener().getTweenMode()===d.TweenMode.IMMEDIATE;this.makeInvisible.forEach((a)=>{const b=this.scene.getEntityById(a);a=this.computeFadeOutData(a);this.visHelper.fadeOut(b,a)});this.makeVisible.forEach((a)=>{const b=this.scene.getEntityById(a);a=this.computeFadeInData(a);this.visHelper.fadeIn(b,a)})}computeFadeInData(a){return this.forceImmediate||-1!==this.newEntities.indexOf(a)?d.Cet.getAnimationData(d.AnimationType.INSTANT):
this.prevTopicKind===g.TopicKind.Page&&this.currTopicKind===g.TopicKind.Page?this.forceInstantPaging?d.Cet.getAnimationData(d.AnimationType.INSTANT):d.Cet.getAnimationData(d.AnimationType.PAGE_FADE_IN):d.Cet.getAnimationData(d.AnimationType.OVERVIEW_FADE_IN)}computeFadeOutData(a){return this.forceImmediate||-1!==this.newEntities.indexOf(a)?d.Cet.getAnimationData(d.AnimationType.INSTANT):this.prevTopicKind===g.TopicKind.Page&&this.currTopicKind===g.TopicKind.Page?this.forceInstantPaging?d.Cet.getAnimationData(d.AnimationType.INSTANT):
d.Cet.getAnimationData(d.AnimationType.PAGE_FADE_OUT):d.Cet.getAnimationData(d.AnimationType.OVERVIEW_FADE_OUT)}};var P={};Object.defineProperty(P,"__esModule",{value:!0});P.TopicVisibilitySystem=class{constructor(a,b,c,e,d,f){this.forceInstantPaging=a;this.refreshable=d;this.topicOverlayAnimator=f;this.firstUpdateAfterStartEditMode=this.firstUpdateAfterReset=!1;this.prevLetterBoxing=null;this.dirty=!1;this.currentTopicNavigation={newCurrentTopic:null,navigationType:null};c.onValue(()=>{this.refreshable.markViewChanged()});
e.onValue((a)=>{a===m.EditorMode.edit&&(this.firstUpdateAfterStartEditMode=!0)});b.onValue((a)=>{null!=a&&null!=a.newCurrentTopic&&null!=this.currentTopicNavigation&&this.currentTopicNavigation.newCurrentTopic!==a.newCurrentTopic&&(this.dirty||(this.prevTopic=this.currentTopicNavigation.newCurrentTopic),this.currentTopicNavigation=a,this.dirty=!0)})}init(a){null==this.visHelper&&(this.visHelper=a.getTweener().createVisibilityAnimationHelper("TopicVisibilitySystem"),this.newZObjects=a.getEntityList().startNewTracking("PD-newObjects",
[f.CetModel.getNewEntityCompKey()],(a)=>null!=d.Cet.zOrder(a)&&!this.visHelper.hasVisibilityKey(a)),this.outlineContent=a.getEntityList().startNewTracking("TopicVisibility-outline-content",[g.CetModelEditor.getShowContentKey()],()=>!0),this.behaviorChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-topic-child-change",[f.CetModel.ID.TOPIC_CHILD.BEHAVIOUR],()=>!0),this.childrenChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-children-change",[f.CetModel.ID.HAS_CHILDREN.CHILDREN_PARENT,
f.CetModel.ID.TOPIC_CHILD.CHILD_PARENT],()=>!0),this.smartStructureChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-topic-smartStructureChangeTracker-change",[f.CetModel.ID.SMART_STRUCTURE.CHILDREN_PARENT],()=>!0),null!=this.topicOverlayAnimator&&this.topicOverlayAnimator.init(a))}createAnimatorForNewTopics(a,b,c){const e=g.CetModelEditor.createTopicQuery(a).getReachableEntities(b,d.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>null!=a.getEntityById(b)).filter((a)=>0<=c.indexOf(a));
return new O.TopicAnimator(e,[],this.visHelper,null,b,this.forceInstantPaging,c,a)}isExistingEntity(a,b){return null!=b&&null!=a.getEntityById(b)}createAnimatorForTopicNavigation(a,b,c){var e=g.CetModelEditor.createTopicQuery(a);const f=this.isExistingEntity(a,b)?e.getReachableEntities(b,d.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>this.isExistingEntity(a,b)):[];e=this.isExistingEntity(a,c)?e.getReachableEntities(c,d.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>null!=a.getEntityById(b)).filter((a)=>
a!==b):[];return 0<f.length||0<e.length?new O.TopicAnimator(f,e,this.visHelper,c,b,this.forceInstantPaging,[],a):null}handleBehaviorChange(a,b){const c=g.CetModelEditor.createTopicQuery(b).getReachableEntities(this.currentTopicNavigation.newCurrentTopic,d.VisualBackgroundReachLevel.ALL_VISUALS),e=(a)=>{const e=b.getEntityById(a);0<=c.indexOf(a)?this.visHelper.isVisible(e)||this.visHelper.show(e):this.visHelper.isVisible(e)&&this.visHelper.hide(e)};a.forEach((a)=>e(a))}manageOutlineContent(a){const b=
a.get(g.CetModelEditor.getShowContentKey()),{visibility:c,alpha:e}=null!=b&&b?{visibility:!0,alpha:.5}:{visibility:!1,alpha:0};this.visHelper.setVisibility(a,c,e)}update(a){if(null==this.currentTopicNavigation||null==a.getEntityById(this.currentTopicNavigation.newCurrentTopic))this.firstUpdateAfterReset=this.dirty=!1;else{a.getEntityList().forChangedMutableEntities((b)=>{b=b.filter((a)=>d.Cet.hasPdomComponent(a));b.forEach((a)=>this.visHelper.hide(a));b=this.createAnimatorForNewTopics(a,this.currentTopicNavigation.newCurrentTopic,
b.map((a)=>a.getId()));null!=b&&b.animate(this.currentTopicNavigation.navigationType===d.NavigationActionAnimationType.Focus)},this.newZObjects);a.getEntityList().forChangedMutableEntities((b)=>{b=b.filter((a)=>d.Cet.hasPdomComponent(a)).map((a)=>a.getMutableWrapper(f.CetModel.ID.TOPIC_CHILD.W).getChild());this.handleBehaviorChange(b,a)},this.behaviorChangeTracker);a.getEntityList().forChangedMutableEntities((b)=>{for(let c of b)d.Cet.hasPdomComponent(c)&&c.isDef(f.CetModel.ID.Z_TOPIC_CONTAINER)&&
(b=c.getMutableWrapper(f.CetModel.ID.Z_TOPIC_CONTAINER.W).getMutableTopic(),b.getEntity().isDef(f.CetModel.ID.HAS_TOPIC_CHILDREN)&&(b=b.getEntity().getMutableWrapper(f.CetModel.ID.HAS_TOPIC_CHILDREN.W),this.handleBehaviorChange([...b.getMutableTopicChildren()].map((a)=>a.getChild()),a)))},this.smartStructureChangeTracker);a.getEntityList().forChangedMutableEntities((b)=>{b=b.map((a)=>a.getMutableWrapper(f.CetModel.ID.HAS_CHILDREN.W).getEntity().getId());this.handleBehaviorChange(b,a)},this.childrenChangeTracker);
a.getEntityList().forChangedMutableEntities((b)=>{for(let c of b)this.manageOutlineContent(c,a)},this.outlineContent);var b=d.Cet.parseAspectRatio(a.getPreziW().getAspectRatio()).letterBoxing;if(this.prevTopic!==this.currentTopicNavigation.newCurrentTopic||this.prevLetterBoxing!==b){const c=this.createAnimatorForTopicNavigation(a,this.currentTopicNavigation.newCurrentTopic,this.prevLetterBoxing!==b?null:this.prevTopic);null!=c&&c.animate(this.currentTopicNavigation.navigationType===d.NavigationActionAnimationType.Focus)}null!=
this.topicOverlayAnimator&&(!d.Cet.parseAspectRatio(a.getPreziW().getAspectRatio()).letterBoxing||u.isActive("js-unique-differentiation")&&this.currentTopicNavigation.newCurrentTopic===a.getPreziW().getOverview().getId()?this.topicOverlayAnimator.reset(a):this.topicOverlayAnimator.decorate(a,this.currentTopicNavigation.newCurrentTopic,this.prevLetterBoxing!==b?null:this.prevTopic,!this.firstUpdateAfterReset&&!this.firstUpdateAfterStartEditMode));this.prevTopic=this.currentTopicNavigation.newCurrentTopic;
this.prevLetterBoxing=b;this.prevTopic=this.currentTopicNavigation.newCurrentTopic;this.firstUpdateAfterStartEditMode=this.firstUpdateAfterReset=this.dirty=!1}}getName(){return"TopicVisibilitySystem"}changesPdomComponents(){return!1}reset(a){this.dirty=!1;const b=this.createAnimatorForTopicNavigation(a,null,this.currentTopicNavigation.newCurrentTopic);null!=b&&b.animate(!0);this.currentTopicNavigation={newCurrentTopic:this.currentTopicNavigation.newCurrentTopic,navigationType:d.NavigationActionAnimationType.Focus};
this.prevLetterBoxing=this.prevTopic=null;null!=this.topicOverlayAnimator&&this.topicOverlayAnimator.reset(a);this.firstUpdateAfterReset=!0}};var M={};Object.defineProperty(M,"__esModule",{value:!0});M.TriggeringVisibilityAggregatorSystemImpl=class{constructor(a,b,c,e){this.keys=a;this.invisibilityKeys=b;this.processDelegate=c;this.tweener=e}getWorkingKeys(){return this.tweener.getVisibilityKeys().concat(this.keys)}process(a){for(let c of a){var b=this.getWorkingKeys();a=!0;let e=1;for(let d of b)b=
c.get(d),null!=b&&(a=a&&b.isEnabled,e=Math.min(e,b.alpha));for(let d of this.invisibilityKeys)b=c.get(d),null==b&&(b={isEnabled:!1,alpha:0}),a=a&&b.isEnabled,e=Math.min(e,b.alpha);this.processDelegate(c,e,a)}}select(a){return a.hasComponent(r.CetRendererModule.getDrawComponentKey())||a.isDef(f.CetModel.ID.BACKGROUND)}getTriggerKeys(){return[f.CetModel.getNewEntityCompKey()].concat(this.getWorkingKeys()).concat(this.invisibilityKeys)}getName(){return"VisibilityAggregatorSystem"}reset(){}init(a){null==
this.tweener&&(this.tweener=a.getTweener())}changesPdomComponents(){return!1}};var V={};Object.defineProperty(V,"__esModule",{value:!0});V.HidePlaceholderAssetSystem=class{constructor(){this.cleanUp()}getName(){return"HidePlaceholderAssetSystem"}initializeEntities(a,b){for(let a of b)this.hidePlaceholderAsset(a)}update(a){a=a.getPrezi();this.processZObjects(a)}processZObjects(a){let b=a.getComponent(f.CetModel.ID.PREZI.Z_OBJECTS);b.getVersion()!==this.lastZObjectsVersion&&(this.lastZObjectsVersion=
b.getVersion(),a.forEachChild(f.CetModel.ID.PREZI.Z_OBJECTS,(a)=>{this.hidePlaceholderAsset(a)}))}hidePlaceholderAsset(a){const b=a.getDef();u.isActive("js-pdom-upgrade-show-placeholders-in-present-mode")&&b===f.CetModel.ID.Z_IMAGE&&a.set(r.CetRendererModule.getHidePlaceholderAssetKey(),!0)}init(){}cleanUp(){this.lastZObjectsVersion=-1}reset(){this.cleanUp()}changesPdomComponents(){return!1}};var x={};Object.defineProperty(x,"__esModule",{value:!0});x.PlaybackModuleImpl=class{static createDollyGrip(a){return new C.DollyGripImpl(a)}static createInteractionQuery(){return new K.InteractionQueryImpl}static createPlayback(a,
b){a.getMainStage().setScene(b,b);return new L.PlaybackImpl(a.getMainStage(),a.getMainStage().getCamera(),a.getMainStage().getHitTest(),a.getSceneBuilder(),a.getBaseScene(),b,a.getMainStage().getPathNavigator(),a.getSpeedMeter())}static createPlaybackScene(a,b,c,e,f,k,n,q,u){f=a.getMainStage().getRenderer().createChannel(c,!0);var h=e.map((a)=>null==a?null:a.newCurrentTopic);const t=a.getSceneBuilder();var p=t.getSystemFactory();x.PlaybackModuleImpl.componentFactory=a.createComponentFactory();const w=
new S.PathVisibilitySystemImpl,v=new T.PlaybackVisibilitySystemImpl;var y=v.getVisibilityKey();e=l.Bacon.combineWith((a,b)=>null==a||b===m.EditorMode.playback||b===m.EditorMode.view||b===m.EditorMode.follow||b===m.EditorMode.templateChooser||b===m.EditorMode.animationPreview?a:{newCurrentTopic:a.newCurrentTopic,navigationType:d.NavigationActionAnimationType.Focus},e,k).sampledBy(e).toProperty(null);k=new P.TopicVisibilitySystem(!1,e,b.getEntityIdInFocusStream(),k,b,null);y=p.createShaperSystem(new M.TriggeringVisibilityAggregatorSystemImpl([y],
[d.Cet.getPathVisibilityKey()],(a,b,c)=>d.Cet.updateVisibility(a).setAlpha(b).setEnabled(c)));e=p.createShaperSystem(new M.TriggeringVisibilityAggregatorSystemImpl([],[],(a,b,c)=>{d.Cet.updateCommentVisibility(a).setEnabled(c).setAlpha(b)}));const z=F.SelectionModule.createCustomSelectionSystem(l.Bacon.never().toProperty(aa.emptySelectionInfo()),l.Bacon.never(),q,l.Bacon.never().toProperty([]),l.Bacon.never(),h,l.Bacon.never().toProperty(null),l.Bacon.never().toProperty(null),l.Bacon.never().toProperty(null),
l.Bacon.never().toProperty(!1),l.Bacon.never().toProperty(null),l.Bacon.never().toProperty(null),l.Bacon.never().toProperty(null),l.Bacon.never().toProperty(null),b.getCamera(),a.getDomLayerManager(),null,()=>{},b),A=p.createBoundCalculationSystem(),B=p.createWorldGeometrySystem();q=g.CetModelEditor.createHideDegenerateConnectorsFixerSystem(p);const I=new V.HidePlaceholderAssetSystem,C=x.PlaybackModuleImpl.createLogoSystem(n,u,a.getCetUI().getSizeProperty(),b);n=[I,k,C,y,e];u=[A,B,q];h=[I,p.createShaperSystem(x.PlaybackModuleImpl.createStageQuerySystem(b,
l.Bacon.never().toProperty(),h,g.ApplicationMode.View,x.PlaybackModuleImpl.getStageQueryKey())),p.createInitializerSystem(p.createInvisibleFrameSystem(()=>r.CetRendererModule.createZInvisibleFrameDrawComponent())),p.createVideoPlaybackSystem(),z,A,B];k=[q,k,p.createQuadTreeSystem(b.getRenderer().getQuadTreeUpdater())];p=[C,p.createShaperSystem(w),p.createShaperSystem(v),y,e,b.getRenderer().getInvalidator()?p.createRenderingInvalidatorSystem(f,b.getRenderer().getInvalidator()):null].filter((a)=>null!=
a);a=t.createChildScene(c,a.getBaseScene(),{initList:n,inflateList:u,updateList:h,updateOnceList:k,preRenderList:p},!1);b.registerScene(f,a);b.setScene(a,a);return a}static getStageQueryKey(){null==x.PlaybackModuleImpl.stageQueryKey&&(x.PlaybackModuleImpl.stageQueryKey=f.CetModel.createValueComponentKey("playbackStageQuery",!1,!1));return x.PlaybackModuleImpl.stageQueryKey}static getThumbnailVisibilityKey(){null==x.PlaybackModuleImpl.thumbnailVisibilityKey&&(x.PlaybackModuleImpl.thumbnailVisibilityKey=
f.CetModel.createValueComponentKey("thumbnailVisiblity",!1,!1,!0));return x.PlaybackModuleImpl.thumbnailVisibilityKey}static createTopicVisibilitySystem(a,b,c,e,d){d=F.SelectionModule.createTopicOverlayAnimator(e.getCamera(),d);return new P.TopicVisibilitySystem(c,a,e.getEntityIdInFocusStream(),b,e,d)}static createLogoSystem(a,b,c,d){return new w.LogoSystem(a,b,c,d.getRenderer().getAssetManager(),d)}static createStageQuerySystem(a,b,c,d,f){return new U.StageQuerySystem(a,b,c,d,f)}static createVisibilityAggregator(a,
b){return new M.TriggeringVisibilityAggregatorSystemImpl(a,[],b)}static topicClosedFromNavigation(a,b){return{isClosed:a,eventType:b===d.NavigationActionAnimationType.Focus?q.TopicCloseEventType.CAMERA_JUMP:q.TopicCloseEventType.CAMERA_MOVE}}static topicClosedCommand(a,b){return{isClosed:a,eventType:b}}static getPlaybackVisibilityKey(){null==x.PlaybackModuleImpl.playbackVisibilityKey&&(x.PlaybackModuleImpl.playbackVisibilityKey=f.CetModel.createValueComponentKey("playbackVisibility",!1,!1));return x.PlaybackModuleImpl.playbackVisibilityKey}static createVisibilityFilter(a,
b,c,e){const h=new J.PlaybackVisibilityQuery,k=new Set(g.CetModelEditor.createTopicQuery(a).getReachableEntities(b,d.VisualBackgroundReachLevel.ALL_VISUALS_AND_BACKGROUND));b=()=>!0;const l=c?h.createGeneralVisibilityFilter(a):b,m=null!=e?h.createPathVisibilityFilter(e,a):b;return(b)=>{b=b.getId();return k.has(b)&&l(b)&&m(b)&&!a.getEntityById(b).isDef(f.CetModel.ID.Z_ZOOM_AREA)?1:0}}};var W={};Object.defineProperty(W,"__esModule",{value:!0});W.PannerImpl=class{constructor(a,b,c,d,f){this.startPanPos=
a;this.currentTopicId=b;this.camera=c;this.scene=d;this.instantPan=f;this.calcPanningBorders();this.camera.startPanning(a,this.instantPan)}panMove(a){this.panTarget=this.keepInBorder(a,this.hardPanTargetLimits);this.camera.setPanningTargetPosition(this.panTarget);return this.calcPanLimitsReached(this.panTarget,this.hardPanTargetLimits)}panEnd(){var a=u.isActive("js-unique-differentiation")?this.hardPanTargetLimits:this.softPanTargetLimits;a=this.keepInBorder(this.panTarget,a);this.camera.setPanningTargetPosition(a);
this.camera.stopPanning()}calcPanLimitsReached(a,b){return{leftLimitReached:a.x>=b.x_max,rightLimitReached:a.x<=b.x_min,upLimitReached:a.y>=b.y_max,downLimitReached:a.y<=b.y_min}}keepInBorder(a,b){return{x:Math.min(Math.max(a.x,b.x_min),b.x_max),y:Math.min(Math.max(a.y,b.y_min),b.y_max)}}calcPanningBorders(){if(u.isActive("js-unique-differentiation")&&this.currentTopicId===this.scene.getPreziW().getOverview().getId()){var a=this.camera.getInteractionLimits().calcOuterZoomLimits(this.currentTopicId,
this.scene),b=this.camera.getMarginCorrectedViewport().getData();a=D.Geometry.transform2dFromRad(a.softLimitTransform.getTranslation(),a.hardLimitScale,a.softLimitTransform.getRotationRad());a=D.Geometry.obbFromRect(b).transform(a.invert());var c=this.calcSoftBorderWorld();a=this.calcHardBorder(a.union(c));this.softPanTargetLimits=this.hardPanTargetLimits=this.calcPanningTargetBorder(this.startPanPos,b,a)}else{b=this.camera.getMarginCorrectedViewport().getData();c=this.camera.getTransform();const d=
this.calcSoftBorderWorld();a=this.calcHardBorder(d);c=d.transform(c);this.softPanTargetLimits=this.calcPanningTargetBorder(this.startPanPos,b,c);this.hardPanTargetLimits=this.calcPanningTargetBorder(this.startPanPos,b,a)}}calcSoftBorderWorld(){const a=this.scene.getEntityById(this.currentTopicId);return d.Cet.createScreenBoundsCalculator(this.scene,this.camera).getMarginCorrectedViewportForEntity(a)}calcHardBorder(a){const b=this.camera.getTransform(),c=.2*a.getWidth()/2,d=.2*a.getHeight()/2;return a.inflateXY(c,
d).transform(b)}calcPanningTargetBorder(a,b,c){let d=b.x-(c.getCenterX()-c.getWidthHalf());d=Math.max(0,d);let f=c.getCenterX()+c.getWidthHalf()-(b.x+b.width);f=Math.max(0,f);let g=b.y-(c.getCenterY()-c.getHeightHalf());g=Math.max(0,g);b=c.getCenterY()+c.getHeightHalf()-(b.y+b.height);b=Math.max(0,b);return{x_min:a.x-f,x_max:a.x+d,y_min:a.y-b,y_max:a.y+g}}};var q={createPanner:function(a,b,c,d,f){return new W.PannerImpl(a,b,c,d,f)},getWatermarkAssetUrl:function(){return v.getResourceUrl("watermark.png")}};
Object.defineProperty(q,"__esModule",{value:!0});(function(a){a[a.START_NEW_FLY=0]="START_NEW_FLY";a[a.JUMP=1]="JUMP"})(q.FlyMode||(q.FlyMode={}));(function(a){a[a.ZOOM_IN=0]="ZOOM_IN";a[a.ZOOM_OUT=1]="ZOOM_OUT";a[a.HOME=2]="HOME"})(q.ZoomEvent||(q.ZoomEvent={}));(function(a){a[a.INITIALIZE=0]="INITIALIZE";a[a.CAMERA_MOVE=1]="CAMERA_MOVE";a[a.CAMERA_JUMP=2]="CAMERA_JUMP";a[a.MANUAL=3]="MANUAL";a[a.COMPUTED=4]="COMPUTED"})(q.TopicCloseEventType||(q.TopicCloseEventType={}));q.PlaybackModule=x.PlaybackModuleImpl;
return q});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_playback",["require","prezi.engine.dom","prezi.geometry","prezi_app_utils","prezi_bacon","prezi_canvas_listener","prezi_cet","prezi_cet_model","prezi_cet_model_editor","prezi_cet_renderer","prezi_editor_store_mode","prezi_editor_store_object","prezi_externalserviceprovider","prezi_featureswitcher","prezi_logger","prezi_select","prezi_service_data","prezi_textmodel","prezi_uaparser","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_playback.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi.engine.dom"),require("prezi.geometry"),require("prezi_app_utils"),require("prezi_bacon"),require("prezi_canvas_listener"),require("prezi_cet"),require("prezi_cet_model"),require("prezi_cet_model_editor"),require("prezi_cet_renderer"),require("prezi_editor_store_mode"),require("prezi_editor_store_object"),require("prezi_externalserviceprovider"),require("prezi_featureswitcher"),require("prezi_logger"),require("prezi_select"),require("prezi_service_data"),require("prezi_textmodel"),require("prezi_uaparser"),require("prezi_utils"));}else{this["prezi_playback"]=__factory(this["prezi.engine.dom"],this["prezi.geometry"],this["prezi_app_utils"],this["prezi_bacon"],this["prezi_canvas_listener"],this["prezi_cet"],this["prezi_cet_model"],this["prezi_cet_model_editor"],this["prezi_cet_renderer"],this["prezi_editor_store_mode"],this["prezi_editor_store_object"],this["prezi_externalserviceprovider"],this["prezi_featureswitcher"],this["prezi_logger"],this["prezi_select"],this["prezi_service_data"],this["prezi_textmodel"],this["prezi_uaparser"],this["prezi_utils"]);}}).call(this);