;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_service_assetloader";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.engine.dom":dependencies[0],"prezi_bacon":dependencies[1],"prezi_externalserviceprovider":dependencies[2],"prezi_logger":dependencies[3],"prezi_service_fontcatalogue":dependencies[4],"prezi_textmodel":dependencies[5]}};})());};})(arguments);var moduleImpl=(function(){return module(function(d){function w(a,b,c=null){for(;a.hasNext();)c=b(c,a.next(),0);return c}function r(a,b){w(a,(a,e,d)=>b(e,d))}var t=d.dependencies["prezi.engine.dom"],u=d.dependencies.prezi_externalserviceprovider,n=d.dependencies.prezi_logger,v=d.dependencies.prezi_service_fontcatalogue,x=d.dependencies.prezi_textmodel,g=d.dependencies.prezi_bacon;d={};Object.defineProperty(d,"__esModule",{value:!0});d.u=class{constructor(){}J(){return"noop"}w(){return{}}fetch(){const a=this.J(),b=this.w();if(!b[a]){let c=
g.Bacon.newBus();this.K(c);c.onEnd(()=>b[a]=null);b[a]=c}return b[a]}};var l={};Object.defineProperty(l,"__esModule",{value:!0});l.L=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b}K(a){this.assetLoaderProvider.loadBinaryAsset(this.uri,(b)=>{a.push(b);a.end()},(b)=>{a.error({message:"Error loading binary asset: "+this.uri,data:b});a.end()})}J(){return this.uri}w(){return l.L.m}};l.L.m={};var k={};Object.defineProperty(k,"__esModule",{value:!0});(function(a){a.aa=
"font_loading_failed";a.N="json_parse_error"})(k.v||(k.v={}));var p={};Object.defineProperty(p,"__esModule",{value:!0});var f;(function(a){a[a.INSTALLED=0]="INSTALLED";a[a.FAILED=1]="FAILED"})(f||(f={}));p.ba=class extends d.u{constructor(a,b,c,e){super(e);this.document=a;this.ea=b;this.assetLoaderProvider=c;this.logger=n.LoggerModule.getLoggerManager().createLogger("FontFetcher")}K(a){const b=[],c={};r(this.document.getDocumentStyle().getFontFamilies().iterator(),(a)=>{r(a.getFontFaces().iterator(),
(e)=>{const d=this.getFontFaceId(a,e),g=d.getId();if(!c[g]){e=e.getFontSrcWithOrigin();var f=e.getOrigin();if(f===t.DOM.ENUMS().FONT_ORIGIN().BRAND_KIT())f=v.FontOrigin.brandKit;else if(f===t.DOM.ENUMS().FONT_ORIGIN().PREZI())f=v.FontOrigin.prezi;else throw Error("Invalid font origin");e={origin:f,source:e.getSource()};b.push(this.ga(d,this.assetLoaderProvider.getFontUrl(e),e.source));c[g]=!0}})});const e=g.Bacon.mergeAll(b);a.plug(e);e.onEnd(()=>a.end())}getFontFaceId(a,b){a=a.getName();const c=
b.getFontWeight();b=b.getFontStyle();return null!=a&&null!=c&&null!=b?x.TextModel.getFontFaceId(a,c,b):null}ga(a,b,c){const e=g.Bacon.newBus();this.ea.fontFromUrl(a,b,c).then(()=>{e.push({fontFaceId:a})},(b)=>{const c=b.error;let d;try{d={type:u.AssetLoadErrorType.AssetProcessingError,errorMessage:c};const a=c.match(/[^{]*([{][^}]*[}])(.*)/);if(null!=a)try{d=JSON.parse(a[1]),d.errorMessage+=a[2]}catch(B){}}catch(A){d={type:u.AssetLoadErrorType.AssetProcessingError,errorMessage:""}}e.push({fontFaceId:a,
error:d});this.logger.error({action:k.v.aa,object:"font_fetcher",trigger:"machine",payload:{error:b}})});return e.take(1)}};var h={};Object.defineProperty(h,"__esModule",{value:!0});h.j=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b;this.logger=n.LoggerModule.getLoggerManager().createLogger("ImageFetcher")}K(a){this.assetLoaderProvider.loadImageAsset(this.uri,(b)=>{0===b.width||0===b.height?(a.error({message:"image_with_0_size_was_downloaded"}),this.logger.error({action:"image_with_0_size_was_downloaded",
object:"image_fetcher",trigger:"machine",payload:{image_uri:this.uri}})):a.push(b);a.end()},()=>{a.error({message:"image_download_error"});this.logger.error({action:"image_download_error",object:"image_fetcher",trigger:"machine",payload:{image_uri:this.uri}});a.end()})}J(){return this.uri}w(){return h.j.m}};h.j.m={};var m={};Object.defineProperty(m,"__esModule",{value:!0});m.M=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b;this.logger=n.LoggerModule.getLoggerManager().createLogger("JSONFetcher")}K(a){this.assetLoaderProvider.loadRemoteResource(this.uri,
(b)=>{try{a.push(JSON.parse(b))}catch(c){b=k.v.N+this.uri+" "+c,this.logger.error({action:k.v.N,object:"json_fetcher",trigger:"machine",payload:{json_url:this.uri,error:c.toString()}}),a.error({message:b})}a.end()},()=>{const b=`Failed to load remote resource: ${this.uri}`;this.logger.error({action:"failed_to_load_resource",object:"json_fetcher",trigger:"machine",payload:{json_url:this.uri}});a.error({message:b});a.end()})}J(){return this.uri}w(){return m.M.m}};m.M.m={};var q={};Object.defineProperty(q,
"__esModule",{value:!0});class y{constructor(a,b,c,d){this.uri=a;this.id=b;this.assetLoaderProvider=c;this.f=d;this.O=g.Bacon.newBus()}getId(){return this.id}ha(){const a=(new h.j(this.uri,this.assetLoaderProvider,this.f)).fetch().take(1);this.O.plug(a);return a}}class z{constructor(a){this.ja=a;this.enabled=!0;this.o=[]}U(a){if(0===a.length)return g.Bacon.once(null);a=a.map((a)=>a.ha().mapEnd((a)=>a));return g.Bacon.combineWithA((...a)=>a,a).take(1)}da(){this.ia();const a=this.ja.getUrgentIds(),
b=this.o.filter((b)=>0<=a.indexOf(b.getId())),c=this.o.filter((b)=>0>a.indexOf(b.getId()));this.o=[];this.U(b).onValue(()=>this.U(c))}ca(a){this.o.push(a)}ia(){this.enabled=!1}isEnabled(){return this.enabled}fa(a){return this.o.filter((b)=>b.uri===a)}}q.W=class{constructor(a){this.assetLoaderProvider=a;this.f=g.Bacon.newBus()}setUrgentIdLister(a){this.i=new z(a)}downloadInitialBatch(){null!=this.i&&this.i.da()}createBinaryFetcher(a){return new l.L(a,this.assetLoaderProvider,this.f)}createJSONFetcher(a){return new m.M(a,
this.assetLoaderProvider,this.f)}createImageFetcher(a){return new h.j(a,this.assetLoaderProvider,this.f)}addImageDownloadTask(a,b){if(null!=this.i&&this.i.isEnabled()){const c=this.i.fa(a);0===c.length?(a=new y(a,b,this.assetLoaderProvider,this.f),this.i.ca(a)):a=c[0];return a.O}return(new h.j(a,this.assetLoaderProvider,this.f)).fetch()}createFontSetFetcher(a,b){return new p.ba(a,b,this.assetLoaderProvider,this.f)}getUrlRewriter(){return this.assetLoaderProvider}getAssetFetchingErrorObservable(){return this.f}};
f={};Object.defineProperty(f,"__esModule",{value:!0});(function(a){a.createAssetManager=function(a){return new q.W(a)}})(f.AssetLoader||(f.AssetLoader={}));return f});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_service_assetloader",["require","prezi.engine.dom","prezi_bacon","prezi_externalserviceprovider","prezi_logger","prezi_service_fontcatalogue","prezi_textmodel"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_service_assetloader.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi.engine.dom"),require("prezi_bacon"),require("prezi_externalserviceprovider"),require("prezi_logger"),require("prezi_service_fontcatalogue"),require("prezi_textmodel"));}else{this["prezi_service_assetloader"]=__factory(this["prezi.engine.dom"],this["prezi_bacon"],this["prezi_externalserviceprovider"],this["prezi_logger"],this["prezi_service_fontcatalogue"],this["prezi_textmodel"]);}}).call(this);