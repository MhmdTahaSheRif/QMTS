;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_narrative_editor";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi_cet_model_editor":dependencies[0],"prezi_featureswitcher":dependencies[1],"prezi_i18n":dependencies[2],"prezi_logger":dependencies[3],"prezi_plugin_api":dependencies[4],"prezi_plugin_meta":dependencies[5],"prezi_thumbnail_render":dependencies[6],"prezi_utils":dependencies[7]}};})());};})(arguments);var moduleImpl=(function(){return module(function(d){var e=d.dependencies.prezi_plugin_api,k=d.dependencies.prezi_i18n,g=d.dependencies.prezi_logger,q=d.dependencies.prezi_featureswitcher,m=d.dependencies.prezi_plugin_meta,r=d.dependencies.prezi_cet_model_editor,t=d.dependencies.prezi_utils,n=d.dependencies.prezi_thumbnail_render,f={};Object.defineProperty(f,"__esModule",{value:!0});var l=r.base.ObjectKind,h;(function(a){a.sidebar="sidebar";a.paywall="paywall"})(h||(h={}));const p=n.ThumbnailSize._224;f.i=class{init(a){this.f=a.declareUI({narrative:null,
pathElementId:null,w:null,ea:null,sidebarOpened:!1,aa:!1,ba:!1,ca:!1,da:null},(b,c)=>{this.createSidebar(c,b);this.ha(c);q.isActive("js-move-fade-narration")&&c.createMenuItem({kind:e.MenuItemKind.context,id:"narrative-move-fade-narration",onClick:(b)=>this.session.document.executeApiCommand(b,{name:"move-fade-narration",run:(b)=>this.ia(b)}),weight:1E3,title:"[DEBUG] Move narration of fade elements"})});a.onDocumentChange(()=>{const b=this.f.getState().pathElementId;null!=b&&this.ga(b)});a.onLicenseChange((b)=>
{this.f.setState({ca:b.featureSet.presenterView})});a.onNavigation((b)=>{this.session.document.read((c)=>{c=c.lookup.resolve(b.pathElementRef);return null==c||this.u(c)})||(this.f.setState({da:b.pathElementRef}),this.f.getState().sidebarOpened&&this.fa(b.pathElementRef.id))});n.ThumbnailRenderModule.getThumbnailService().then((b)=>this.$=b)}createSidebar(a,b){a.createSidebar(f.i.v,(c)=>({root:{title:k.I18n.ts("Presenter Notes"),content:[c.simpleList((c)=>{var a;return{itemType:e.ListItemType.full,
itemLayout:e.ListItemLayout.dynamic,showTitle:!0,items:[c.image({id:"narrative-thumbnail",src:{url:null!==(a=b.w)&&void 0!==a?a:""},title:b.ea})]}}),c.textarea({id:"narrative-text-area",placeholderText:k.I18n.ts("Click to add presenter notes"),value:b.narrative,onValueChange:(a,c)=>{this.updateNarrative(a,b.pathElementId,c)},rows:20,flexibleHeight:!0}),c.button(e.ButtonSize.Small,e.ButtonAlign.Center,(a)=>[a.button({id:"narration-navigate-back",color:e.ButtonColor.Ghost,content:{icon:e.IconSmallId.ArrowLineLeft},
disabled:!b.ba,onClick:(a)=>{const c=this.session.document.read((a)=>a.structuredPath.viewPathElementsInOrder.findIndex((a)=>a.id===b.pathElementId));this.pluginAccess.send(m.navigation,{kind:"navigateBackwards",uat:a,body:null});g.avro.Avro.createDefaultLogger().logNavigateInPresenterNotesSidebar({step_index:c,navigation_action:"CLICK_PREVIOUS"})}}),a.button({id:"narration-navigate-next",color:e.ButtonColor.Blue,content:{text:k.I18n.ts("Next")},disabled:!b.aa,onClick:(a)=>{const c=this.session.document.read((a)=>
a.structuredPath.viewPathElementsInOrder.findIndex((a)=>a.id===b.pathElementId));this.pluginAccess.send(m.navigation,{kind:"navigateForward",uat:a,body:null});g.avro.Avro.createDefaultLogger().logNavigateInPresenterNotesSidebar({step_index:c,navigation_action:"CLICK_NEXT"})}})])]},onClose:()=>{this.f.setState({narrative:null,pathElementId:null,sidebarOpened:!1});null!=this.o&&(this.o.cancel(),this.o=null)},onCloseButtonClicked:()=>{g.avro.Avro.createDefaultLogger().logClosePresenterNotes()}}))}ha(a){a.createTopMenuItem(e.TopMenuId.Other,
{id:"topmenu-item-presenter-notes",kind:e.MenuItemKind.largeButton,enabled:!0,weight:3,title:k.I18n.ts("Presenter notes"),icon:e.IconSmallId.PresenterNotes,onClick:()=>{const a=this.f.getState();a.sidebarOpened?this.closeSidebar():this.openSidebar(a.da.id)}})}updateNarrative(a,b,c){const d=this.f.getState().narrative;this.f.setState({narrative:c});null!=this.j?this.j(c):a.doAsync(new Promise((a)=>{let b;this.j=(c)=>{null!=b&&clearTimeout(b);b=setTimeout(()=>a(c),1E3)};this.j(c)}),(a,c)=>{this.j=null;
let e=!1;a.isValid()&&(e=this.session.document.executeApiCommand(a,{name:"update narrative",run:(a)=>{const e=a.lookup.pathElement(b);if(null==e)return!1;e.narrative=c;a=a.structuredPath.viewPathElementsInOrder.findIndex((a)=>a.id===b);0<=a&&(null!=d&&""!==d||null==c||""===c?c!==d&&g.avro.Avro.createDefaultLogger().logModifiedPresenterNote({step_index:a}):g.avro.Avro.createDefaultLogger().logInsertPresenterNotes({step_index:a}));return!0}}));e||this.f.sidebar.close(f.i.v)})}processMessage(a){switch(a.kind){case "openSidebar":const b=
a.body;this.openSidebar(b)===h.sidebar&&this.session.document.read((c)=>{c=c.lookup.pathElement(b);a.mat.isValid()&&this.session.navigation.goToPathElement(a.mat,c)});break;default:t.Utils.assertNever(a.kind)}}ja(a){null!=this.$&&(null!=this.o&&this.o.cancel(),this.o=this.$.monitorPath({size:p,needHighQuality:!0,includePathElement:(b)=>b.id===a}),this.o.getThumbnailStream().onValue((a)=>{this.f.setState({w:a.canvas.toDataURL()})}))}openSidebar(a){if(this.f.getState().ca)return this.j=null,this.fa(a),
this.f.sidebar.open(f.i.v),this.f.setState({sidebarOpened:!0}),this.session.document.read((b)=>{b=b.structuredPath.viewPathElementsInOrder.findIndex((c)=>c.id===a);0<=b&&g.avro.Avro.createDefaultLogger().logOpenPresenterNotes({step_index:b})}),h.sidebar;this.f.dialog.showBuiltIn(e.BuiltinDialog.upgradeLicensePresenterView);return h.ka}fa(a){this.ga(a);this.ja(a)}closeSidebar(){this.f.sidebar.close(f.i.v);this.f.setState({sidebarOpened:!1});g.avro.Avro.createDefaultLogger().logClosePresenterNotes()}ga(a){const b=
this.session.document.read((c)=>{var b,e,d=c.lookup.pathElement(a);c=c.structuredPath.viewPathElementsInOrder;if(null==d)return null;const f=d.is(l.visitStack)?d.children[0]:d;if(null==c.find((a)=>a.id===f.id))return null;const g=c.findIndex((a)=>!this.u(a));let h=c.length-1;for(;this.u(c[h]);)--h;d=null===(b=this.$)||void 0===b?void 0:b.getCachedCanvasForPathElement(d,p);b=this.f.getState();return{pathElementId:f.id,narrative:b.pathElementId===f.id&&null!=this.j?b.narrative:f.narrative,ea:f.title,
ba:c[g].id!==a,aa:c[h].id!==a,w:null===(e=null===d||void 0===d?void 0:d.canvas)||void 0===e?void 0:e.toDataURL("image/png")}});null!=b?this.f.setState(Object.assign({},b)):this.closeSidebar()}u(a){return a.is(l.fadeIn)||a.is(l.fadeOut)}ia(a){let b=0;a.structuredPath.pathElementsInOrder.forEach((a,d,e)=>{this.u(a)?null!=a.narrative&&""!==a.narrative&&(e[b].narrative+="\n ------\n"+a.narrative,a.narrative=""):b=d})}};f.i.v="narrative-sidebar";d={};Object.defineProperty(d,"__esModule",{value:!0});d.lazyModule=
{createPlugin(){return new f.i}};return d});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_narrative_editor",["require","prezi_cet_model_editor","prezi_featureswitcher","prezi_i18n","prezi_logger","prezi_plugin_api","prezi_plugin_meta","prezi_thumbnail_render","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_narrative_editor.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi_cet_model_editor"),require("prezi_featureswitcher"),require("prezi_i18n"),require("prezi_logger"),require("prezi_plugin_api"),require("prezi_plugin_meta"),require("prezi_thumbnail_render"),require("prezi_utils"));}else{this["prezi_narrative_editor"]=__factory(this["prezi_cet_model_editor"],this["prezi_featureswitcher"],this["prezi_i18n"],this["prezi_logger"],this["prezi_plugin_api"],this["prezi_plugin_meta"],this["prezi_thumbnail_render"],this["prezi_utils"]);}}).call(this);