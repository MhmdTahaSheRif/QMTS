;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "14.0-9-g58006c6";},getModuleName:function(){return "prezi_path_audio";},getModuleVersion:function(){return "release-2023w26-base-4-g4a3c2ed4bcb";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi_cet":dependencies[0],"prezi_cet_model":dependencies[1],"prezi_cet_model_editor":dependencies[2],"prezi_featureswitcher":dependencies[3],"prezi_i18n":dependencies[4],"prezi_logger":dependencies[5],"prezi_plugin_api":dependencies[6],"prezi_plugin_meta":dependencies[7],"prezi_sound_playback":dependencies[8],"prezi_utils":dependencies[9]}};})());};})(arguments);var moduleImpl=(function(){return module(function(g){var d=g.dependencies.prezi_plugin_api,f=g.dependencies.prezi_i18n,k=g.dependencies.prezi_cet_model_editor,q=g.dependencies.prezi_utils,p=g.dependencies.prezi_logger,r=g.dependencies.prezi_featureswitcher,m={},l=this&&m.__awaiter||function(a,c,e,b){function t(a){return a instanceof e?a:new e(function(b){b(a)})}return new (e||(e=Promise))(function(e,d){function f(a){try{g(b.next(a))}catch(n){d(n)}}function u(a){try{g(b["throw"](a))}catch(n){d(n)}}function g(a){a.done?e(a.value):t(a.value).then(f,
u)}g((b=b.apply(a,c||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});var h=k.base.ObjectKind;const v={isSidebarOpen:!1,currentPosition:null,backgroundAudio:null,behindPaywall:!0,bgAudioUploadInProgress:!1,stepAudioUploadInProgress:!1};m.PathAudioPlugin=class{init(a){this.logger=p.LoggerModule.getLoggerManager().createLogger("PathAudioPlugin");this.uiRoot=a.declareUI(v,(a,e)=>{e.createSidebar("sidebar-path-audio",(b)=>{const c=a.behindPaywall||r.isActive("js-path-audio-force-paywall");
b=[...this.createPaywall(b,c),...this.createBackgroundAudio(a,b,c),...this.createStepAudio(a,b,c)];return{root:{title:f.I18n.ts("Path Audio"),content:b,footer:null},onOpen:()=>{this.uiRoot.setState({isSidebarOpen:!0})},onClose:()=>{this.uiRoot.setState({isSidebarOpen:!1})}}});e.createTopMenuItem(d.TopMenuId.Media,{id:"topmenu-insert-item-audio",title:f.I18n.ts("Audio"),kind:d.MenuItemKind.largeButton,enabled:!0,onClick:()=>l(this,void 0,void 0,function*(){p.avro.Avro.createDefaultLogger().logClickTabMenuItem({tab_menu_item:"AUDIO"});
const b=!a.isSidebarOpen;this.uiRoot.sidebar.toggle("sidebar-path-audio");b&&(yield this.session.document.read((a)=>this.updateState(a)))}),icon:d.IconSmallId.Audio,weight:6,categoryWeight:0})});a.onLicenseChange((a)=>{this.uiRoot.setState({behindPaywall:!a.featureSet.pitchAudio})});a.onCurrentTopicChange(()=>{this.session.document.read((a)=>{const c=this.session.insertTarget.getSimpleObjectParentReader(a);if(null!=c){var b=null;if(c.is(k.base.ObjectKind.overview))b=a.structuredPath.editorPath;else for(let e of a.structuredPath.pathElementsInOrder)if((e.is(k.base.ObjectKind.visitPlanet)||
e.is(k.base.ObjectKind.visitPage))&&e.target.id===c.id){b=e;break}this.updateState(a,b)}})});a.onDocumentChange(()=>{null!=this.uiRoot.getState().currentPosition&&this.session.document.read((a)=>{this.updateState(a)})})}createPaywall(a,c){return c?[a.sectionHeader({content:f.I18n.ts("Ready to unlock more features?")}),a.label(f.I18n.ts("Get access to audio upload and much more by upgrading your Prezi license.")),a.button(d.ButtonSize.Small,d.ButtonAlign.Start,(a)=>[a.button({id:"audio-upgrade-license",
color:d.ButtonColor.Blue,content:{text:f.I18n.ts("Upgrade now")},onClick:()=>{this.uiRoot.dialog.showBuiltIn(d.BuiltinDialog.upgradeLicenseInsertAudio)}})]),a.separator()]:[]}createBackgroundAudio(a,c,e){if(null!=a.currentPosition&&a.currentPosition.ref.kind===h.visitOverview){let b=[c.sectionHeader({content:f.I18n.ts("Background Audio")}),c.label(f.I18n.ts("Play through entire presentation"))];a.bgAudioUploadInProgress?b.push(c.spinner(d.SpinnerColor.blue,d.SpinnerSize.m)):null!=a.backgroundAudio?
(b.push(c.audio({id:"background-audio",audioBuffer:a.backgroundAudio})),b.push(c.button(d.ButtonSize.Small,d.ButtonAlign.Start,(b)=>[b.upload({color:d.ButtonColor.Gray,id:"replace-background-audio",content:{icon:d.IconSmallId.Replay,text:f.I18n.ts("Replace")},fileFilter:{allowAudio:!0},onFileSelected:(a,{file:b})=>{this.uploadBackgroundAudio(a,b)}}),b.button({id:"delete-background-audio",color:d.ButtonColor.Gray,content:{icon:d.IconSmallId.Trash},onClick:this.deleteAudio(a.currentPosition,!0)})]))):
b.push(c.button(d.ButtonSize.Large,d.ButtonAlign.Start,(a)=>[a.upload({color:d.ButtonColor.Blue,id:"upload-background-audio",content:{text:f.I18n.ts("Upload")},disabled:e,fileFilter:{allowAudio:!0},onFileSelected:(a,{file:b})=>{this.uploadBackgroundAudio(a,b)}})]));b.push(c.separator());return b}return[]}createStepAudio(a,c,e){if(null!=a.currentPosition){let b=[c.sectionHeader({content:null==a.currentPosition.title?f.I18n.ts("Step Audio"):f.I18n.tsFormatKeys("Step Audio - {pathStepName}",{pathStepName:a.currentPosition.title})}),
c.label(f.I18n.ts("Play only when viewing this step"))];a.stepAudioUploadInProgress?b.push(c.spinner(d.SpinnerColor.blue,d.SpinnerSize.m)):null!=a.currentPosition.audio?(b.push(c.audio({id:"step-audio",audioBuffer:a.currentPosition.audio})),b.push(c.button(d.ButtonSize.Small,d.ButtonAlign.Start,(b)=>[b.upload({color:d.ButtonColor.Gray,id:"replace-step-audio",content:{icon:d.IconSmallId.Replay,text:f.I18n.ts("Replace")},fileFilter:{allowAudio:!0},onFileSelected:(b,{file:c})=>{this.uploadStepAudio(b,
c,a.currentPosition)}}),b.button({id:"delete-step-audio",color:d.ButtonColor.Gray,content:{icon:d.IconSmallId.Trash},onClick:this.deleteAudio(a.currentPosition,!1)})]))):b.push(c.button(d.ButtonSize.Large,d.ButtonAlign.Start,(b)=>[b.upload({color:d.ButtonColor.Blue,id:"upload-step-audio",content:{text:f.I18n.ts("Upload")},disabled:e,fileFilter:{allowAudio:!0},onFileSelected:(b,{file:c})=>{this.uploadStepAudio(b,c,a.currentPosition)}})]));b.push(c.separator());return b}return[]}updateState(a,c){return l(this,
void 0,void 0,function*(){var e=this.uiRoot.getState();var b=null==c&&null!=e.currentPosition?a.lookup.resolve(this.uiRoot.getState().currentPosition.ref):c;if(null!=b){let c=this.calculateTitle(b);var d=b.kind===h.visitOverview?a.structuredPath.backgroundAudio:null;e=b.ref;b=yield this.getBufferFromAudioAsset(b.audio);d=yield this.getBufferFromAudioAsset(d);this.uiRoot.setState({currentPosition:{ref:e,audio:b,title:c},backgroundAudio:d})}})}calculateTitle(a){if(a.is(h.zoom))return f.I18n.ts("Zoom area");
a=a.is(h.backToParent)?a.backTo.target:a.target;return a.is(h.overview)?f.I18n.ts("Overview"):k.CetModelEditor.calculatePageOrTopicTitle(a)}getBufferFromAudioAsset(a){return l(this,void 0,void 0,function*(){if(null!=a)try{return yield this.session.document.progressiveAssetManager.downloadAudioAsset(a)}catch(c){return null}else return null})}deleteAudio(a,c){return(e)=>{this.session.document.executeApiCommand(e,{name:"delete-audio",run:(b)=>{if(c)b.structuredPath.backgroundAudio=null;else{const c=
b.lookup.resolve(a.ref);null!=c&&(c.audio=null)}this.updateState(b)}})}}uploadStepAudio(a,c,e){this.uiRoot.setState({stepAudioUploadInProgress:!0});this.uploadAudio(a,c,(a,c)=>l(this,void 0,void 0,function*(){const b=a.lookup.resolve(e.ref);null!=b&&(b.audio=c);yield this.updateState(a);this.uiRoot.setState({stepAudioUploadInProgress:!1})}))}uploadBackgroundAudio(a,c){this.uiRoot.setState({bgAudioUploadInProgress:!0});this.uploadAudio(a,c,(a,b)=>l(this,void 0,void 0,function*(){a.structuredPath.backgroundAudio=
b;yield this.updateState(a);this.uiRoot.setState({bgAudioUploadInProgress:!1})}))}uploadAudio(a,c,d){a.doAsync(this.session.document.progressiveAssetManager.uploadAudio(c).finished,(a,c)=>{a.isValid()&&this.session.document.executeApiCommand(a,{name:"upload-path-audio",run:(a)=>d(a,c)})})}processMessage(a){switch(a.kind){case "openSidebarFromLeftSidebar":this.session.document.read((c)=>{const d=c.lookup.pathElement(a.pathElementId);d.is(h.zoom)||d.is(h.visitOverview)||d.is(h.visitPage)||d.is(h.visitPlanet)||
d.is(h.backToParent)?this.updateState(c,d).then(()=>{this.uiRoot.getState().isSidebarOpen||this.uiRoot.sidebar.open("sidebar-path-audio")}):this.logger.error({action:"path audio message processing",object:"PathAudioPlugin",trigger:"machine",payload:{error:`Invalid object kind ${d.kind}`}})});break;default:q.Utils.assertNever(a.kind,"Unknown PathAudioMessageKind: "+a.kind)}}};g={};Object.defineProperty(g,"__esModule",{value:!0});g.lazyModule={createPlugin(){return new m.PathAudioPlugin}};return g});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_path_audio",["require","prezi_cet","prezi_cet_model","prezi_cet_model_editor","prezi_featureswitcher","prezi_i18n","prezi_logger","prezi_plugin_api","prezi_plugin_meta","prezi_sound_playback","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_path_audio.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi_cet"),require("prezi_cet_model"),require("prezi_cet_model_editor"),require("prezi_featureswitcher"),require("prezi_i18n"),require("prezi_logger"),require("prezi_plugin_api"),require("prezi_plugin_meta"),require("prezi_sound_playback"),require("prezi_utils"));}else{this["prezi_path_audio"]=__factory(this["prezi_cet"],this["prezi_cet_model"],this["prezi_cet_model_editor"],this["prezi_featureswitcher"],this["prezi_i18n"],this["prezi_logger"],this["prezi_plugin_api"],this["prezi_plugin_meta"],this["prezi_sound_playback"],this["prezi_utils"]);}}).call(this);